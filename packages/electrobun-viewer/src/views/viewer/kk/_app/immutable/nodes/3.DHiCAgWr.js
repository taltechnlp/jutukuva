import{f as gt,a as ct,c as zc}from"../chunks/DXqbN_nR.js";import{c as nr,b as Uc,d as Ms,h as Rt,g as Vc,R as Pc,x as b,a0 as Bc,T as Wc,U as Jc,V as Ci,s as Ns,e as Pn,C as Hc,aL as qc,ax as Kc,f as Yc,j as sr,k as $c,u as jc,ap as _i,aJ as No,aT as Gc,aU as Xc,r as Ro,p as Zc,aV as Qc,aW as ta,aX as Rs,a as ea,aY as na,aZ as sa,aI as ra,i as ia,W as oa,E as la,I as Mr,M as qt,O as Nr,J as v,K as D,Q as E,P as bt,z,aP as we,ay as xi,an as ca,a_ as aa,a1 as Ei,ai as Ls,D as ha,aO as ua,a$ as fa,b0 as da,aQ as pa}from"../chunks/X4p5KNSN.js";import{s as Ht,d as Rr}from"../chunks/CFrJvVLm.js";import{p as rn,i as Se,b as ga}from"../chunks/TAExXh3U.js";import{h as ma}from"../chunks/Dn3bg4tI.js";import{s as ht,r as nn,a as sn}from"../chunks/xnQa7WWo.js";import{s as ya,a as ba}from"../chunks/DEGQKNOc.js";import{s as wa}from"../chunks/BzDh8ddf.js";function Sa(n,t,e){for(var s=[],r=t.length,i=0;i<r;i++)na(t[i].e,s,!0);sa(s,()=>{var o=s.length===0&&e!==null;if(o){var l=e,c=l.parentNode;ra(c),c.append(l),n.items.clear(),Nt(n,t[0].prev,t[r-1].next)}for(var a=0;a<r;a++){var h=t[a];o||(n.items.delete(h.k),Nt(n,h.prev,h.next)),ia(h.e,!o)}n.first===t[0]&&(n.first=t[0].prev)})}function Di(n,t,e,s,r,i=null){var o=n,l={items:new Map,first:null};{var c=n;o=Rt?Ms(Vc(c)):c.appendChild(nr())}Rt&&Pc();var a=null,h=Bc(()=>{var g=e();return Gc(g)?g:g==null?[]:No(g)}),u,f=!0;function d(){ka(p,u,l,o,t,s),a!==null&&(u.length===0?(a.fragment?(o.before(a.fragment),a.fragment=null):Ro(a.effect),p.first=a.effect):Zc(a.effect,()=>{a=null}))}var p=Uc(()=>{u=b(h);var g=u.length;let m=!1;if(Rt){var y=Wc(o)===Jc;y!==(g===0)&&(o=Ci(),Ms(o),Ns(!1),m=!0)}for(var I=new Set,C=Yc,J=null,ot=$c(),j=0;j<g;j+=1){Rt&&Pn.nodeType===Hc&&Pn.data===qc&&(o=Pn,m=!0,Ns(!1));var tt=u[j],mt=s(tt,j),G=f?null:l.items.get(mt);G?(Kc(G.v,tt),G.i=j,ot&&C.skipped_effects.delete(G.e)):(G=Ca(f?o:null,J,tt,mt,j,r,t,e),f&&(G.o=!0,J===null?l.first=G:J.next=G,J=G),l.items.set(mt,G)),I.add(mt)}if(g===0&&i&&!a)if(f)a={fragment:null,effect:sr(()=>i(o))};else{var Vt=document.createDocumentFragment(),Pt=nr();Vt.append(Pt),a={fragment:Vt,effect:sr(()=>i(Pt))}}if(Rt&&g>0&&Ms(Ci()),!f)if(ot){for(const[Bt,Me]of l.items)I.has(Bt)||C.skipped_effects.add(Me.e);C.oncommit(d),C.ondiscard(()=>{})}else d();m&&Ns(!0),b(h)});f=!1,Rt&&(o=Pn)}function ka(n,t,e,s,r,i){var o=t.length,l=e.items,c=e.first,a,h=null,u=[],f=[],d,p,g,m;for(m=0;m<o;m+=1){if(d=t[m],p=i(d,m),g=l.get(p),e.first??=g,!g.o){g.o=!0;var y=h?h.next:c;Nt(e,h,g),Nt(e,g,y),Fs(g,y,s),h=g,u=[],f=[],c=h.next;continue}if((g.e.f&Rs)!==0&&Ro(g.e),g!==c){if(a!==void 0&&a.has(g)){if(u.length<f.length){var I=f[0],C;h=I.prev;var J=u[0],ot=u[u.length-1];for(C=0;C<u.length;C+=1)Fs(u[C],I,s);for(C=0;C<f.length;C+=1)a.delete(f[C]);Nt(e,J.prev,ot.next),Nt(e,h,J),Nt(e,ot,I),c=I,h=ot,m-=1,u=[],f=[]}else a.delete(g),Fs(g,c,s),Nt(e,g.prev,g.next),Nt(e,g,h===null?e.first:h.next),Nt(e,h,g),h=g;continue}for(u=[],f=[];c!==null&&c.k!==p;)(c.e.f&Rs)===0&&(a??=new Set).add(c),f.push(c),c=c.next;if(c===null)continue;g=c}u.push(g),h=g,c=g.next}if(c!==null||a!==void 0){for(var j=a===void 0?[]:No(a);c!==null;)(c.e.f&Rs)===0&&j.push(c),c=c.next;var tt=j.length;if(tt>0){var mt=o===0?s:null;Sa(e,j,mt)}}n.first=e.first&&e.first.e,n.last=h&&h.e,h&&(h.e.next=null)}function Ca(n,t,e,s,r,i,o,l){var c=(o&Qc)!==0,a=(o&ta)===0,h=c?a?jc(e,!1,!1):_i(e):e,u=(o&Xc)===0?r:_i(r),f={i:u,v:h,k:s,a:null,e:null,o:!1,prev:t,next:null};try{if(n===null){var d=document.createDocumentFragment();d.append(n=nr())}return f.e=sr(()=>i(n,h,u,l)),f.e.prev=t&&t.e,t!==null&&(t.next=f,t.e.next=f.e),f}finally{}}function Fs(n,t,e){for(var s=n.next?n.next.e.nodes_start:e,r=t?t.e.nodes_start:e,i=n.e.nodes_start;i!==null&&i!==s;){var o=ea(i);r.before(i),i=o}}function Nt(n,t,e){t===null?n.first=e:(t.next=e,t.e.next=e&&e.e),e!==null&&(e.prev=t,e.e.prev=t&&t.e)}function _a(n,t,e){oa(()=>{var s=la(()=>t(n,e?.())||{});if(s?.destroy)return()=>s.destroy()})}function xa(n,t,e){var s=n==null?"":""+n;return s===""?null:s}function Ea(n,t){return n==null?null:String(n)}function pe(n,t,e,s,r,i){var o=n.__className;if(Rt||o!==e||o===void 0){var l=xa(e);(!Rt||l!==n.getAttribute("class"))&&(l==null?n.removeAttribute("class"):n.className=l),n.__className=e}return i}function ke(n,t,e,s){var r=n.__style;if(Rt||r!==t){var i=Ea(t);(!Rt||i!==n.getAttribute("style"))&&(i==null?n.removeAttribute("style"):n.style.cssText=i),n.__style=t}return s}const Da=()=>{const n=wa;return{page:{subscribe:n.page.subscribe},navigating:{subscribe:n.navigating.subscribe},updated:n.updated}},Ta={subscribe(n){return Da().page.subscribe(n)}};var Aa=gt('<span class="subtitle-meta" aria-live="off"> </span>'),va=gt('<span class="subtitle-meta" aria-live="off">Ready for real-time subtitles</span>'),Oa=gt('<section aria-live="polite"><p class="subtitle-text"> </p> <!></section>');function Ia(n,t){Mr(t,!0);let e=rn(t,"placeholder",3,"Waiting for transcription…"),s=rn(t,"variant",3,"fullscreen");rn(t,"autoscrollEnabled",3,!1);let r=bt(null);const i=we(()=>{const p=t.text.trim();if(!p)return e();if(t.settings.viewMode==="captions"){const g=p.split(`
`);return g.length<=3?p:g.slice(-3).join(`
`)}return p}),o=we(()=>`color: ${t.settings.textColor}; font-size: ${t.settings.fontSize}px; font-weight: ${t.settings.fontWeight}; background-color: transparent; letter-spacing: ${t.settings.letterSpacing}em; opacity: 1;`+(s()==="fullscreen"?"background-color: transparent; box-shadow: none; border: none;":""));function l(p){return new Date(p).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})}var c=Oa(),a=D(c),h=D(a,!0);E(a);var u=v(a,2);{var f=p=>{var g=Aa(),m=D(g);E(g),qt(y=>{ke(g,`color: ${t.settings.textColor??""}; opacity: 0.6;`),Ht(m,`Updated ${y??""}`)},[()=>l(t.lastUpdated)]),ct(p,g)},d=p=>{var g=va();qt(()=>ke(g,`color: ${t.settings.textColor??""}; opacity: 0.6;`)),ct(p,g)};Se(u,p=>{t.lastUpdated?p(f):p(d,!1)})}E(c),ga(c,p=>z(r,p),()=>b(r)),qt(()=>{pe(c,1,`subtitle-shell ${s()==="overlay"?"overlay":""}`),ke(c,b(o)),Ht(h,b(i))}),ct(n,c),Nr()}var Ma=gt('<button type="button"> </button>'),Na=gt('<button type="button" class="preset-chip"> </button>'),Ra=gt('<button type="button" class="reset-button">Reset to default</button>'),La=gt('<aside role="dialog" aria-modal="true" aria-label="Settings panel"><div class="drawer-header"><span class="drawer-title">Settings</span> <button type="button" aria-label="Close settings">✕</button></div> <div class="drawer-body"><section class="drawer-section"><h2 class="section-title">Typography</h2> <div class="control-group"><label class="slider-control" for="font-size-slider"><div>Font Size <span class="value-chip"> </span></div> <input id="font-size-slider" type="range"/></label> <div class="stack" role="group" aria-label="Font weight"></div></div></section> <section class="drawer-section"><h2 class="section-title">Colors</h2> <div class="stack" role="group" aria-label="Color pickers"><label class="color-swatch active" aria-label="Text color picker"><input type="color"/> <span class="sr-only">Choose text color</span></label> <label class="color-swatch active" aria-label="Background color picker"><input type="color"/> <span class="sr-only">Choose background color</span></label></div> <div class="stack" role="group" aria-label="Color presets"></div></section> <section class="drawer-section"><h2 class="section-title">Position</h2> <label class="slider-control" for="vertical-position-slider"><div>Vertical Offset <span class="value-chip"> </span></div> <input id="vertical-position-slider" type="range"/></label> <label class="slider-control" for="horizontal-position-slider"><div>Horizontal Offset <span class="value-chip"> </span></div> <input id="horizontal-position-slider" type="range"/></label></section> <section class="drawer-section"><h2 class="section-title">View Mode</h2> <div class="stack" role="group" aria-label="View mode"><button type="button">Text</button> <button type="button">Captions</button></div></section> <!></div></aside>');function Fa(n,t){Mr(t,!0);const e=[{label:"Regular",value:400},{label:"Semi-bold",value:600}],s=[{label:"White / Black",textColor:"#FFFFFF",backgroundColor:"#000000"},{label:"Yellow / Black",textColor:"#F8E71C",backgroundColor:"#000000"},{label:"Cyan / Dark",textColor:"#50E3C2",backgroundColor:"#0B0B0B"},{label:"Amber / Charcoal",textColor:"#FFB347",backgroundColor:"#1A1A1A"},{label:"Blue / Graphite",textColor:"#E0F0FF",backgroundColor:"#0F1216"}];function r(M,et){t.onChange({...t.settings,[M]:et})}function i(M,et){t.onChange({...t.settings,textColor:M,backgroundColor:et})}var o=La(),l=D(o),c=v(D(l),2);c.__click=function(...M){t.onClose?.apply(this,M)},E(l);var a=v(l,2),h=D(a),u=v(D(h),2),f=D(u),d=D(f),p=v(D(d)),g=D(p);E(p),E(d);var m=v(d,2);nn(m),ht(m,"min",48),ht(m,"max",96),ht(m,"step",2),m.__input=M=>r("fontSize",Number(M.currentTarget.value)),E(f);var y=v(f,2);Di(y,21,()=>e,M=>M.value,(M,et)=>{var at=Ma();at.__click=()=>r("fontWeight",b(et).value);var Is=D(at,!0);E(at),qt(()=>{pe(at,1,`preset-chip ${t.settings.fontWeight===b(et).value?"active":""}`),ht(at,"aria-pressed",t.settings.fontWeight===b(et).value),Ht(Is,b(et).label)}),ct(M,at)}),E(y),E(u),E(h);var I=v(h,2),C=v(D(I),2),J=D(C),ot=D(J);nn(ot),ot.__input=M=>r("textColor",M.currentTarget.value),xi(2),E(J);var j=v(J,2),tt=D(j);nn(tt),tt.__input=M=>r("backgroundColor",M.currentTarget.value),xi(2),E(j),E(C);var mt=v(C,2);Di(mt,21,()=>s,M=>M.label,(M,et)=>{var at=Na();at.__click=()=>i(b(et).textColor,b(et).backgroundColor);var Is=D(at,!0);E(at),qt(()=>Ht(Is,b(et).label)),ct(M,at)}),E(mt),E(I);var G=v(I,2),Vt=v(D(G),2),Pt=D(Vt),Bt=v(D(Pt)),Me=D(Bt);E(Bt),E(Pt);var Gt=v(Pt,2);nn(Gt),ht(Gt,"min",0),ht(Gt,"max",50),ht(Gt,"step",1),Gt.__input=M=>r("verticalPosition",Number(M.currentTarget.value)),E(Vt);var Un=v(Vt,2),A=D(Un),yt=v(D(A)),tn=D(yt);E(yt),E(A);var q=v(A,2);nn(q),ht(q,"min",-50),ht(q,"max",50),ht(q,"step",1),q.__input=M=>r("horizontalPosition",Number(M.currentTarget.value)),E(Un),E(G);var en=v(G,2),Ne=v(D(en),2),Vn=D(Ne);Vn.__click=()=>r("viewMode","text");var Os=v(Vn,2);Os.__click=()=>r("viewMode","captions"),E(Ne),E(en);var Lc=v(en,2);{var Fc=M=>{var et=Ra();et.__click=function(...at){t.onReset?.apply(this,at)},ct(M,et)};Se(Lc,M=>{t.onReset&&M(Fc)})}E(a),E(o),qt(()=>{pe(o,1,`settings-drawer ${t.open?"open":""}`),Ht(g,`${t.settings.fontSize??""}px`),sn(m,t.settings.fontSize),ke(J,`background-color: ${t.settings.textColor??""};`),sn(ot,t.settings.textColor),ke(j,`background-color: ${t.settings.backgroundColor??""};`),sn(tt,t.settings.backgroundColor),Ht(Me,`${t.settings.verticalPosition??""}%`),sn(Gt,t.settings.verticalPosition),Ht(tn,`${t.settings.horizontalPosition??""}%`),sn(q,t.settings.horizontalPosition),pe(Vn,1,`preset-chip ${t.settings.viewMode==="text"?"active":""}`),ht(Vn,"aria-pressed",t.settings.viewMode==="text"),pe(Os,1,`preset-chip ${t.settings.viewMode==="captions"?"active":""}`),ht(Os,"aria-pressed",t.settings.viewMode==="captions")}),ct(n,o),Nr()}Rr(["click","input"]);var za=gt('<div class="connection-indicator"><span aria-hidden="true"></span> <span class="sr-only"> </span></div>');function Ua(n,t){const e={connected:"Connected",connecting:"Connecting…",reconnecting:"Reconnecting…",error:"Error — disconnected",disconnected:"Disconnected"};var s=za(),r=D(s),i=v(r,2),o=D(i,!0);E(i),E(s),qt(()=>{pe(r,1,`connection-dot ${t.state??""}`),Ht(o,e[t.state])}),ct(n,s)}var Va=gt('<div class="spinner" aria-hidden="true"></div>'),Pa=gt('<button type="button" class="preset-chip">Reconnect</button>'),Ba=gt('<div role="alert" aria-live="assertive"><div class="status-message"><!> <p> </p> <!></div></div>');function Wa(n,t){let e=rn(t,"errorMessage",3,null),s=rn(t,"variant",3,"local");const r={connecting:"Connecting to live captions…",reconnecting:"Reconnecting…",disconnected:"Connection lost",error:"Stream unavailable"},i=we(()=>t.state==="connecting"||t.state==="reconnecting"),o=we(()=>e()??r[t.state]??"Working…");var l=zc(),c=ca(l);{var a=h=>{var u=Ba(),f=D(u),d=D(f);{var p=C=>{var J=Va();ct(C,J)};Se(d,C=>{b(i)&&C(p)})}var g=v(d,2),m=D(g,!0);E(g);var y=v(g,2);{var I=C=>{var J=Pa();J.__click=function(...ot){t.onReconnect?.apply(this,ot)},ct(C,J)};Se(y,C=>{b(i)||C(I)})}E(f),E(u),qt(()=>{pe(u,1,`status-overlay ${s()==="global"?"global":""}`),Ht(m,b(o))}),ct(h,u)};Se(c,h=>{t.state!=="connected"&&h(a)})}ct(n,l)}Rr(["click"]);aa(!1,n=>{const t=window.matchMedia("(prefers-reduced-motion: reduce)");n(t.matches);const e=s=>n(s.matches);return t.addEventListener("change",e),()=>t.removeEventListener("change",e)});const Ti={fontSize:72,fontWeight:600,textColor:"#000000",backgroundColor:"#FFFFFF",verticalPosition:30,horizontalPosition:0,viewMode:"text",letterSpacing:.02},rt=()=>new Map,rr=n=>{const t=rt();return n.forEach((e,s)=>{t.set(s,e)}),t},_t=(n,t,e)=>{let s=n.get(t);return s===void 0&&n.set(t,s=e()),s},Ja=(n,t)=>{const e=[];for(const[s,r]of n)e.push(t(r,s));return e},Ha=(n,t)=>{for(const[e,s]of n)if(t(s,e))return!0;return!1},Yt=()=>new Set,zs=n=>n[n.length-1],qa=(n,t)=>{for(let e=0;e<t.length;e++)n.push(t[e])},$t=Array.from,Ka=(n,t)=>{for(let e=0;e<n.length;e++)if(t(n[e],e,n))return!0;return!1},ir=Array.isArray;class Lr{constructor(){this._observers=rt()}on(t,e){return _t(this._observers,t,Yt).add(e),e}once(t,e){const s=(...r)=>{this.off(t,s),e(...r)};this.on(t,s)}off(t,e){const s=this._observers.get(t);s!==void 0&&(s.delete(e),s.size===0&&this._observers.delete(t))}emit(t,e){return $t((this._observers.get(t)||rt()).values()).forEach(s=>s(...e))}destroy(){this._observers=rt()}}class Ya{constructor(){this._observers=rt()}on(t,e){_t(this._observers,t,Yt).add(e)}once(t,e){const s=(...r)=>{this.off(t,s),e(...r)};this.on(t,s)}off(t,e){const s=this._observers.get(t);s!==void 0&&(s.delete(e),s.size===0&&this._observers.delete(t))}emit(t,e){return $t((this._observers.get(t)||rt()).values()).forEach(s=>s(...e))}destroy(){this._observers=rt()}}const zt=Math.floor,$n=Math.abs,Lt=(n,t)=>n<t?n:t,Tt=(n,t)=>n>t?n:t,$a=Math.pow,Lo=n=>n!==0?n<0:1/n<0,Ai=1,vi=2,Us=4,Vs=8,pn=32,Kt=64,it=128,ja=1<<29,ws=31,or=63,Ce=127,Ga=2147483647,Fo=Number.MAX_SAFE_INTEGER,Xa=Number.isInteger||(n=>typeof n=="number"&&isFinite(n)&&zt(n)===n),Za=String.fromCharCode,Qa=n=>n.toLowerCase(),th=/^\s*/g,eh=n=>n.replace(th,""),nh=/([A-Z])/g,Oi=(n,t)=>eh(n.replace(nh,e=>`${t}${Qa(e)}`)),sh=n=>{const t=unescape(encodeURIComponent(n)),e=t.length,s=new Uint8Array(e);for(let r=0;r<e;r++)s[r]=t.codePointAt(r);return s},gn=typeof TextEncoder<"u"?new TextEncoder:null,rh=n=>gn.encode(n),ih=gn?rh:sh;let on=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});on&&on.decode(new Uint8Array).length===1&&(on=null);class On{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const $=()=>new On,oh=n=>{const t=$();return n(t),R(t)},Fr=n=>{let t=n.cpos;for(let e=0;e<n.bufs.length;e++)t+=n.bufs[e].length;return t},R=n=>{const t=new Uint8Array(Fr(n));let e=0;for(let s=0;s<n.bufs.length;s++){const r=n.bufs[s];t.set(r,e),e+=r.length}return t.set(new Uint8Array(n.cbuf.buffer,0,n.cpos),e),t},lh=(n,t)=>{const e=n.cbuf.length;e-n.cpos<t&&(n.bufs.push(new Uint8Array(n.cbuf.buffer,0,n.cpos)),n.cbuf=new Uint8Array(Tt(e,t)*2),n.cpos=0)},K=(n,t)=>{const e=n.cbuf.length;n.cpos===e&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(e*2),n.cpos=0),n.cbuf[n.cpos++]=t},lr=K,w=(n,t)=>{for(;t>Ce;)K(n,it|Ce&t),t=zt(t/128);K(n,Ce&t)},zr=(n,t)=>{const e=Lo(t);for(e&&(t=-t),K(n,(t>or?it:0)|(e?Kt:0)|or&t),t=zt(t/64);t>0;)K(n,(t>Ce?it:0)|Ce&t),t=zt(t/128)},cr=new Uint8Array(3e4),ch=cr.length/3,ah=(n,t)=>{if(t.length<ch){const e=gn.encodeInto(t,cr).written||0;w(n,e);for(let s=0;s<e;s++)K(n,cr[s])}else V(n,ih(t))},hh=(n,t)=>{const e=unescape(encodeURIComponent(t)),s=e.length;w(n,s);for(let r=0;r<s;r++)K(n,e.codePointAt(r))},_e=gn&&gn.encodeInto?ah:hh,Ss=(n,t)=>{const e=n.cbuf.length,s=n.cpos,r=Lt(e-s,t.length),i=t.length-r;n.cbuf.set(t.subarray(0,r),s),n.cpos+=r,i>0&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(Tt(e*2,i)),n.cbuf.set(t.subarray(r)),n.cpos=i)},V=(n,t)=>{w(n,t.byteLength),Ss(n,t)},Ur=(n,t)=>{lh(n,t);const e=new DataView(n.cbuf.buffer,n.cpos,t);return n.cpos+=t,e},uh=(n,t)=>Ur(n,4).setFloat32(0,t,!1),fh=(n,t)=>Ur(n,8).setFloat64(0,t,!1),dh=(n,t)=>Ur(n,8).setBigInt64(0,t,!1),Ii=new DataView(new ArrayBuffer(4)),ph=n=>(Ii.setFloat32(0,n),Ii.getFloat32(0)===n),Ke=(n,t)=>{switch(typeof t){case"string":K(n,119),_e(n,t);break;case"number":Xa(t)&&$n(t)<=Ga?(K(n,125),zr(n,t)):ph(t)?(K(n,124),uh(n,t)):(K(n,123),fh(n,t));break;case"bigint":K(n,122),dh(n,t);break;case"object":if(t===null)K(n,126);else if(ir(t)){K(n,117),w(n,t.length);for(let e=0;e<t.length;e++)Ke(n,t[e])}else if(t instanceof Uint8Array)K(n,116),V(n,t);else{K(n,118);const e=Object.keys(t);w(n,e.length);for(let s=0;s<e.length;s++){const r=e[s];_e(n,r),Ke(n,t[r])}}break;case"boolean":K(n,t?120:121);break;default:K(n,127)}};class Mi extends On{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&w(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const Ni=n=>{n.count>0&&(zr(n.encoder,n.count===1?n.s:-n.s),n.count>1&&w(n.encoder,n.count-2))};class jn{constructor(){this.encoder=new On,this.s=0,this.count=0}write(t){this.s===t?this.count++:(Ni(this),this.count=1,this.s=t)}toUint8Array(){return Ni(this),R(this.encoder)}}const Ri=n=>{if(n.count>0){const t=n.diff*2+(n.count===1?0:1);zr(n.encoder,t),n.count>1&&w(n.encoder,n.count-2)}};class Ps{constructor(){this.encoder=new On,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(Ri(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return Ri(this),R(this.encoder)}}class gh{constructor(){this.sarr=[],this.s="",this.lensE=new jn}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new On;return this.sarr.push(this.s),this.s="",_e(t,this.sarr.join("")),Ss(t,this.lensE.toUint8Array()),R(t)}}const se=n=>new Error(n),Et=()=>{throw se("Method unimplemented")},dt=()=>{throw se("Unexpected case")},zo=se("Unexpected end of array"),Uo=se("Integer out of Range");class ks{constructor(t){this.arr=t,this.pos=0}}const ce=n=>new ks(n),mh=n=>n.pos!==n.arr.length,yh=(n,t)=>{const e=new Uint8Array(n.arr.buffer,n.pos+n.arr.byteOffset,t);return n.pos+=t,e},X=n=>yh(n,S(n)),Ye=n=>n.arr[n.pos++],S=n=>{let t=0,e=1;const s=n.arr.length;for(;n.pos<s;){const r=n.arr[n.pos++];if(t=t+(r&Ce)*e,e*=128,r<it)return t;if(t>Fo)throw Uo}throw zo},Vr=n=>{let t=n.arr[n.pos++],e=t&or,s=64;const r=(t&Kt)>0?-1:1;if((t&it)===0)return r*e;const i=n.arr.length;for(;n.pos<i;){if(t=n.arr[n.pos++],e=e+(t&Ce)*s,s*=128,t<it)return r*e;if(e>Fo)throw Uo}throw zo},bh=n=>{let t=S(n);if(t===0)return"";{let e=String.fromCodePoint(Ye(n));if(--t<100)for(;t--;)e+=String.fromCodePoint(Ye(n));else for(;t>0;){const s=t<1e4?t:1e4,r=n.arr.subarray(n.pos,n.pos+s);n.pos+=s,e+=String.fromCodePoint.apply(null,r),t-=s}return decodeURIComponent(escape(e))}},wh=n=>on.decode(X(n)),ee=on?wh:bh,Pr=(n,t)=>{const e=new DataView(n.arr.buffer,n.arr.byteOffset+n.pos,t);return n.pos+=t,e},Sh=n=>Pr(n,4).getFloat32(0,!1),kh=n=>Pr(n,8).getFloat64(0,!1),Ch=n=>Pr(n,8).getBigInt64(0,!1),_h=[n=>{},n=>null,Vr,Sh,kh,Ch,n=>!1,n=>!0,ee,n=>{const t=S(n),e={};for(let s=0;s<t;s++){const r=ee(n);e[r]=mn(n)}return e},n=>{const t=S(n),e=[];for(let s=0;s<t;s++)e.push(mn(n));return e},X],mn=n=>_h[127-Ye(n)](n);class Li extends ks{constructor(t,e){super(t),this.reader=e,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),mh(this)?this.count=S(this)+1:this.count=-1),this.count--,this.s}}class Gn extends ks{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=Vr(this);const t=Lo(this.s);this.count=1,t&&(this.s=-this.s,this.count=S(this)+2)}return this.count--,this.s}}class Bs extends ks{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const t=Vr(this),e=t&1;this.diff=zt(t/2),this.count=1,e&&(this.count=S(this)+2)}return this.s+=this.diff,this.count--,this.s}}class xh{constructor(t){this.decoder=new Gn(t),this.str=ee(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),e=this.str.slice(this.spos,t);return this.spos=t,e}}const Eh=crypto.getRandomValues.bind(crypto),Dh=Math.random,Vo=()=>Eh(new Uint32Array(1))[0],Th=n=>n[zt(Dh()*n.length)],Ah="10000000-1000-4000-8000"+-1e11,vh=()=>Ah.replace(/[018]/g,n=>(n^Vo()&15>>n/4).toString(16)),re=Date.now,Fi=n=>new Promise(n);Promise.all.bind(Promise);const zi=n=>n===void 0?null:n;class Oh{constructor(){this.map=new Map}setItem(t,e){this.map.set(t,e)}getItem(t){return this.map.get(t)}}let Po=new Oh,Br=!0;try{typeof localStorage<"u"&&localStorage&&(Po=localStorage,Br=!1)}catch{}const Bo=Po,Ih=n=>Br||addEventListener("storage",n),Mh=n=>Br||removeEventListener("storage",n),Nh=Object.assign,Wr=Object.keys,Rh=(n,t)=>{for(const e in n)t(n[e],e)},Lh=(n,t)=>{const e=[];for(const s in n)e.push(t(n[s],s));return e},Ui=n=>Wr(n).length,Vi=n=>Wr(n).length,Fh=n=>{for(const t in n)return!1;return!0},Wo=(n,t)=>{for(const e in n)if(!t(n[e],e))return!1;return!0},Jo=(n,t)=>Object.prototype.hasOwnProperty.call(n,t),zh=(n,t)=>n===t||Vi(n)===Vi(t)&&Wo(n,(e,s)=>(e!==void 0||Jo(t,s))&&t[s]===e),Uh=Object.freeze,Ho=n=>{for(const t in n){const e=n[t];(typeof e=="object"||typeof e=="function")&&Ho(n[t])}return Uh(n)},Pi=Symbol("Equality"),Jr=(n,t,e=0)=>{try{for(;e<n.length;e++)n[e](...t)}finally{e<n.length&&Jr(n,t,e+1)}},Vh=n=>n,ln=(n,t)=>{if(n===t)return!0;if(n==null||t==null||n.constructor!==t.constructor)return!1;if(n[Pi]!=null)return n[Pi](t);switch(n.constructor){case ArrayBuffer:n=new Uint8Array(n),t=new Uint8Array(t);case Uint8Array:{if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.length;e++)if(n[e]!==t[e])return!1;break}case Set:{if(n.size!==t.size)return!1;for(const e of n)if(!t.has(e))return!1;break}case Map:{if(n.size!==t.size)return!1;for(const e of n.keys())if(!t.has(e)||!ln(n.get(e),t.get(e)))return!1;break}case Object:if(Ui(n)!==Ui(t))return!1;for(const e in n)if(!Jo(n,e)||!ln(n[e],t[e]))return!1;break;case Array:if(n.length!==t.length)return!1;for(let e=0;e<n.length;e++)if(!ln(n[e],t[e]))return!1;break;default:return!1}return!0},Ph=(n,t)=>t.includes(n);var qo={};const ie=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",Hr=typeof window<"u"&&typeof document<"u"&&!ie;let Mt;const Bh=()=>{if(Mt===void 0)if(ie){Mt=rt();const n=process.argv;let t=null;for(let e=0;e<n.length;e++){const s=n[e];s[0]==="-"?(t!==null&&Mt.set(t,""),t=s):t!==null&&(Mt.set(t,s),t=null)}t!==null&&Mt.set(t,"")}else typeof location=="object"?(Mt=rt(),(location.search||"?").slice(1).split("&").forEach(n=>{if(n.length!==0){const[t,e]=n.split("=");Mt.set(`--${Oi(t,"-")}`,e),Mt.set(`-${Oi(t,"-")}`,e)}})):Mt=rt();return Mt},ar=n=>Bh().has(n),ns=n=>zi(ie?qo[n.toUpperCase().replaceAll("-","_")]:Bo.getItem(n)),Ko=n=>ar("--"+n)||ns(n)!==null;Ko("production");const Wh=ie&&Ph(qo.FORCE_COLOR,["true","1","2"]),Jh=Wh||!ar("--no-colors")&&!Ko("no-color")&&(!ie||process.stdout.isTTY)&&(!ie||ar("--color")||ns("COLORTERM")!==null||(ns("TERM")||"").includes("color")),Yo=n=>new Uint8Array(n),Hh=(n,t,e)=>new Uint8Array(n,t,e),qh=n=>new Uint8Array(n),Kh=n=>{let t="";for(let e=0;e<n.byteLength;e++)t+=Za(n[e]);return btoa(t)},Yh=n=>Buffer.from(n.buffer,n.byteOffset,n.byteLength).toString("base64"),$h=n=>{const t=atob(n),e=Yo(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e},jh=n=>{const t=Buffer.from(n,"base64");return Hh(t.buffer,t.byteOffset,t.byteLength)},$o=Hr?Kh:Yh,Gh=Hr?$h:jh,Xh=n=>{const t=Yo(n.byteLength);return t.set(n),t},Zh=n=>oh(t=>Ke(t,n));class Qh{constructor(t,e){this.left=t,this.right=e}}const Wt=(n,t)=>new Qh(n,t),tu=typeof document<"u"?document:{};typeof DOMParser<"u"&&new DOMParser;const eu=n=>Ja(n,(t,e)=>`${e}:${t};`).join(""),nu=n=>class{constructor(e){this._=e}destroy(){n(this._)}},su=nu(clearTimeout),qr=(n,t)=>new su(setTimeout(t,n)),jt=Symbol,jo=jt(),Go=jt(),ru=jt(),iu=jt(),ou=jt(),Xo=jt(),lu=jt(),Kr=jt(),cu=jt(),au=n=>{n.length===1&&n[0]?.constructor===Function&&(n=n[0]());const t=[],e=[];let s=0;for(;s<n.length;s++){const r=n[s];if(r===void 0)break;if(r.constructor===String||r.constructor===Number)t.push(r);else if(r.constructor===Object)break}for(s>0&&e.push(t.join(""));s<n.length;s++){const r=n[s];r instanceof Symbol||e.push(r)}return e},hu={[jo]:Wt("font-weight","bold"),[Go]:Wt("font-weight","normal"),[ru]:Wt("color","blue"),[ou]:Wt("color","green"),[iu]:Wt("color","grey"),[Xo]:Wt("color","red"),[lu]:Wt("color","purple"),[Kr]:Wt("color","orange"),[cu]:Wt("color","black")},uu=n=>{n.length===1&&n[0]?.constructor===Function&&(n=n[0]());const t=[],e=[],s=rt();let r=[],i=0;for(;i<n.length;i++){const o=n[i],l=hu[o];if(l!==void 0)s.set(l.left,l.right);else{if(o===void 0)break;if(o.constructor===String||o.constructor===Number){const c=eu(s);i>0||c.length>0?(t.push("%c"+o),e.push(c)):t.push(o)}else break}}for(i>0&&(r=e,r.unshift(t.join("")));i<n.length;i++){const o=n[i];o instanceof Symbol||r.push(o)}return r},Zo=Jh?uu:au,fu=(...n)=>{console.log(...Zo(n)),tl.forEach(t=>t.print(n))},Qo=(...n)=>{console.warn(...Zo(n)),n.unshift(Kr),tl.forEach(t=>t.print(n))},tl=Yt(),el=n=>({[Symbol.iterator](){return this},next:n}),du=(n,t)=>el(()=>{let e;do e=n.next();while(!e.done&&!t(e.value));return e}),Ws=(n,t)=>el(()=>{const{done:e,value:s}=n.next();return{done:e,value:e?void 0:t(s)}});class Yr{constructor(t,e){this.clock=t,this.len=e}}class Ge{constructor(){this.clients=new Map}}const oe=(n,t,e)=>t.clients.forEach((s,r)=>{const i=n.doc.store.clients.get(r);if(i!=null){const o=i[i.length-1],l=o.id.clock+o.length;for(let c=0,a=s[c];c<s.length&&a.clock<l;a=s[++c])gl(n,i,a.clock,a.len,e)}}),pu=(n,t)=>{let e=0,s=n.length-1;for(;e<=s;){const r=zt((e+s)/2),i=n[r],o=i.clock;if(o<=t){if(t<o+i.len)return r;e=r+1}else s=r-1}return null},Xe=(n,t)=>{const e=n.clients.get(t.client);return e!==void 0&&pu(e,t.clock)!==null},$r=n=>{n.clients.forEach(t=>{t.sort((r,i)=>r.clock-i.clock);let e,s;for(e=1,s=1;e<t.length;e++){const r=t[s-1],i=t[e];r.clock+r.len>=i.clock?r.len=Tt(r.len,i.clock+i.len-r.clock):(s<e&&(t[s]=i),s++)}t.length=s})},hr=n=>{const t=new Ge;for(let e=0;e<n.length;e++)n[e].clients.forEach((s,r)=>{if(!t.clients.has(r)){const i=s.slice();for(let o=e+1;o<n.length;o++)qa(i,n[o].clients.get(r)||[]);t.clients.set(r,i)}});return $r(t),t},yn=(n,t,e,s)=>{_t(n.clients,t,()=>[]).push(new Yr(e,s))},nl=()=>new Ge,sl=n=>{const t=nl();return n.clients.forEach((e,s)=>{const r=[];for(let i=0;i<e.length;i++){const o=e[i];if(o.deleted){const l=o.id.clock;let c=o.length;if(i+1<e.length)for(let a=e[i+1];i+1<e.length&&a.deleted;a=e[++i+1])c+=a.length;r.push(new Yr(l,c))}}r.length>0&&t.clients.set(s,r)}),t},Ze=(n,t)=>{w(n.restEncoder,t.clients.size),$t(t.clients.entries()).sort((e,s)=>s[0]-e[0]).forEach(([e,s])=>{n.resetDsCurVal(),w(n.restEncoder,e);const r=s.length;w(n.restEncoder,r);for(let i=0;i<r;i++){const o=s[i];n.writeDsClock(o.clock),n.writeDsLen(o.len)}})},jr=n=>{const t=new Ge,e=S(n.restDecoder);for(let s=0;s<e;s++){n.resetDsCurVal();const r=S(n.restDecoder),i=S(n.restDecoder);if(i>0){const o=_t(t.clients,r,()=>[]);for(let l=0;l<i;l++)o.push(new Yr(n.readDsClock(),n.readDsLen()))}}return t},Bi=(n,t,e)=>{const s=new Ge,r=S(n.restDecoder);for(let i=0;i<r;i++){n.resetDsCurVal();const o=S(n.restDecoder),l=S(n.restDecoder),c=e.clients.get(o)||[],a=P(e,o);for(let h=0;h<l;h++){const u=n.readDsClock(),f=u+n.readDsLen();if(u<a){a<f&&yn(s,o,a,f-a);let d=At(c,u),p=c[d];for(!p.deleted&&p.id.clock<u&&(c.splice(d+1,0,as(t,p,u-p.id.clock)),d++);d<c.length&&(p=c[d++],p.id.clock<f);)p.deleted||(f<p.id.clock+p.length&&c.splice(d,0,as(t,p,f-p.id.clock)),p.delete(t))}else yn(s,o,u,f-u)}}if(s.clients.size>0){const i=new De;return w(i.restEncoder,0),Ze(i,s),i.toUint8Array()}return null},rl=Vo;class ae extends Lr{constructor({guid:t=vh(),collectionid:e=null,gc:s=!0,gcFilter:r=()=>!0,meta:i=null,autoLoad:o=!1,shouldLoad:l=!0}={}){super(),this.gc=s,this.gcFilter=r,this.clientID=rl(),this.guid=t,this.collectionid=e,this.share=new Map,this.store=new dl,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=l,this.autoLoad=o,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=Fi(a=>{this.on("load",()=>{this.isLoaded=!0,a(this)})});const c=()=>Fi(a=>{const h=u=>{(u===void 0||u===!0)&&(this.off("sync",h),a())};this.on("sync",h)});this.on("sync",a=>{a===!1&&this.isSynced&&(this.whenSynced=c()),this.isSynced=a===void 0||a===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=c()}load(){const t=this._item;t!==null&&!this.shouldLoad&&N(t.parent.doc,e=>{e.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set($t(this.subdocs).map(t=>t.guid))}transact(t,e=null){return N(this,t,e)}get(t,e=Y){const s=_t(this.share,t,()=>{const i=new e;return i._integrate(this,null),i}),r=s.constructor;if(e!==Y&&r!==e)if(r===Y){const i=new e;i._map=s._map,s._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=i}),i._start=s._start;for(let o=i._start;o!==null;o=o.right)o.parent=i;return i._length=s._length,this.share.set(t,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return s}getArray(t=""){return this.get(t,Be)}getText(t=""){return this.get(t,le)}getMap(t=""){return this.get(t,je)}getXmlElement(t=""){return this.get(t,st)}getXmlFragment(t=""){return this.get(t,Te)}toJSON(){const t={};return this.share.forEach((e,s)=>{t[s]=e.toJSON()}),t}destroy(){this.isDestroyed=!0,$t(this.subdocs).forEach(e=>e.destroy());const t=this._item;if(t!==null){this._item=null;const e=t.content;e.doc=new ae({guid:this.guid,...e.opts,shouldLoad:!1}),e.doc._item=t,N(t.parent.doc,s=>{const r=e.doc;t.deleted||s.subdocsAdded.add(r),s.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class il{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return S(this.restDecoder)}readDsLen(){return S(this.restDecoder)}}class ol extends il{readLeftID(){return k(S(this.restDecoder),S(this.restDecoder))}readRightID(){return k(S(this.restDecoder),S(this.restDecoder))}readClient(){return S(this.restDecoder)}readInfo(){return Ye(this.restDecoder)}readString(){return ee(this.restDecoder)}readParentInfo(){return S(this.restDecoder)===1}readTypeRef(){return S(this.restDecoder)}readLen(){return S(this.restDecoder)}readAny(){return mn(this.restDecoder)}readBuf(){return Xh(X(this.restDecoder))}readJSON(){return JSON.parse(ee(this.restDecoder))}readKey(){return ee(this.restDecoder)}}class gu{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=S(this.restDecoder),this.dsCurrVal}readDsLen(){const t=S(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class $e extends gu{constructor(t){super(t),this.keys=[],S(t),this.keyClockDecoder=new Bs(X(t)),this.clientDecoder=new Gn(X(t)),this.leftClockDecoder=new Bs(X(t)),this.rightClockDecoder=new Bs(X(t)),this.infoDecoder=new Li(X(t),Ye),this.stringDecoder=new xh(X(t)),this.parentInfoDecoder=new Li(X(t),Ye),this.typeRefDecoder=new Gn(X(t)),this.lenDecoder=new Gn(X(t))}readLeftID(){return new Ve(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ve(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return mn(this.restDecoder)}readBuf(){return X(this.restDecoder)}readJSON(){return mn(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const e=this.stringDecoder.read();return this.keys.push(e),e}}}class ll{constructor(){this.restEncoder=$()}toUint8Array(){return R(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){w(this.restEncoder,t)}writeDsLen(t){w(this.restEncoder,t)}}class In extends ll{writeLeftID(t){w(this.restEncoder,t.client),w(this.restEncoder,t.clock)}writeRightID(t){w(this.restEncoder,t.client),w(this.restEncoder,t.clock)}writeClient(t){w(this.restEncoder,t)}writeInfo(t){lr(this.restEncoder,t)}writeString(t){_e(this.restEncoder,t)}writeParentInfo(t){w(this.restEncoder,t?1:0)}writeTypeRef(t){w(this.restEncoder,t)}writeLen(t){w(this.restEncoder,t)}writeAny(t){Ke(this.restEncoder,t)}writeBuf(t){V(this.restEncoder,t)}writeJSON(t){_e(this.restEncoder,JSON.stringify(t))}writeKey(t){_e(this.restEncoder,t)}}class cl{constructor(){this.restEncoder=$(),this.dsCurrVal=0}toUint8Array(){return R(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){const e=t-this.dsCurrVal;this.dsCurrVal=t,w(this.restEncoder,e)}writeDsLen(t){t===0&&dt(),w(this.restEncoder,t-1),this.dsCurrVal+=t}}class De extends cl{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Ps,this.clientEncoder=new jn,this.leftClockEncoder=new Ps,this.rightClockEncoder=new Ps,this.infoEncoder=new Mi(lr),this.stringEncoder=new gh,this.parentInfoEncoder=new Mi(lr),this.typeRefEncoder=new jn,this.lenEncoder=new jn}toUint8Array(){const t=$();return w(t,0),V(t,this.keyClockEncoder.toUint8Array()),V(t,this.clientEncoder.toUint8Array()),V(t,this.leftClockEncoder.toUint8Array()),V(t,this.rightClockEncoder.toUint8Array()),V(t,R(this.infoEncoder)),V(t,this.stringEncoder.toUint8Array()),V(t,R(this.parentInfoEncoder)),V(t,this.typeRefEncoder.toUint8Array()),V(t,this.lenEncoder.toUint8Array()),Ss(t,R(this.restEncoder)),R(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){Ke(this.restEncoder,t)}writeBuf(t){V(this.restEncoder,t)}writeJSON(t){Ke(this.restEncoder,t)}writeKey(t){const e=this.keyMap.get(t);e===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(e)}}const mu=(n,t,e,s)=>{s=Tt(s,t[0].id.clock);const r=At(t,s);w(n.restEncoder,t.length-r),n.writeClient(e),w(n.restEncoder,s);const i=t[r];i.write(n,s-i.id.clock);for(let o=r+1;o<t.length;o++)t[o].write(n,0)},Gr=(n,t,e)=>{const s=new Map;e.forEach((r,i)=>{P(t,i)>r&&s.set(i,r)}),Mn(t).forEach((r,i)=>{e.has(i)||s.set(i,0)}),w(n.restEncoder,s.size),$t(s.entries()).sort((r,i)=>i[0]-r[0]).forEach(([r,i])=>{mu(n,t.clients.get(r),r,i)})},yu=(n,t)=>{const e=rt(),s=S(n.restDecoder);for(let r=0;r<s;r++){const i=S(n.restDecoder),o=new Array(i),l=n.readClient();let c=S(n.restDecoder);e.set(l,{i:0,refs:o});for(let a=0;a<i;a++){const h=n.readInfo();switch(ws&h){case 0:{const u=n.readLen();o[a]=new St(k(l,c),u),c+=u;break}case 10:{const u=S(n.restDecoder);o[a]=new kt(k(l,c),u),c+=u;break}default:{const u=(h&(Kt|it))===0,f=new O(k(l,c),null,(h&it)===it?n.readLeftID():null,null,(h&Kt)===Kt?n.readRightID():null,u?n.readParentInfo()?t.get(n.readString()):n.readLeftID():null,u&&(h&pn)===pn?n.readString():null,zl(n,h));o[a]=f,c+=f.length}}}}return e},bu=(n,t,e)=>{const s=[];let r=$t(e.keys()).sort((d,p)=>d-p);if(r.length===0)return null;const i=()=>{if(r.length===0)return null;let d=e.get(r[r.length-1]);for(;d.refs.length===d.i;)if(r.pop(),r.length>0)d=e.get(r[r.length-1]);else return null;return d};let o=i();if(o===null)return null;const l=new dl,c=new Map,a=(d,p)=>{const g=c.get(d);(g==null||g>p)&&c.set(d,p)};let h=o.refs[o.i++];const u=new Map,f=()=>{for(const d of s){const p=d.id.client,g=e.get(p);g?(g.i--,l.clients.set(p,g.refs.slice(g.i)),e.delete(p),g.i=0,g.refs=[]):l.clients.set(p,[d]),r=r.filter(m=>m!==p)}s.length=0};for(;;){if(h.constructor!==kt){const p=_t(u,h.id.client,()=>P(t,h.id.client))-h.id.clock;if(p<0)s.push(h),a(h.id.client,h.id.clock-1),f();else{const g=h.getMissing(n,t);if(g!==null){s.push(h);const m=e.get(g)||{refs:[],i:0};if(m.refs.length===m.i)a(g,P(t,g)),f();else{h=m.refs[m.i++];continue}}else(p===0||p<h.length)&&(h.integrate(n,p),u.set(h.id.client,h.id.clock+h.length))}}if(s.length>0)h=s.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=i(),o===null)break;h=o.refs[o.i++]}}if(l.clients.size>0){const d=new De;return Gr(d,l,new Map),w(d.restEncoder,0),{missing:c,update:d.toUint8Array()}}return null},wu=(n,t)=>Gr(n,t.doc.store,t.beforeState),Su=(n,t,e,s=new $e(n))=>N(t,r=>{r.local=!1;let i=!1;const o=r.doc,l=o.store,c=yu(s,o),a=bu(r,l,c),h=l.pendingStructs;if(h){for(const[f,d]of h.missing)if(d<P(l,f)){i=!0;break}if(a){for(const[f,d]of a.missing){const p=h.missing.get(f);(p==null||p>d)&&h.missing.set(f,d)}h.update=rs([h.update,a.update])}}else l.pendingStructs=a;const u=Bi(s,r,l);if(l.pendingDs){const f=new $e(ce(l.pendingDs));S(f.restDecoder);const d=Bi(f,r,l);u&&d?l.pendingDs=rs([u,d]):l.pendingDs=u||d}else l.pendingDs=u;if(i){const f=l.pendingStructs.update;l.pendingStructs=null,ss(r.doc,f)}},e,!1),ss=(n,t,e,s=$e)=>{const r=ce(t);Su(r,n,e,new s(r))},ku=(n,t,e)=>ss(n,t,e,ol),Cu=(n,t,e=new Map)=>{Gr(n,t.store,e),Ze(n,sl(t.store))},_u=(n,t=new Uint8Array([0]),e=new De)=>{const s=al(t);Cu(e,n,s);const r=[e.toUint8Array()];if(n.store.pendingDs&&r.push(n.store.pendingDs),n.store.pendingStructs&&r.push(Ju(n.store.pendingStructs.update,t)),r.length>1){if(e.constructor===In)return Bu(r.map((i,o)=>o===0?i:qu(i)));if(e.constructor===De)return rs(r)}return r[0]},xu=(n,t)=>_u(n,t,new In),Eu=n=>{const t=new Map,e=S(n.restDecoder);for(let s=0;s<e;s++){const r=S(n.restDecoder),i=S(n.restDecoder);t.set(r,i)}return t},al=n=>Eu(new il(ce(n))),hl=(n,t)=>(w(n.restEncoder,t.size),$t(t.entries()).sort((e,s)=>s[0]-e[0]).forEach(([e,s])=>{w(n.restEncoder,e),w(n.restEncoder,s)}),n),Du=(n,t)=>hl(n,Mn(t.store)),Tu=(n,t=new cl)=>(n instanceof Map?hl(t,n):Du(t,n),t.toUint8Array()),Au=n=>Tu(n,new ll);class vu{constructor(){this.l=[]}}const Wi=()=>new vu,Ji=(n,t)=>n.l.push(t),Hi=(n,t)=>{const e=n.l,s=e.length;n.l=e.filter(r=>t!==r),s===n.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},ul=(n,t,e)=>Jr(n.l,[t,e]);class Ve{constructor(t,e){this.client=t,this.clock=e}}const Ue=(n,t)=>n===t||n!==null&&t!==null&&n.client===t.client&&n.clock===t.clock,k=(n,t)=>new Ve(n,t),bn=n=>{for(const[t,e]of n.doc.share.entries())if(e===n)return t;throw dt()},wn=(n,t)=>{for(;t!==null;){if(t.parent===n)return!0;t=t.parent._item}return!1};class Sn{constructor(t,e,s,r=0){this.type=t,this.tname=e,this.item=s,this.assoc=r}}const cn=n=>new Sn(n.type==null?null:k(n.type.client,n.type.clock),n.tname??null,n.item==null?null:k(n.item.client,n.item.clock),n.assoc==null?0:n.assoc);class Ou{constructor(t,e,s=0){this.type=t,this.index=e,this.assoc=s}}const Iu=(n,t,e=0)=>new Ou(n,t,e),Bn=(n,t,e)=>{let s=null,r=null;return n._item===null?r=bn(n):s=k(n._item.id.client,n._item.id.clock),new Sn(s,r,t,e)},Js=(n,t,e=0)=>{let s=n._start;if(e<0){if(t===0)return Bn(n,null,e);t--}for(;s!==null;){if(!s.deleted&&s.countable){if(s.length>t)return Bn(n,k(s.id.client,s.id.clock+t),e);t-=s.length}if(s.right===null&&e<0)return Bn(n,s.lastId,e);s=s.right}return Bn(n,null,e)},Mu=(n,t)=>{const e=Pe(n,t),s=t.clock-e.id.clock;return{item:e,diff:s}},Nu=(n,t,e=!0)=>{const s=t.store,r=n.item,i=n.type,o=n.tname,l=n.assoc;let c=null,a=0;if(r!==null){if(P(s,r.client)<=r.clock)return null;const h=e?pr(s,r):Mu(s,r),u=h.item;if(!(u instanceof O))return null;if(c=u.parent,c._item===null||!c._item.deleted){a=u.deleted||!u.countable?0:h.diff+(l>=0?0:1);let f=u.left;for(;f!==null;)!f.deleted&&f.countable&&(a+=f.length),f=f.left}}else{if(o!==null)c=t.get(o);else if(i!==null){if(P(s,i.client)<=i.clock)return null;const{item:h}=e?pr(s,i):{item:Pe(s,i)};if(h instanceof O&&h.content instanceof Ot)c=h.content.type;else return null}else throw dt();l>=0?a=c._length:a=0}return Iu(c,a,n.assoc)},qi=(n,t)=>n===t||n!==null&&t!==null&&n.tname===t.tname&&Ue(n.item,t.item)&&Ue(n.type,t.type)&&n.assoc===t.assoc;class Xr{constructor(t,e){this.ds=t,this.sv=e}}const fl=(n,t)=>new Xr(n,t),Hs=n=>fl(sl(n.store),Mn(n.store)),fe=(n,t)=>t===void 0?!n.deleted:t.sv.has(n.id.client)&&(t.sv.get(n.id.client)||0)>n.id.clock&&!Xe(t.ds,n.id),ur=(n,t)=>{const e=_t(n.meta,ur,Yt),s=n.doc.store;e.has(t)||(t.sv.forEach((r,i)=>{r<P(s,i)&&lt(n,k(i,r))}),oe(n,t.ds,r=>{}),e.add(t))};class dl{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const Mn=n=>{const t=new Map;return n.clients.forEach((e,s)=>{const r=e[e.length-1];t.set(s,r.id.clock+r.length)}),t},P=(n,t)=>{const e=n.clients.get(t);if(e===void 0)return 0;const s=e[e.length-1];return s.id.clock+s.length},pl=(n,t)=>{let e=n.clients.get(t.id.client);if(e===void 0)e=[],n.clients.set(t.id.client,e);else{const s=e[e.length-1];if(s.id.clock+s.length!==t.id.clock)throw dt()}e.push(t)},At=(n,t)=>{let e=0,s=n.length-1,r=n[s],i=r.id.clock;if(i===t)return s;let o=zt(t/(i+r.length-1)*s);for(;e<=s;){if(r=n[o],i=r.id.clock,i<=t){if(t<i+r.length)return o;e=o+1}else s=o-1;o=zt((e+s)/2)}throw dt()},Ru=(n,t)=>{const e=n.clients.get(t.client);return e[At(e,t.clock)]},Pe=Ru,fr=(n,t,e)=>{const s=At(t,e),r=t[s];return r.id.clock<e&&r instanceof O?(t.splice(s+1,0,as(n,r,e-r.id.clock)),s+1):s},lt=(n,t)=>{const e=n.doc.store.clients.get(t.client);return e[fr(n,e,t.clock)]},Ki=(n,t,e)=>{const s=t.clients.get(e.client),r=At(s,e.clock),i=s[r];return e.clock!==i.id.clock+i.length-1&&i.constructor!==St&&s.splice(r+1,0,as(n,i,e.clock-i.id.clock+1)),i},Lu=(n,t,e)=>{const s=n.clients.get(t.id.client);s[At(s,t.id.clock)]=e},gl=(n,t,e,s,r)=>{if(s===0)return;const i=e+s;let o=fr(n,t,e),l;do l=t[o++],i<l.id.clock+l.length&&fr(n,t,i),r(l);while(o<t.length&&t[o].id.clock<i)};class Fu{constructor(t,e,s){this.doc=t,this.deleteSet=new Ge,this.beforeState=Mn(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=e,this.meta=new Map,this.local=s,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const Yi=(n,t)=>t.deleteSet.clients.size===0&&!Ha(t.afterState,(e,s)=>t.beforeState.get(s)!==e)?!1:($r(t.deleteSet),wu(n,t),Ze(n,t.deleteSet),!0),$i=(n,t,e)=>{const s=t._item;(s===null||s.id.clock<(n.beforeState.get(s.id.client)||0)&&!s.deleted)&&_t(n.changed,t,Yt).add(e)},Xn=(n,t)=>{let e=n[t],s=n[t-1],r=t;for(;r>0;e=s,s=n[--r-1]){if(s.deleted===e.deleted&&s.constructor===e.constructor&&s.mergeWith(e)){e instanceof O&&e.parentSub!==null&&e.parent._map.get(e.parentSub)===e&&e.parent._map.set(e.parentSub,s);continue}break}const i=t-r;return i&&n.splice(t+1-i,i),i},zu=(n,t,e)=>{for(const[s,r]of n.clients.entries()){const i=t.clients.get(s);for(let o=r.length-1;o>=0;o--){const l=r[o],c=l.clock+l.len;for(let a=At(i,l.clock),h=i[a];a<i.length&&h.id.clock<c;h=i[++a]){const u=i[a];if(l.clock+l.len<=u.id.clock)break;u instanceof O&&u.deleted&&!u.keep&&e(u)&&u.gc(t,!1)}}}},Uu=(n,t)=>{n.clients.forEach((e,s)=>{const r=t.clients.get(s);for(let i=e.length-1;i>=0;i--){const o=e[i],l=Lt(r.length-1,1+At(r,o.clock+o.len-1));for(let c=l,a=r[c];c>0&&a.id.clock>=o.clock;a=r[c])c-=1+Xn(r,c)}})},ml=(n,t)=>{if(t<n.length){const e=n[t],s=e.doc,r=s.store,i=e.deleteSet,o=e._mergeStructs;try{$r(i),e.afterState=Mn(e.doc.store),s.emit("beforeObserverCalls",[e,s]);const l=[];e.changed.forEach((c,a)=>l.push(()=>{(a._item===null||!a._item.deleted)&&a._callObserver(e,c)})),l.push(()=>{e.changedParentTypes.forEach((c,a)=>{a._dEH.l.length>0&&(a._item===null||!a._item.deleted)&&(c=c.filter(h=>h.target._item===null||!h.target._item.deleted),c.forEach(h=>{h.currentTarget=a,h._path=null}),c.sort((h,u)=>h.path.length-u.path.length),ul(a._dEH,c,e))})}),l.push(()=>s.emit("afterTransaction",[e,s])),Jr(l,[]),e._needFormattingCleanup&&of(e)}finally{s.gc&&zu(i,r,s.gcFilter),Uu(i,r),e.afterState.forEach((h,u)=>{const f=e.beforeState.get(u)||0;if(f!==h){const d=r.clients.get(u),p=Tt(At(d,f),1);for(let g=d.length-1;g>=p;)g-=1+Xn(d,g)}});for(let h=o.length-1;h>=0;h--){const{client:u,clock:f}=o[h].id,d=r.clients.get(u),p=At(d,f);p+1<d.length&&Xn(d,p+1)>1||p>0&&Xn(d,p)}if(!e.local&&e.afterState.get(s.clientID)!==e.beforeState.get(s.clientID)&&(fu(Kr,jo,"[yjs] ",Go,Xo,"Changed the client-id because another client seems to be using it."),s.clientID=rl()),s.emit("afterTransactionCleanup",[e,s]),s._observers.has("update")){const h=new In;Yi(h,e)&&s.emit("update",[h.toUint8Array(),e.origin,s,e])}if(s._observers.has("updateV2")){const h=new De;Yi(h,e)&&s.emit("updateV2",[h.toUint8Array(),e.origin,s,e])}const{subdocsAdded:l,subdocsLoaded:c,subdocsRemoved:a}=e;(l.size>0||a.size>0||c.size>0)&&(l.forEach(h=>{h.clientID=s.clientID,h.collectionid==null&&(h.collectionid=s.collectionid),s.subdocs.add(h)}),a.forEach(h=>s.subdocs.delete(h)),s.emit("subdocs",[{loaded:c,added:l,removed:a},s,e]),a.forEach(h=>h.destroy())),n.length<=t+1?(s._transactionCleanups=[],s.emit("afterAllTransactions",[s,n])):ml(n,t+1)}}},N=(n,t,e=null,s=!0)=>{const r=n._transactionCleanups;let i=!1,o=null;n._transaction===null&&(i=!0,n._transaction=new Fu(n,e,s),r.push(n._transaction),r.length===1&&n.emit("beforeAllTransactions",[n]),n.emit("beforeTransaction",[n._transaction,n]));try{o=t(n._transaction)}finally{if(i){const l=n._transaction===r[0];n._transaction=null,l&&ml(r,0)}}return o};class Vu{constructor(t,e){this.insertions=e,this.deletions=t,this.meta=new Map}}const ji=(n,t,e)=>{oe(n,e.deletions,s=>{s instanceof O&&t.scope.some(r=>r===n.doc||wn(r,s))&&ii(s,!1)})},Gi=(n,t,e)=>{let s=null;const r=n.doc,i=n.scope;N(r,l=>{for(;t.length>0&&n.currStackItem===null;){const c=r.store,a=t.pop(),h=new Set,u=[];let f=!1;oe(l,a.insertions,d=>{if(d instanceof O){if(d.redone!==null){let{item:p,diff:g}=pr(c,d.id);g>0&&(p=lt(l,k(p.id.client,p.id.clock+g))),d=p}!d.deleted&&i.some(p=>p===l.doc||wn(p,d))&&u.push(d)}}),oe(l,a.deletions,d=>{d instanceof O&&i.some(p=>p===l.doc||wn(p,d))&&!Xe(a.insertions,d.id)&&h.add(d)}),h.forEach(d=>{f=Fl(l,d,h,a.insertions,n.ignoreRemoteMapChanges,n)!==null||f});for(let d=u.length-1;d>=0;d--){const p=u[d];n.deleteFilter(p)&&(p.delete(l),f=!0)}n.currStackItem=f?a:null}l.changed.forEach((c,a)=>{c.has(null)&&a._searchMarker&&(a._searchMarker.length=0)}),s=l},n);const o=n.currStackItem;if(o!=null){const l=s.changedParentTypes;n.emit("stack-item-popped",[{stackItem:o,type:e,changedParentTypes:l,origin:n},n]),n.currStackItem=null}return o};class yl extends Lr{constructor(t,{captureTimeout:e=500,captureTransaction:s=c=>!0,deleteFilter:r=()=>!0,trackedOrigins:i=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:l=ir(t)?t[0].doc:t instanceof ae?t:t.doc}={}){super(),this.scope=[],this.doc=l,this.addToScope(t),this.deleteFilter=r,i.add(this),this.trackedOrigins=i,this.captureTransaction=s,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=e,this.afterTransactionHandler=c=>{if(!this.captureTransaction(c)||!this.scope.some(m=>c.changedParentTypes.has(m)||m===this.doc)||!this.trackedOrigins.has(c.origin)&&(!c.origin||!this.trackedOrigins.has(c.origin.constructor)))return;const a=this.undoing,h=this.redoing,u=a?this.redoStack:this.undoStack;a?this.stopCapturing():h||this.clear(!1,!0);const f=new Ge;c.afterState.forEach((m,y)=>{const I=c.beforeState.get(y)||0,C=m-I;C>0&&yn(f,y,I,C)});const d=re();let p=!1;if(this.lastChange>0&&d-this.lastChange<this.captureTimeout&&u.length>0&&!a&&!h){const m=u[u.length-1];m.deletions=hr([m.deletions,c.deleteSet]),m.insertions=hr([m.insertions,f])}else u.push(new Vu(c.deleteSet,f)),p=!0;!a&&!h&&(this.lastChange=d),oe(c,c.deleteSet,m=>{m instanceof O&&this.scope.some(y=>y===c.doc||wn(y,m))&&ii(m,!0)});const g=[{stackItem:u[u.length-1],origin:c.origin,type:a?"redo":"undo",changedParentTypes:c.changedParentTypes},this];p?this.emit("stack-item-added",g):this.emit("stack-item-updated",g)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){const e=new Set(this.scope);t=ir(t)?t:[t],t.forEach(s=>{e.has(s)||(e.add(s),(s instanceof Y?s.doc!==this.doc:s!==this.doc)&&Qo("[yjs#509] Not same Y.Doc"),this.scope.push(s))})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,e=!0){(t&&this.canUndo()||e&&this.canRedo())&&this.doc.transact(s=>{t&&(this.undoStack.forEach(r=>ji(s,this,r)),this.undoStack=[]),e&&(this.redoStack.forEach(r=>ji(s,this,r)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:e}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let t;try{t=Gi(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){this.redoing=!0;let t;try{t=Gi(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}function*Pu(n){const t=S(n.restDecoder);for(let e=0;e<t;e++){const s=S(n.restDecoder),r=n.readClient();let i=S(n.restDecoder);for(let o=0;o<s;o++){const l=n.readInfo();if(l===10){const c=S(n.restDecoder);yield new kt(k(r,i),c),i+=c}else if((ws&l)!==0){const c=(l&(Kt|it))===0,a=new O(k(r,i),null,(l&it)===it?n.readLeftID():null,null,(l&Kt)===Kt?n.readRightID():null,c?n.readParentInfo()?n.readString():n.readLeftID():null,c&&(l&pn)===pn?n.readString():null,zl(n,l));yield a,i+=a.length}else{const c=n.readLen();yield new St(k(r,i),c),i+=c}}}}class Zr{constructor(t,e){this.gen=Pu(t),this.curr=null,this.done=!1,this.filterSkips=e,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===kt);return this.curr}}class Qr{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const Bu=n=>rs(n,ol,In),Wu=(n,t)=>{if(n.constructor===St){const{client:e,clock:s}=n.id;return new St(k(e,s+t),n.length-t)}else if(n.constructor===kt){const{client:e,clock:s}=n.id;return new kt(k(e,s+t),n.length-t)}else{const e=n,{client:s,clock:r}=e.id;return new O(k(s,r+t),null,k(s,r+t-1),null,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t))}},rs=(n,t=$e,e=De)=>{if(n.length===1)return n[0];const s=n.map(h=>new t(ce(h)));let r=s.map(h=>new Zr(h,!0)),i=null;const o=new e,l=new Qr(o);for(;r=r.filter(f=>f.curr!==null),r.sort((f,d)=>{if(f.curr.id.client===d.curr.id.client){const p=f.curr.id.clock-d.curr.id.clock;return p===0?f.curr.constructor===d.curr.constructor?0:f.curr.constructor===kt?1:-1:p}else return d.curr.id.client-f.curr.id.client}),r.length!==0;){const h=r[0],u=h.curr.id.client;if(i!==null){let f=h.curr,d=!1;for(;f!==null&&f.id.clock+f.length<=i.struct.id.clock+i.struct.length&&f.id.client>=i.struct.id.client;)f=h.next(),d=!0;if(f===null||f.id.client!==u||d&&f.id.clock>i.struct.id.clock+i.struct.length)continue;if(u!==i.struct.id.client)Zt(l,i.struct,i.offset),i={struct:f,offset:0},h.next();else if(i.struct.id.clock+i.struct.length<f.id.clock)if(i.struct.constructor===kt)i.struct.length=f.id.clock+f.length-i.struct.id.clock;else{Zt(l,i.struct,i.offset);const p=f.id.clock-i.struct.id.clock-i.struct.length;i={struct:new kt(k(u,i.struct.id.clock+i.struct.length),p),offset:0}}else{const p=i.struct.id.clock+i.struct.length-f.id.clock;p>0&&(i.struct.constructor===kt?i.struct.length-=p:f=Wu(f,p)),i.struct.mergeWith(f)||(Zt(l,i.struct,i.offset),i={struct:f,offset:0},h.next())}}else i={struct:h.curr,offset:0},h.next();for(let f=h.curr;f!==null&&f.id.client===u&&f.id.clock===i.struct.id.clock+i.struct.length&&f.constructor!==kt;f=h.next())Zt(l,i.struct,i.offset),i={struct:f,offset:0}}i!==null&&(Zt(l,i.struct,i.offset),i=null),ti(l);const c=s.map(h=>jr(h)),a=hr(c);return Ze(o,a),o.toUint8Array()},Ju=(n,t,e=$e,s=De)=>{const r=al(t),i=new s,o=new Qr(i),l=new e(ce(n)),c=new Zr(l,!1);for(;c.curr;){const h=c.curr,u=h.id.client,f=r.get(u)||0;if(c.curr.constructor===kt){c.next();continue}if(h.id.clock+h.length>f)for(Zt(o,h,Tt(f-h.id.clock,0)),c.next();c.curr&&c.curr.id.client===u;)Zt(o,c.curr,0),c.next();else for(;c.curr&&c.curr.id.client===u&&c.curr.id.clock+c.curr.length<=f;)c.next()}ti(o);const a=jr(l);return Ze(i,a),i.toUint8Array()},bl=n=>{n.written>0&&(n.clientStructs.push({written:n.written,restEncoder:R(n.encoder.restEncoder)}),n.encoder.restEncoder=$(),n.written=0)},Zt=(n,t,e)=>{n.written>0&&n.currClient!==t.id.client&&bl(n),n.written===0&&(n.currClient=t.id.client,n.encoder.writeClient(t.id.client),w(n.encoder.restEncoder,t.id.clock+e)),t.write(n.encoder,e),n.written++},ti=n=>{bl(n);const t=n.encoder.restEncoder;w(t,n.clientStructs.length);for(let e=0;e<n.clientStructs.length;e++){const s=n.clientStructs[e];w(t,s.written),Ss(t,s.restEncoder)}},Hu=(n,t,e,s)=>{const r=new e(ce(n)),i=new Zr(r,!1),o=new s,l=new Qr(o);for(let a=i.curr;a!==null;a=i.next())Zt(l,t(a),0);ti(l);const c=jr(r);return Ze(o,c),o.toUint8Array()},qu=n=>Hu(n,Vh,$e,In),Xi="You must not compute changes after the event-handler fired.";class Cs{constructor(t,e){this.target=t,this.currentTarget=t,this.transaction=e,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=Ku(this.currentTarget,this.target))}deletes(t){return Xe(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw se(Xi);const t=new Map,e=this.target;this.transaction.changed.get(e).forEach(r=>{if(r!==null){const i=e._map.get(r);let o,l;if(this.adds(i)){let c=i.left;for(;c!==null&&this.adds(c);)c=c.left;if(this.deletes(i))if(c!==null&&this.deletes(c))o="delete",l=zs(c.content.getContent());else return;else c!==null&&this.deletes(c)?(o="update",l=zs(c.content.getContent())):(o="add",l=void 0)}else if(this.deletes(i))o="delete",l=zs(i.content.getContent());else return;t.set(r,{action:o,oldValue:l})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw se(Xi);const e=this.target,s=Yt(),r=Yt(),i=[];if(t={added:s,deleted:r,delta:i,keys:this.keys},this.transaction.changed.get(e).has(null)){let l=null;const c=()=>{l&&i.push(l)};for(let a=e._start;a!==null;a=a.right)a.deleted?this.deletes(a)&&!this.adds(a)&&((l===null||l.delete===void 0)&&(c(),l={delete:0}),l.delete+=a.length,r.add(a)):this.adds(a)?((l===null||l.insert===void 0)&&(c(),l={insert:[]}),l.insert=l.insert.concat(a.content.getContent()),s.add(a)):((l===null||l.retain===void 0)&&(c(),l={retain:0}),l.retain+=a.length);l!==null&&l.retain===void 0&&c()}this._changes=t}return t}}const Ku=(n,t)=>{const e=[];for(;t._item!==null&&t!==n;){if(t._item.parentSub!==null)e.unshift(t._item.parentSub);else{let s=0,r=t._item.parent._start;for(;r!==t._item&&r!==null;)!r.deleted&&r.countable&&(s+=r.length),r=r.right;e.unshift(s)}t=t._item.parent}return e},Z=()=>{Qo("Invalid access: Add Yjs type to a document before reading data.")},wl=80;let ei=0;class Yu{constructor(t,e){t.marker=!0,this.p=t,this.index=e,this.timestamp=ei++}}const $u=n=>{n.timestamp=ei++},Sl=(n,t,e)=>{n.p.marker=!1,n.p=t,t.marker=!0,n.index=e,n.timestamp=ei++},ju=(n,t,e)=>{if(n.length>=wl){const s=n.reduce((r,i)=>r.timestamp<i.timestamp?r:i);return Sl(s,t,e),s}else{const s=new Yu(t,e);return n.push(s),s}},_s=(n,t)=>{if(n._start===null||t===0||n._searchMarker===null)return null;const e=n._searchMarker.length===0?null:n._searchMarker.reduce((i,o)=>$n(t-i.index)<$n(t-o.index)?i:o);let s=n._start,r=0;for(e!==null&&(s=e.p,r=e.index,$u(e));s.right!==null&&r<t;){if(!s.deleted&&s.countable){if(t<r+s.length)break;r+=s.length}s=s.right}for(;s.left!==null&&r>t;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);for(;s.left!==null&&s.left.id.client===s.id.client&&s.left.id.clock+s.left.length===s.id.clock;)s=s.left,!s.deleted&&s.countable&&(r-=s.length);return e!==null&&$n(e.index-r)<s.parent.length/wl?(Sl(e,s,r),e):ju(n._searchMarker,s,r)},kn=(n,t,e)=>{for(let s=n.length-1;s>=0;s--){const r=n[s];if(e>0){let i=r.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(r.index-=i.length);if(i===null||i.marker===!0){n.splice(s,1);continue}r.p=i,i.marker=!0}(t<r.index||e>0&&t===r.index)&&(r.index=Tt(t,r.index+e))}},xs=(n,t,e)=>{const s=n,r=t.changedParentTypes;for(;_t(r,n,()=>[]).push(e),n._item!==null;)n=n._item.parent;ul(s._eH,e,t)};class Y{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Wi(),this._dEH=Wi(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,e){this.doc=t,this._item=e}_copy(){throw Et()}clone(){throw Et()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,e){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){Ji(this._eH,t)}observeDeep(t){Ji(this._dEH,t)}unobserve(t){Hi(this._eH,t)}unobserveDeep(t){Hi(this._dEH,t)}toJSON(){}}const kl=(n,t,e)=>{n.doc??Z(),t<0&&(t=n._length+t),e<0&&(e=n._length+e);let s=e-t;const r=[];let i=n._start;for(;i!==null&&s>0;){if(i.countable&&!i.deleted){const o=i.content.getContent();if(o.length<=t)t-=o.length;else{for(let l=t;l<o.length&&s>0;l++)r.push(o[l]),s--;t=0}}i=i.right}return r},Cl=n=>{n.doc??Z();const t=[];let e=n._start;for(;e!==null;){if(e.countable&&!e.deleted){const s=e.content.getContent();for(let r=0;r<s.length;r++)t.push(s[r])}e=e.right}return t},_l=(n,t)=>{const e=[];let s=n._start;for(;s!==null;){if(s.countable&&fe(s,t)){const r=s.content.getContent();for(let i=0;i<r.length;i++)e.push(r[i])}s=s.right}return e},Cn=(n,t)=>{let e=0,s=n._start;for(n.doc??Z();s!==null;){if(s.countable&&!s.deleted){const r=s.content.getContent();for(let i=0;i<r.length;i++)t(r[i],e++,n)}s=s.right}},xl=(n,t)=>{const e=[];return Cn(n,(s,r)=>{e.push(t(s,r,n))}),e},Gu=n=>{let t=n._start,e=null,s=0;return{[Symbol.iterator](){return this},next:()=>{if(e===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};e=t.content.getContent(),s=0,t=t.right}const r=e[s++];return e.length<=s&&(e=null),{done:!1,value:r}}}},El=(n,t)=>{n.doc??Z();const e=_s(n,t);let s=n._start;for(e!==null&&(s=e.p,t-=e.index);s!==null;s=s.right)if(!s.deleted&&s.countable){if(t<s.length)return s.content.getContent()[t];t-=s.length}},is=(n,t,e,s)=>{let r=e;const i=n.doc,o=i.clientID,l=i.store,c=e===null?t._start:e.right;let a=[];const h=()=>{a.length>0&&(r=new O(k(o,P(l,o)),r,r&&r.lastId,c,c&&c.id,t,null,new Ae(a)),r.integrate(n,0),a=[])};s.forEach(u=>{if(u===null)a.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:a.push(u);break;default:switch(h(),u.constructor){case Uint8Array:case ArrayBuffer:r=new O(k(o,P(l,o)),r,r&&r.lastId,c,c&&c.id,t,null,new Nn(new Uint8Array(u))),r.integrate(n,0);break;case ae:r=new O(k(o,P(l,o)),r,r&&r.lastId,c,c&&c.id,t,null,new Rn(u)),r.integrate(n,0);break;default:if(u instanceof Y)r=new O(k(o,P(l,o)),r,r&&r.lastId,c,c&&c.id,t,null,new Ot(u)),r.integrate(n,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},Dl=()=>se("Length exceeded!"),Tl=(n,t,e,s)=>{if(e>t._length)throw Dl();if(e===0)return t._searchMarker&&kn(t._searchMarker,e,s.length),is(n,t,null,s);const r=e,i=_s(t,e);let o=t._start;for(i!==null&&(o=i.p,e-=i.index,e===0&&(o=o.prev,e+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(e<=o.length){e<o.length&&lt(n,k(o.id.client,o.id.clock+e));break}e-=o.length}return t._searchMarker&&kn(t._searchMarker,r,s.length),is(n,t,o,s)},Xu=(n,t,e)=>{let r=(t._searchMarker||[]).reduce((i,o)=>o.index>i.index?o:i,{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;return is(n,t,r,e)},Al=(n,t,e,s)=>{if(s===0)return;const r=e,i=s,o=_s(t,e);let l=t._start;for(o!==null&&(l=o.p,e-=o.index);l!==null&&e>0;l=l.right)!l.deleted&&l.countable&&(e<l.length&&lt(n,k(l.id.client,l.id.clock+e)),e-=l.length);for(;s>0&&l!==null;)l.deleted||(s<l.length&&lt(n,k(l.id.client,l.id.clock+s)),l.delete(n),s-=l.length),l=l.right;if(s>0)throw Dl();t._searchMarker&&kn(t._searchMarker,r,-i+s)},os=(n,t,e)=>{const s=t._map.get(e);s!==void 0&&s.delete(n)},ni=(n,t,e,s)=>{const r=t._map.get(e)||null,i=n.doc,o=i.clientID;let l;if(s==null)l=new Ae([s]);else switch(s.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:l=new Ae([s]);break;case Uint8Array:l=new Nn(s);break;case ae:l=new Rn(s);break;default:if(s instanceof Y)l=new Ot(s);else throw new Error("Unexpected content type")}new O(k(o,P(i.store,o)),r,r&&r.lastId,null,null,t,e,l).integrate(n,0)},si=(n,t)=>{n.doc??Z();const e=n._map.get(t);return e!==void 0&&!e.deleted?e.content.getContent()[e.length-1]:void 0},vl=n=>{const t={};return n.doc??Z(),n._map.forEach((e,s)=>{e.deleted||(t[s]=e.content.getContent()[e.length-1])}),t},Ol=(n,t)=>{n.doc??Z();const e=n._map.get(t);return e!==void 0&&!e.deleted},Zu=(n,t)=>{const e={};return n._map.forEach((s,r)=>{let i=s;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;i!==null&&fe(i,t)&&(e[r]=i.content.getContent()[i.length-1])}),e},Wn=n=>(n.doc??Z(),du(n._map.entries(),t=>!t[1].deleted));class Qu extends Cs{}class Be extends Y{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const e=new Be;return e.push(t),e}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Be}clone(){const t=new Be;return t.insert(0,this.toArray().map(e=>e instanceof Y?e.clone():e)),t}get length(){return this.doc??Z(),this._length}_callObserver(t,e){super._callObserver(t,e),xs(this,t,new Qu(this,t))}insert(t,e){this.doc!==null?N(this.doc,s=>{Tl(s,this,t,e)}):this._prelimContent.splice(t,0,...e)}push(t){this.doc!==null?N(this.doc,e=>{Xu(e,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,e=1){this.doc!==null?N(this.doc,s=>{Al(s,this,t,e)}):this._prelimContent.splice(t,e)}get(t){return El(this,t)}toArray(){return Cl(this)}slice(t=0,e=this.length){return kl(this,t,e)}toJSON(){return this.map(t=>t instanceof Y?t.toJSON():t)}map(t){return xl(this,t)}forEach(t){Cn(this,t)}[Symbol.iterator](){return Gu(this)}_write(t){t.writeTypeRef(Ef)}}const tf=n=>new Be;class ef extends Cs{constructor(t,e,s){super(t,e),this.keysChanged=s}}class je extends Y{constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,e){super._integrate(t,e),this._prelimContent.forEach((s,r)=>{this.set(r,s)}),this._prelimContent=null}_copy(){return new je}clone(){const t=new je;return this.forEach((e,s)=>{t.set(s,e instanceof Y?e.clone():e)}),t}_callObserver(t,e){xs(this,t,new ef(this,t,e))}toJSON(){this.doc??Z();const t={};return this._map.forEach((e,s)=>{if(!e.deleted){const r=e.content.getContent()[e.length-1];t[s]=r instanceof Y?r.toJSON():r}}),t}get size(){return[...Wn(this)].length}keys(){return Ws(Wn(this),t=>t[0])}values(){return Ws(Wn(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return Ws(Wn(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this.doc??Z(),this._map.forEach((e,s)=>{e.deleted||t(e.content.getContent()[e.length-1],s,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?N(this.doc,e=>{os(e,this,t)}):this._prelimContent.delete(t)}set(t,e){return this.doc!==null?N(this.doc,s=>{ni(s,this,t,e)}):this._prelimContent.set(t,e),e}get(t){return si(this,t)}has(t){return Ol(this,t)}clear(){this.doc!==null?N(this.doc,t=>{this.forEach(function(e,s,r){os(t,r,s)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(Df)}}const nf=n=>new je,Qt=(n,t)=>n===t||typeof n=="object"&&typeof t=="object"&&n&&t&&zh(n,t);class dr{constructor(t,e,s,r){this.left=t,this.right=e,this.index=s,this.currentAttributes=r}forward(){switch(this.right===null&&dt(),this.right.content.constructor){case W:this.right.deleted||Qe(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const Zi=(n,t,e)=>{for(;t.right!==null&&e>0;){switch(t.right.content.constructor){case W:t.right.deleted||Qe(t.currentAttributes,t.right.content);break;default:t.right.deleted||(e<t.right.length&&lt(n,k(t.right.id.client,t.right.id.clock+e)),t.index+=t.right.length,e-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},Jn=(n,t,e,s)=>{const r=new Map,i=s?_s(t,e):null;if(i){const o=new dr(i.p.left,i.p,i.index,r);return Zi(n,o,e-i.index)}else{const o=new dr(null,t._start,0,r);return Zi(n,o,e)}},Il=(n,t,e,s)=>{for(;e.right!==null&&(e.right.deleted===!0||e.right.content.constructor===W&&Qt(s.get(e.right.content.key),e.right.content.value));)e.right.deleted||s.delete(e.right.content.key),e.forward();const r=n.doc,i=r.clientID;s.forEach((o,l)=>{const c=e.left,a=e.right,h=new O(k(i,P(r.store,i)),c,c&&c.lastId,a,a&&a.id,t,null,new W(l,o));h.integrate(n,0),e.right=h,e.forward()})},Qe=(n,t)=>{const{key:e,value:s}=t;s===null?n.delete(e):n.set(e,s)},Ml=(n,t)=>{for(;n.right!==null;){if(!(n.right.deleted||n.right.content.constructor===W&&Qt(t[n.right.content.key]??null,n.right.content.value)))break;n.forward()}},Nl=(n,t,e,s)=>{const r=n.doc,i=r.clientID,o=new Map;for(const l in s){const c=s[l],a=e.currentAttributes.get(l)??null;if(!Qt(a,c)){o.set(l,a);const{left:h,right:u}=e;e.right=new O(k(i,P(r.store,i)),h,h&&h.lastId,u,u&&u.id,t,null,new W(l,c)),e.right.integrate(n,0),e.forward()}}return o},qs=(n,t,e,s,r)=>{e.currentAttributes.forEach((f,d)=>{r[d]===void 0&&(r[d]=null)});const i=n.doc,o=i.clientID;Ml(e,r);const l=Nl(n,t,e,r),c=s.constructor===String?new vt(s):s instanceof Y?new Ot(s):new ve(s);let{left:a,right:h,index:u}=e;t._searchMarker&&kn(t._searchMarker,e.index,c.getLength()),h=new O(k(o,P(i.store,o)),a,a&&a.lastId,h,h&&h.id,t,null,c),h.integrate(n,0),e.right=h,e.index=u,e.forward(),Il(n,t,e,l)},Qi=(n,t,e,s,r)=>{const i=n.doc,o=i.clientID;Ml(e,r);const l=Nl(n,t,e,r);t:for(;e.right!==null&&(s>0||l.size>0&&(e.right.deleted||e.right.content.constructor===W));){if(!e.right.deleted)switch(e.right.content.constructor){case W:{const{key:c,value:a}=e.right.content,h=r[c];if(h!==void 0){if(Qt(h,a))l.delete(c);else{if(s===0)break t;l.set(c,a)}e.right.delete(n)}else e.currentAttributes.set(c,a);break}default:s<e.right.length&&lt(n,k(e.right.id.client,e.right.id.clock+s)),s-=e.right.length;break}e.forward()}if(s>0){let c="";for(;s>0;s--)c+=`
`;e.right=new O(k(o,P(i.store,o)),e.left,e.left&&e.left.lastId,e.right,e.right&&e.right.id,t,null,new vt(c)),e.right.integrate(n,0),e.forward()}Il(n,t,e,l)},Rl=(n,t,e,s,r)=>{let i=t;const o=rt();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===W){const a=i.content;o.set(a.key,a)}i=i.right}let l=0,c=!1;for(;t!==i;){if(e===t&&(c=!0),!t.deleted){const a=t.content;switch(a.constructor){case W:{const{key:h,value:u}=a,f=s.get(h)??null;(o.get(h)!==a||f===u)&&(t.delete(n),l++,!c&&(r.get(h)??null)===u&&f!==u&&(f===null?r.delete(h):r.set(h,f))),!c&&!t.deleted&&Qe(r,a);break}}}t=t.right}return l},sf=(n,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const e=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===W){const s=t.content.key;e.has(s)?t.delete(n):e.add(s)}t=t.left}},rf=n=>{let t=0;return N(n.doc,e=>{let s=n._start,r=n._start,i=rt();const o=rr(i);for(;r;){if(r.deleted===!1)switch(r.content.constructor){case W:Qe(o,r.content);break;default:t+=Rl(e,s,r,i,o),i=rr(o),s=r;break}r=r.right}}),t},of=n=>{const t=new Set,e=n.doc;for(const[s,r]of n.afterState.entries()){const i=n.beforeState.get(s)||0;r!==i&&gl(n,e.store.clients.get(s),i,r,o=>{!o.deleted&&o.content.constructor===W&&o.constructor!==St&&t.add(o.parent)})}N(e,s=>{oe(n,n.deleteSet,r=>{if(r instanceof St||!r.parent._hasFormatting||t.has(r.parent))return;const i=r.parent;r.content.constructor===W?t.add(i):sf(s,r)});for(const r of t)rf(r)})},to=(n,t,e)=>{const s=e,r=rr(t.currentAttributes),i=t.right;for(;e>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case Ot:case ve:case vt:e<t.right.length&&lt(n,k(t.right.id.client,t.right.id.clock+e)),e-=t.right.length,t.right.delete(n);break}t.forward()}i&&Rl(n,i,t.right,r,t.currentAttributes);const o=(t.left||t.right).parent;return o._searchMarker&&kn(o._searchMarker,t.index,-s+e),t};class lf extends Cs{constructor(t,e,s){super(t,e),this.childListChanged=!1,this.keysChanged=new Set,s.forEach(r=>{r===null?this.childListChanged=!0:this.keysChanged.add(r)})}get changes(){if(this._changes===null){const t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){const t=this.target.doc,e=[];N(t,s=>{const r=new Map,i=new Map;let o=this.target._start,l=null;const c={};let a="",h=0,u=0;const f=()=>{if(l!==null){let d=null;switch(l){case"delete":u>0&&(d={delete:u}),u=0;break;case"insert":(typeof a=="object"||a.length>0)&&(d={insert:a},r.size>0&&(d.attributes={},r.forEach((p,g)=>{p!==null&&(d.attributes[g]=p)}))),a="";break;case"retain":h>0&&(d={retain:h},Fh(c)||(d.attributes=Nh({},c))),h=0;break}d&&e.push(d),l=null}};for(;o!==null;){switch(o.content.constructor){case Ot:case ve:this.adds(o)?this.deletes(o)||(f(),l="insert",a=o.content.getContent()[0],f()):this.deletes(o)?(l!=="delete"&&(f(),l="delete"),u+=1):o.deleted||(l!=="retain"&&(f(),l="retain"),h+=1);break;case vt:this.adds(o)?this.deletes(o)||(l!=="insert"&&(f(),l="insert"),a+=o.content.str):this.deletes(o)?(l!=="delete"&&(f(),l="delete"),u+=o.length):o.deleted||(l!=="retain"&&(f(),l="retain"),h+=o.length);break;case W:{const{key:d,value:p}=o.content;if(this.adds(o)){if(!this.deletes(o)){const g=r.get(d)??null;Qt(g,p)?p!==null&&o.delete(s):(l==="retain"&&f(),Qt(p,i.get(d)??null)?delete c[d]:c[d]=p)}}else if(this.deletes(o)){i.set(d,p);const g=r.get(d)??null;Qt(g,p)||(l==="retain"&&f(),c[d]=g)}else if(!o.deleted){i.set(d,p);const g=c[d];g!==void 0&&(Qt(g,p)?g!==null&&o.delete(s):(l==="retain"&&f(),p===null?delete c[d]:c[d]=p))}o.deleted||(l==="insert"&&f(),Qe(r,o.content));break}}o=o.right}for(f();e.length>0;){const d=e[e.length-1];if(d.retain!==void 0&&d.attributes===void 0)e.pop();else break}}),this._delta=e}return this._delta}}class le extends Y{constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Z(),this._length}_integrate(t,e){super._integrate(t,e);try{this._pending.forEach(s=>s())}catch(s){console.error(s)}this._pending=null}_copy(){return new le}clone(){const t=new le;return t.applyDelta(this.toDelta()),t}_callObserver(t,e){super._callObserver(t,e);const s=new lf(this,t,e);xs(this,t,s),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){this.doc??Z();let t="",e=this._start;for(;e!==null;)!e.deleted&&e.countable&&e.content.constructor===vt&&(t+=e.content.str),e=e.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:e=!0}={}){this.doc!==null?N(this.doc,s=>{const r=new dr(null,this._start,0,new Map);for(let i=0;i<t.length;i++){const o=t[i];if(o.insert!==void 0){const l=!e&&typeof o.insert=="string"&&i===t.length-1&&r.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof l!="string"||l.length>0)&&qs(s,this,r,l,o.attributes||{})}else o.retain!==void 0?Qi(s,this,r,o.retain,o.attributes||{}):o.delete!==void 0&&to(s,r,o.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,e,s){this.doc??Z();const r=[],i=new Map,o=this.doc;let l="",c=this._start;function a(){if(l.length>0){const u={};let f=!1;i.forEach((p,g)=>{f=!0,u[g]=p});const d={insert:l};f&&(d.attributes=u),r.push(d),l=""}}const h=()=>{for(;c!==null;){if(fe(c,t)||e!==void 0&&fe(c,e))switch(c.content.constructor){case vt:{const u=i.get("ychange");t!==void 0&&!fe(c,t)?(u===void 0||u.user!==c.id.client||u.type!=="removed")&&(a(),i.set("ychange",s?s("removed",c.id):{type:"removed"})):e!==void 0&&!fe(c,e)?(u===void 0||u.user!==c.id.client||u.type!=="added")&&(a(),i.set("ychange",s?s("added",c.id):{type:"added"})):u!==void 0&&(a(),i.delete("ychange")),l+=c.content.str;break}case Ot:case ve:{a();const u={insert:c.content.getContent()[0]};if(i.size>0){const f={};u.attributes=f,i.forEach((d,p)=>{f[p]=d})}r.push(u);break}case W:fe(c,t)&&(a(),Qe(i,c.content));break}c=c.right}a()};return t||e?N(o,u=>{t&&ur(u,t),e&&ur(u,e),h()},"cleanup"):h(),r}insert(t,e,s){if(e.length<=0)return;const r=this.doc;r!==null?N(r,i=>{const o=Jn(i,this,t,!s);s||(s={},o.currentAttributes.forEach((l,c)=>{s[c]=l})),qs(i,this,o,e,s)}):this._pending.push(()=>this.insert(t,e,s))}insertEmbed(t,e,s){const r=this.doc;r!==null?N(r,i=>{const o=Jn(i,this,t,!s);qs(i,this,o,e,s||{})}):this._pending.push(()=>this.insertEmbed(t,e,s||{}))}delete(t,e){if(e===0)return;const s=this.doc;s!==null?N(s,r=>{to(r,Jn(r,this,t,!0),e)}):this._pending.push(()=>this.delete(t,e))}format(t,e,s){if(e===0)return;const r=this.doc;r!==null?N(r,i=>{const o=Jn(i,this,t,!1);o.right!==null&&Qi(i,this,o,e,s)}):this._pending.push(()=>this.format(t,e,s))}removeAttribute(t){this.doc!==null?N(this.doc,e=>{os(e,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,e){this.doc!==null?N(this.doc,s=>{ni(s,this,t,e)}):this._pending.push(()=>this.setAttribute(t,e))}getAttribute(t){return si(this,t)}getAttributes(){return vl(this)}_write(t){t.writeTypeRef(Tf)}}const cf=n=>new le;class Ks{constructor(t,e=()=>!0){this._filter=e,this._root=t,this._currentNode=t._start,this._firstCall=!0,t.doc??Z()}[Symbol.iterator](){return this}next(){let t=this._currentNode,e=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(e)))do if(e=t.content.type,!t.deleted&&(e.constructor===st||e.constructor===Te)&&e._start!==null)t=e._start;else for(;t!==null;){const s=t.next;if(s!==null){t=s;break}else t.parent===this._root?t=null:t=t.parent._item}while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}}class Te extends Y{constructor(){super(),this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Te}clone(){const t=new Te;return t.insert(0,this.toArray().map(e=>e instanceof Y?e.clone():e)),t}get length(){return this.doc??Z(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new Ks(this,t)}querySelector(t){t=t.toUpperCase();const s=new Ks(this,r=>r.nodeName&&r.nodeName.toUpperCase()===t).next();return s.done?null:s.value}querySelectorAll(t){return t=t.toUpperCase(),$t(new Ks(this,e=>e.nodeName&&e.nodeName.toUpperCase()===t))}_callObserver(t,e){xs(this,t,new uf(this,e,t))}toString(){return xl(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,e={},s){const r=t.createDocumentFragment();return s!==void 0&&s._createAssociation(r,this),Cn(this,i=>{r.insertBefore(i.toDOM(t,e,s),null)}),r}insert(t,e){this.doc!==null?N(this.doc,s=>{Tl(s,this,t,e)}):this._prelimContent.splice(t,0,...e)}insertAfter(t,e){if(this.doc!==null)N(this.doc,s=>{const r=t&&t instanceof Y?t._item:t;is(s,this,r,e)});else{const s=this._prelimContent,r=t===null?0:s.findIndex(i=>i===t)+1;if(r===0&&t!==null)throw se("Reference item not found");s.splice(r,0,...e)}}delete(t,e=1){this.doc!==null?N(this.doc,s=>{Al(s,this,t,e)}):this._prelimContent.splice(t,e)}toArray(){return Cl(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return El(this,t)}slice(t=0,e=this.length){return kl(this,t,e)}forEach(t){Cn(this,t)}_write(t){t.writeTypeRef(vf)}}const af=n=>new Te;class st extends Te{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,e){super._integrate(t,e),this._prelimAttrs.forEach((s,r)=>{this.setAttribute(r,s)}),this._prelimAttrs=null}_copy(){return new st(this.nodeName)}clone(){const t=new st(this.nodeName),e=this.getAttributes();return Rh(e,(s,r)=>{typeof s=="string"&&t.setAttribute(r,s)}),t.insert(0,this.toArray().map(s=>s instanceof Y?s.clone():s)),t}toString(){const t=this.getAttributes(),e=[],s=[];for(const l in t)s.push(l);s.sort();const r=s.length;for(let l=0;l<r;l++){const c=s[l];e.push(c+'="'+t[c]+'"')}const i=this.nodeName.toLocaleLowerCase(),o=e.length>0?" "+e.join(" "):"";return`<${i}${o}>${super.toString()}</${i}>`}removeAttribute(t){this.doc!==null?N(this.doc,e=>{os(e,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,e){this.doc!==null?N(this.doc,s=>{ni(s,this,t,e)}):this._prelimAttrs.set(t,e)}getAttribute(t){return si(this,t)}hasAttribute(t){return Ol(this,t)}getAttributes(t){return t?Zu(this,t):vl(this)}toDOM(t=document,e={},s){const r=t.createElement(this.nodeName),i=this.getAttributes();for(const o in i){const l=i[o];typeof l=="string"&&r.setAttribute(o,l)}return Cn(this,o=>{r.appendChild(o.toDOM(t,e,s))}),s!==void 0&&s._createAssociation(r,this),r}_write(t){t.writeTypeRef(Af),t.writeKey(this.nodeName)}}const hf=n=>new st(n.readKey());class uf extends Cs{constructor(t,e,s){super(t,s),this.childListChanged=!1,this.attributesChanged=new Set,e.forEach(r=>{r===null?this.childListChanged=!0:this.attributesChanged.add(r)})}}class ls extends je{constructor(t){super(),this.hookName=t}_copy(){return new ls(this.hookName)}clone(){const t=new ls(this.hookName);return this.forEach((e,s)=>{t.set(s,e)}),t}toDOM(t=document,e={},s){const r=e[this.hookName];let i;return r!==void 0?i=r.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),s!==void 0&&s._createAssociation(i,this),i}_write(t){t.writeTypeRef(Of),t.writeKey(this.hookName)}}const ff=n=>new ls(n.readKey());class ft extends le{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new ft}clone(){const t=new ft;return t.applyDelta(this.toDelta()),t}toDOM(t=document,e,s){const r=t.createTextNode(this.toString());return s!==void 0&&s._createAssociation(r,this),r}toString(){return this.toDelta().map(t=>{const e=[];for(const r in t.attributes){const i=[];for(const o in t.attributes[r])i.push({key:o,value:t.attributes[r][o]});i.sort((o,l)=>o.key<l.key?-1:1),e.push({nodeName:r,attrs:i})}e.sort((r,i)=>r.nodeName<i.nodeName?-1:1);let s="";for(let r=0;r<e.length;r++){const i=e[r];s+=`<${i.nodeName}`;for(let o=0;o<i.attrs.length;o++){const l=i.attrs[o];s+=` ${l.key}="${l.value}"`}s+=">"}s+=t.insert;for(let r=e.length-1;r>=0;r--)s+=`</${e[r].nodeName}>`;return s}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(If)}}const df=n=>new ft;class ri{constructor(t,e){this.id=t,this.length=e}get deleted(){throw Et()}mergeWith(t){return!1}write(t,e,s){throw Et()}integrate(t,e){throw Et()}}const pf=0;class St extends ri{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){e>0&&(this.id.clock+=e,this.length-=e),pl(t.doc.store,this)}write(t,e){t.writeInfo(pf),t.writeLen(this.length-e)}getMissing(t,e){return null}}class Nn{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new Nn(this.content)}splice(t){throw Et()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeBuf(this.content)}getRef(){return 3}}const gf=n=>new Nn(n.readBuf());class _n{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new _n(this.len)}splice(t){const e=new _n(this.len-t);return this.len=t,e}mergeWith(t){return this.len+=t.len,!0}integrate(t,e){yn(t.deleteSet,e.id.client,e.id.clock,this.len),e.markDeleted()}delete(t){}gc(t){}write(t,e){t.writeLen(this.len-e)}getRef(){return 1}}const mf=n=>new _n(n.readLen()),Ll=(n,t)=>new ae({guid:n,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});class Rn{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const e={};this.opts=e,t.gc||(e.gc=!1),t.autoLoad&&(e.autoLoad=!0),t.meta!==null&&(e.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new Rn(Ll(this.doc.guid,this.opts))}splice(t){throw Et()}mergeWith(t){return!1}integrate(t,e){this.doc._item=e,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,e){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}const yf=n=>new Rn(Ll(n.readString(),n.readAny()));class ve{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new ve(this.embed)}splice(t){throw Et()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeJSON(this.embed)}getRef(){return 5}}const bf=n=>new ve(n.readJSON());class W{constructor(t,e){this.key=t,this.value=e}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new W(this.key,this.value)}splice(t){throw Et()}mergeWith(t){return!1}integrate(t,e){const s=e.parent;s._searchMarker=null,s._hasFormatting=!0}delete(t){}gc(t){}write(t,e){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}const wf=n=>new W(n.readKey(),n.readJSON());class cs{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new cs(this.arr)}splice(t){const e=new cs(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){const s=this.arr.length;t.writeLen(s-e);for(let r=e;r<s;r++){const i=this.arr[r];t.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const Sf=n=>{const t=n.readLen(),e=[];for(let s=0;s<t;s++){const r=n.readString();r==="undefined"?e.push(void 0):e.push(JSON.parse(r))}return new cs(e)},kf=ns("node_env")==="development";class Ae{constructor(t){this.arr=t,kf&&Ho(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ae(this.arr)}splice(t){const e=new Ae(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){const s=this.arr.length;t.writeLen(s-e);for(let r=e;r<s;r++){const i=this.arr[r];t.writeAny(i)}}getRef(){return 8}}const Cf=n=>{const t=n.readLen(),e=[];for(let s=0;s<t;s++)e.push(n.readAny());return new Ae(e)};class vt{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new vt(this.str)}splice(t){const e=new vt(this.str.slice(t));this.str=this.str.slice(0,t);const s=this.str.charCodeAt(t-1);return s>=55296&&s<=56319&&(this.str=this.str.slice(0,t-1)+"�",e.str="�"+e.str.slice(1)),e}mergeWith(t){return this.str+=t.str,!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeString(e===0?this.str:this.str.slice(e))}getRef(){return 4}}const _f=n=>new vt(n.readString()),xf=[tf,nf,cf,hf,af,ff,df],Ef=0,Df=1,Tf=2,Af=3,vf=4,Of=5,If=6;class Ot{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Ot(this.type._copy())}splice(t){throw Et()}mergeWith(t){return!1}integrate(t,e){this.type._integrate(t.doc,e)}delete(t){let e=this.type._start;for(;e!==null;)e.deleted?e.id.clock<(t.beforeState.get(e.id.client)||0)&&t._mergeStructs.push(e):e.delete(t),e=e.right;this.type._map.forEach(s=>{s.deleted?s.id.clock<(t.beforeState.get(s.id.client)||0)&&t._mergeStructs.push(s):s.delete(t)}),t.changed.delete(this.type)}gc(t){let e=this.type._start;for(;e!==null;)e.gc(t,!0),e=e.right;this.type._start=null,this.type._map.forEach(s=>{for(;s!==null;)s.gc(t,!0),s=s.left}),this.type._map=new Map}write(t,e){this.type._write(t)}getRef(){return 7}}const Mf=n=>new Ot(xf[n.readTypeRef()](n)),pr=(n,t)=>{let e=t,s=0,r;do s>0&&(e=k(e.client,e.clock+s)),r=Pe(n,e),s=e.clock-r.id.clock,e=r.redone;while(e!==null&&r instanceof O);return{item:r,diff:s}},ii=(n,t)=>{for(;n!==null&&n.keep!==t;)n.keep=t,n=n.parent._item},as=(n,t,e)=>{const{client:s,clock:r}=t.id,i=new O(k(s,r+e),t,k(s,r+e-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),t.redone!==null&&(i.redone=k(t.redone.client,t.redone.clock+e)),t.right=i,i.right!==null&&(i.right.left=i),n._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),t.length=e,i},eo=(n,t)=>Ka(n,e=>Xe(e.deletions,t)),Fl=(n,t,e,s,r,i)=>{const o=n.doc,l=o.store,c=o.clientID,a=t.redone;if(a!==null)return lt(n,a);let h=t.parent._item,u=null,f;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!e.has(h)||Fl(n,h,e,s,r,i)===null))return null;for(;h.redone!==null;)h=lt(n,h.redone)}const d=h===null?t.parent:h.content.type;if(t.parentSub===null){for(u=t.left,f=t;u!==null;){let y=u;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:lt(n,y.redone);if(y!==null&&y.parent._item===h){u=y;break}u=u.left}for(;f!==null;){let y=f;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:lt(n,y.redone);if(y!==null&&y.parent._item===h){f=y;break}f=f.right}}else if(f=null,t.right&&!r){for(u=t;u!==null&&u.right!==null&&(u.right.redone||Xe(s,u.right.id)||eo(i.undoStack,u.right.id)||eo(i.redoStack,u.right.id));)for(u=u.right;u.redone;)u=lt(n,u.redone);if(u&&u.right!==null)return null}else u=d._map.get(t.parentSub)||null;const p=P(l,c),g=k(c,p),m=new O(g,u,u&&u.lastId,f,f&&f.id,d,t.parentSub,t.content.copy());return t.redone=g,ii(m,!0),m.integrate(n,0),m};class O extends ri{constructor(t,e,s,r,i,o,l,c){super(t,c.getLength()),this.origin=s,this.left=e,this.right=r,this.rightOrigin=i,this.parent=o,this.parentSub=l,this.redone=null,this.content=c,this.info=this.content.isCountable()?vi:0}set marker(t){(this.info&Vs)>0!==t&&(this.info^=Vs)}get marker(){return(this.info&Vs)>0}get keep(){return(this.info&Ai)>0}set keep(t){this.keep!==t&&(this.info^=Ai)}get countable(){return(this.info&vi)>0}get deleted(){return(this.info&Us)>0}set deleted(t){this.deleted!==t&&(this.info^=Us)}markDeleted(){this.info|=Us}getMissing(t,e){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=P(e,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=P(e,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ve&&this.id.client!==this.parent.client&&this.parent.clock>=P(e,this.parent.client))return this.parent.client;if(this.origin&&(this.left=Ki(t,e,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=lt(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===St||this.right&&this.right.constructor===St)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===O?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===O&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ve){const s=Pe(e,this.parent);s.constructor===St?this.parent=null:this.parent=s.content.type}return null}integrate(t,e){if(e>0&&(this.id.clock+=e,this.left=Ki(t,t.doc.store,k(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(e),this.length-=e),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let s=this.left,r;if(s!==null)r=s.right;else if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start;const i=new Set,o=new Set;for(;r!==null&&r!==this.right;){if(o.add(r),i.add(r),Ue(this.origin,r.origin)){if(r.id.client<this.id.client)s=r,i.clear();else if(Ue(this.rightOrigin,r.rightOrigin))break}else if(r.origin!==null&&o.has(Pe(t.doc.store,r.origin)))i.has(Pe(t.doc.store,r.origin))||(s=r,i.clear());else break;r=r.right}this.left=s}if(this.left!==null){const s=this.left.right;this.right=s,this.left.right=this}else{let s;if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start,this.parent._start=this;this.right=s}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),pl(t.doc.store,this),this.content.integrate(t,this),$i(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new St(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:k(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&Ue(t.origin,this.lastId)&&this.right===t&&Ue(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const e=this.parent._searchMarker;return e&&e.forEach(s=>{s.p===t&&(s.p=this,!this.deleted&&this.countable&&(s.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const e=this.parent;this.countable&&this.parentSub===null&&(e._length-=this.length),this.markDeleted(),yn(t.deleteSet,this.id.client,this.id.clock,this.length),$i(t,e,this.parentSub),this.content.delete(t)}}gc(t,e){if(!this.deleted)throw dt();this.content.gc(t),e?Lu(t,this,new St(this.id,this.length)):this.content=new _n(this.length)}write(t,e){const s=e>0?k(this.id.client,this.id.clock+e-1):this.origin,r=this.rightOrigin,i=this.parentSub,o=this.content.getRef()&ws|(s===null?0:it)|(r===null?0:Kt)|(i===null?0:pn);if(t.writeInfo(o),s!==null&&t.writeLeftID(s),r!==null&&t.writeRightID(r),s===null&&r===null){const l=this.parent;if(l._item!==void 0){const c=l._item;if(c===null){const a=bn(l);t.writeParentInfo(!0),t.writeString(a)}else t.writeParentInfo(!1),t.writeLeftID(c.id)}else l.constructor===String?(t.writeParentInfo(!0),t.writeString(l)):l.constructor===Ve?(t.writeParentInfo(!1),t.writeLeftID(l)):dt();i!==null&&t.writeString(i)}this.content.write(t,e)}}const zl=(n,t)=>Nf[t&ws](n),Nf=[()=>{dt()},mf,Sf,gf,_f,bf,wf,Mf,Cf,yf,()=>{dt()}],Rf=10;class kt extends ri{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){dt()}write(t,e){t.writeInfo(Rf),w(t.restEncoder,this.length-e)}getMissing(t,e){return null}}const Ul=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},Vl="__ $YJS$ __";Ul[Vl]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Ul[Vl]=!0;const Pl=new Map;class Lf{constructor(t){this.room=t,this.onmessage=null,this._onChange=e=>e.key===t&&this.onmessage!==null&&this.onmessage({data:Gh(e.newValue||"")}),Ih(this._onChange)}postMessage(t){Bo.setItem(this.room,$o(qh(t)))}close(){Mh(this._onChange)}}const Ff=typeof BroadcastChannel>"u"?Lf:BroadcastChannel,oi=n=>_t(Pl,n,()=>{const t=Yt(),e=new Ff(n);return e.onmessage=s=>t.forEach(r=>r(s.data,"broadcastchannel")),{bc:e,subs:t}}),zf=(n,t)=>(oi(n).subs.add(t),t),Uf=(n,t)=>{const e=oi(n),s=e.subs.delete(t);return s&&e.subs.size===0&&(e.bc.close(),Pl.delete(n)),s},Le=(n,t,e=null)=>{const s=oi(n);s.bc.postMessage(t),s.subs.forEach(r=>r(t,e))},Bl=0,li=1,Wl=2,gr=(n,t)=>{w(n,Bl);const e=Au(t);V(n,e)},Jl=(n,t,e)=>{w(n,li),V(n,xu(t,e))},Vf=(n,t,e)=>Jl(t,e,X(n)),Hl=(n,t,e)=>{try{ku(t,X(n),e)}catch(s){console.error("Caught error while handling a Yjs update",s)}},Pf=(n,t)=>{w(n,Wl),V(n,t)},Bf=Hl,Wf=(n,t,e,s)=>{const r=S(n);switch(r){case Bl:Vf(n,t,e);break;case li:Hl(n,e,s);break;case Wl:Bf(n,e,s);break;default:throw new Error("Unknown message type")}return r},Jf=0,Hf=(n,t,e)=>{switch(S(n)){case Jf:e(t,ee(n))}},Ys=3e4;class qf extends Ya{constructor(t){super(),this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=re();this.getLocalState()!==null&&Ys/2<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const s=[];this.meta.forEach((r,i)=>{i!==this.clientID&&Ys<=e-r.lastUpdated&&this.states.has(i)&&s.push(i)}),s.length>0&&ci(this,s,"timeout")},zt(Ys/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){const e=this.clientID,s=this.meta.get(e),r=s===void 0?0:s.clock+1,i=this.states.get(e);t===null?this.states.delete(e):this.states.set(e,t),this.meta.set(e,{clock:r,lastUpdated:re()});const o=[],l=[],c=[],a=[];t===null?a.push(e):i==null?t!=null&&o.push(e):(l.push(e),ln(i,t)||c.push(e)),(o.length>0||c.length>0||a.length>0)&&this.emit("change",[{added:o,updated:c,removed:a},"local"]),this.emit("update",[{added:o,updated:l,removed:a},"local"])}setLocalStateField(t,e){const s=this.getLocalState();s!==null&&this.setLocalState({...s,[t]:e})}getStates(){return this.states}}const ci=(n,t,e)=>{const s=[];for(let r=0;r<t.length;r++){const i=t[r];if(n.states.has(i)){if(n.states.delete(i),i===n.clientID){const o=n.meta.get(i);n.meta.set(i,{clock:o.clock+1,lastUpdated:re()})}s.push(i)}}s.length>0&&(n.emit("change",[{added:[],updated:[],removed:s},e]),n.emit("update",[{added:[],updated:[],removed:s},e]))},an=(n,t,e=n.states)=>{const s=t.length,r=$();w(r,s);for(let i=0;i<s;i++){const o=t[i],l=e.get(o)||null,c=n.meta.get(o).clock;w(r,o),w(r,c),_e(r,JSON.stringify(l))}return R(r)},Kf=(n,t,e)=>{const s=ce(t),r=re(),i=[],o=[],l=[],c=[],a=S(s);for(let h=0;h<a;h++){const u=S(s);let f=S(s);const d=JSON.parse(ee(s)),p=n.meta.get(u),g=n.states.get(u),m=p===void 0?0:p.clock;(m<f||m===f&&d===null&&n.states.has(u))&&(d===null?u===n.clientID&&n.getLocalState()!=null?f++:n.states.delete(u):n.states.set(u,d),n.meta.set(u,{clock:f,lastUpdated:r}),p===void 0&&d!==null?i.push(u):p!==void 0&&d===null?c.push(u):d!==null&&(ln(d,g)||l.push(u),o.push(u)))}(i.length>0||l.length>0||c.length>0)&&n.emit("change",[{added:i,updated:l,removed:c},e]),(i.length>0||o.length>0||c.length>0)&&n.emit("update",[{added:i,updated:o,removed:c},e])},Yf=n=>Lh(n,(t,e)=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&"),ge=0,ql=3,We=1,$f=2,Ln=[];Ln[ge]=(n,t,e,s,r)=>{w(n,ge);const i=Wf(t,n,e.doc,e);s&&i===li&&!e.synced&&(e.synced=!0)};Ln[ql]=(n,t,e,s,r)=>{w(n,We),V(n,an(e.awareness,Array.from(e.awareness.getStates().keys())))};Ln[We]=(n,t,e,s,r)=>{Kf(e.awareness,X(t),e)};Ln[$f]=(n,t,e,s,r)=>{Hf(t,e.doc,(i,o)=>jf(e,o))};const no=3e4,jf=(n,t)=>console.warn(`Permission denied to access ${n.url}.
${t}`),Kl=(n,t,e)=>{const s=ce(t),r=$(),i=S(s),o=n.messageHandlers[i];return o?o(r,s,n,e,i):console.error("Unable to compute message"),r},mr=(n,t,e)=>{t===n.ws&&(n.emit("connection-close",[e,n]),n.ws=null,t.close(),n.wsconnecting=!1,n.wsconnected?(n.wsconnected=!1,n.synced=!1,ci(n.awareness,Array.from(n.awareness.getStates().keys()).filter(s=>s!==n.doc.clientID),n),n.emit("status",[{status:"disconnected"}])):n.wsUnsuccessfulReconnects++,setTimeout(Yl,Lt($a(2,n.wsUnsuccessfulReconnects)*100,n.maxBackoffTime),n))},Yl=n=>{if(n.shouldConnect&&n.ws===null){const t=new n._WS(n.url,n.protocols);t.binaryType="arraybuffer",n.ws=t,n.wsconnecting=!0,n.wsconnected=!1,n.synced=!1,t.onmessage=e=>{n.wsLastMessageReceived=re();const s=Kl(n,new Uint8Array(e.data),!0);Fr(s)>1&&t.send(R(s))},t.onerror=e=>{n.emit("connection-error",[e,n])},t.onclose=e=>{mr(n,t,e)},t.onopen=()=>{n.wsLastMessageReceived=re(),n.wsconnecting=!1,n.wsconnected=!0,n.wsUnsuccessfulReconnects=0,n.emit("status",[{status:"connected"}]);const e=$();if(w(e,ge),gr(e,n.doc),t.send(R(e)),n.awareness.getLocalState()!==null){const s=$();w(s,We),V(s,an(n.awareness,[n.doc.clientID])),t.send(R(s))}},n.emit("status",[{status:"connecting"}])}},$s=(n,t)=>{const e=n.ws;n.wsconnected&&e&&e.readyState===e.OPEN&&e.send(t),n.bcconnected&&Le(n.bcChannel,t,n)};class Gf extends Lr{constructor(t,e,s,{connect:r=!0,awareness:i=new qf(s),params:o={},protocols:l=[],WebSocketPolyfill:c=WebSocket,resyncInterval:a=-1,maxBackoffTime:h=2500,disableBc:u=!1}={}){for(super();t[t.length-1]==="/";)t=t.slice(0,t.length-1);this.serverUrl=t,this.bcChannel=t+"/"+e,this.maxBackoffTime=h,this.params=o,this.protocols=l,this.roomname=e,this.doc=s,this._WS=c,this.awareness=i,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=u,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Ln.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=r,this._resyncInterval=0,a>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const f=$();w(f,ge),gr(f,s),this.ws.send(R(f))}},a)),this._bcSubscriber=(f,d)=>{if(d!==this){const p=Kl(this,new Uint8Array(f),!1);Fr(p)>1&&Le(this.bcChannel,R(p),this)}},this._updateHandler=(f,d)=>{if(d!==this){const p=$();w(p,ge),Pf(p,f),$s(this,R(p))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:f,updated:d,removed:p},g)=>{const m=f.concat(d).concat(p),y=$();w(y,We),V(y,an(i,m)),$s(this,R(y))},this._exitHandler=()=>{ci(this.awareness,[s.clientID],"app closed")},ie&&typeof process<"u"&&process.on("exit",this._exitHandler),i.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&no<re()-this.wsLastMessageReceived&&mr(this,this.ws,null)},no/10),r&&this.connect()}get url(){const t=Yf(this.params);return this.serverUrl+"/"+this.roomname+(t.length===0?"":"?"+t)}get synced(){return this._synced}set synced(t){this._synced!==t&&(this._synced=t,this.emit("synced",[t]),this.emit("sync",[t]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),ie&&typeof process<"u"&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||(zf(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);const t=$();w(t,ge),gr(t,this.doc),Le(this.bcChannel,R(t),this);const e=$();w(e,ge),Jl(e,this.doc),Le(this.bcChannel,R(e),this);const s=$();w(s,ql),Le(this.bcChannel,R(s),this);const r=$();w(r,We),V(r,an(this.awareness,[this.doc.clientID])),Le(this.bcChannel,R(r),this)}disconnectBc(){const t=$();w(t,We),V(t,an(this.awareness,[this.doc.clientID],new Map)),$s(this,R(t)),this.bcconnected&&(Uf(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&mr(this,this.ws,null)}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(Yl(this),this.connectBc())}}function $l(n,t,e){for(let s=0;;s++){if(s==n.childCount||s==t.childCount)return n.childCount==t.childCount?null:e;let r=n.child(s),i=t.child(s);if(r==i){e+=r.nodeSize;continue}if(!r.sameMarkup(i))return e;if(r.isText&&r.text!=i.text){for(let o=0;r.text[o]==i.text[o];o++)e++;return e}if(r.content.size||i.content.size){let o=$l(r.content,i.content,e+1);if(o!=null)return o}e+=r.nodeSize}}function jl(n,t,e,s){for(let r=n.childCount,i=t.childCount;;){if(r==0||i==0)return r==i?null:{a:e,b:s};let o=n.child(--r),l=t.child(--i),c=o.nodeSize;if(o==l){e-=c,s-=c;continue}if(!o.sameMarkup(l))return{a:e,b:s};if(o.isText&&o.text!=l.text){let a=0,h=Math.min(o.text.length,l.text.length);for(;a<h&&o.text[o.text.length-a-1]==l.text[l.text.length-a-1];)a++,e--,s--;return{a:e,b:s}}if(o.content.size||l.content.size){let a=jl(o.content,l.content,e-1,s-1);if(a)return a}e-=c,s-=c}}class _{constructor(t,e){if(this.content=t,this.size=e||0,e==null)for(let s=0;s<t.length;s++)this.size+=t[s].nodeSize}nodesBetween(t,e,s,r=0,i){for(let o=0,l=0;l<e;o++){let c=this.content[o],a=l+c.nodeSize;if(a>t&&s(c,r+l,i||null,o)!==!1&&c.content.size){let h=l+1;c.nodesBetween(Math.max(0,t-h),Math.min(c.content.size,e-h),s,r+h)}l=a}}descendants(t){this.nodesBetween(0,this.size,t)}textBetween(t,e,s,r){let i="",o=!0;return this.nodesBetween(t,e,(l,c)=>{let a=l.isText?l.text.slice(Math.max(t,c)-c,e-c):l.isLeaf?r?typeof r=="function"?r(l):r:l.type.spec.leafText?l.type.spec.leafText(l):"":"";l.isBlock&&(l.isLeaf&&a||l.isTextblock)&&s&&(o?o=!1:i+=s),i+=a},0),i}append(t){if(!t.size)return this;if(!this.size)return t;let e=this.lastChild,s=t.firstChild,r=this.content.slice(),i=0;for(e.isText&&e.sameMarkup(s)&&(r[r.length-1]=e.withText(e.text+s.text),i=1);i<t.content.length;i++)r.push(t.content[i]);return new _(r,this.size+t.size)}cut(t,e=this.size){if(t==0&&e==this.size)return this;let s=[],r=0;if(e>t)for(let i=0,o=0;o<e;i++){let l=this.content[i],c=o+l.nodeSize;c>t&&((o<t||c>e)&&(l.isText?l=l.cut(Math.max(0,t-o),Math.min(l.text.length,e-o)):l=l.cut(Math.max(0,t-o-1),Math.min(l.content.size,e-o-1))),s.push(l),r+=l.nodeSize),o=c}return new _(s,r)}cutByIndex(t,e){return t==e?_.empty:t==0&&e==this.content.length?this:new _(this.content.slice(t,e))}replaceChild(t,e){let s=this.content[t];if(s==e)return this;let r=this.content.slice(),i=this.size+e.nodeSize-s.nodeSize;return r[t]=e,new _(r,i)}addToStart(t){return new _([t].concat(this.content),this.size+t.nodeSize)}addToEnd(t){return new _(this.content.concat(t),this.size+t.nodeSize)}eq(t){if(this.content.length!=t.content.length)return!1;for(let e=0;e<this.content.length;e++)if(!this.content[e].eq(t.content[e]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(t){let e=this.content[t];if(!e)throw new RangeError("Index "+t+" out of range for "+this);return e}maybeChild(t){return this.content[t]||null}forEach(t){for(let e=0,s=0;e<this.content.length;e++){let r=this.content[e];t(r,s,e),s+=r.nodeSize}}findDiffStart(t,e=0){return $l(this,t,e)}findDiffEnd(t,e=this.size,s=t.size){return jl(this,t,e,s)}findIndex(t){if(t==0)return Hn(0,t);if(t==this.size)return Hn(this.content.length,t);if(t>this.size||t<0)throw new RangeError(`Position ${t} outside of fragment (${this})`);for(let e=0,s=0;;e++){let r=this.child(e),i=s+r.nodeSize;if(i>=t)return i==t?Hn(e+1,i):Hn(e,s);s=i}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(t=>t.toJSON()):null}static fromJSON(t,e){if(!e)return _.empty;if(!Array.isArray(e))throw new RangeError("Invalid input for Fragment.fromJSON");return new _(e.map(t.nodeFromJSON))}static fromArray(t){if(!t.length)return _.empty;let e,s=0;for(let r=0;r<t.length;r++){let i=t[r];s+=i.nodeSize,r&&i.isText&&t[r-1].sameMarkup(i)?(e||(e=t.slice(0,r)),e[e.length-1]=i.withText(e[e.length-1].text+i.text)):e&&e.push(i)}return new _(e||t,s)}static from(t){if(!t)return _.empty;if(t instanceof _)return t;if(Array.isArray(t))return this.fromArray(t);if(t.attrs)return new _([t],t.nodeSize);throw new RangeError("Can not convert "+t+" to a Fragment"+(t.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}_.empty=new _([],0);const js={index:0,offset:0};function Hn(n,t){return js.index=n,js.offset=t,js}function yr(n,t){if(n===t)return!0;if(!(n&&typeof n=="object")||!(t&&typeof t=="object"))return!1;let e=Array.isArray(n);if(Array.isArray(t)!=e)return!1;if(e){if(n.length!=t.length)return!1;for(let s=0;s<n.length;s++)if(!yr(n[s],t[s]))return!1}else{for(let s in n)if(!(s in t)||!yr(n[s],t[s]))return!1;for(let s in t)if(!(s in n))return!1}return!0}class Ct{constructor(t,e){this.type=t,this.attrs=e}addToSet(t){let e,s=!1;for(let r=0;r<t.length;r++){let i=t[r];if(this.eq(i))return t;if(this.type.excludes(i.type))e||(e=t.slice(0,r));else{if(i.type.excludes(this.type))return t;!s&&i.type.rank>this.type.rank&&(e||(e=t.slice(0,r)),e.push(this),s=!0),e&&e.push(i)}}return e||(e=t.slice()),s||e.push(this),e}removeFromSet(t){for(let e=0;e<t.length;e++)if(this.eq(t[e]))return t.slice(0,e).concat(t.slice(e+1));return t}isInSet(t){for(let e=0;e<t.length;e++)if(this.eq(t[e]))return!0;return!1}eq(t){return this==t||this.type==t.type&&yr(this.attrs,t.attrs)}toJSON(){let t={type:this.type.name};for(let e in this.attrs){t.attrs=this.attrs;break}return t}static fromJSON(t,e){if(!e)throw new RangeError("Invalid input for Mark.fromJSON");let s=t.marks[e.type];if(!s)throw new RangeError(`There is no mark type ${e.type} in this schema`);let r=s.create(e.attrs);return s.checkAttrs(r.attrs),r}static sameSet(t,e){if(t==e)return!0;if(t.length!=e.length)return!1;for(let s=0;s<t.length;s++)if(!t[s].eq(e[s]))return!1;return!0}static setFrom(t){if(!t||Array.isArray(t)&&t.length==0)return Ct.none;if(t instanceof Ct)return[t];let e=t.slice();return e.sort((s,r)=>s.type.rank-r.type.rank),e}}Ct.none=[];class Xf extends Error{}class x{constructor(t,e,s){this.content=t,this.openStart=e,this.openEnd=s}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(t,e){let s=Xl(this.content,t+this.openStart,e);return s&&new x(s,this.openStart,this.openEnd)}removeBetween(t,e){return new x(Gl(this.content,t+this.openStart,e+this.openStart),this.openStart,this.openEnd)}eq(t){return this.content.eq(t.content)&&this.openStart==t.openStart&&this.openEnd==t.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let t={content:this.content.toJSON()};return this.openStart>0&&(t.openStart=this.openStart),this.openEnd>0&&(t.openEnd=this.openEnd),t}static fromJSON(t,e){if(!e)return x.empty;let s=e.openStart||0,r=e.openEnd||0;if(typeof s!="number"||typeof r!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new x(_.fromJSON(t,e.content),s,r)}static maxOpen(t,e=!0){let s=0,r=0;for(let i=t.firstChild;i&&!i.isLeaf&&(e||!i.type.spec.isolating);i=i.firstChild)s++;for(let i=t.lastChild;i&&!i.isLeaf&&(e||!i.type.spec.isolating);i=i.lastChild)r++;return new x(t,s,r)}}x.empty=new x(_.empty,0,0);function Gl(n,t,e){let{index:s,offset:r}=n.findIndex(t),i=n.maybeChild(s),{index:o,offset:l}=n.findIndex(e);if(r==t||i.isText){if(l!=e&&!n.child(o).isText)throw new RangeError("Removing non-flat range");return n.cut(0,t).append(n.cut(e))}if(s!=o)throw new RangeError("Removing non-flat range");return n.replaceChild(s,i.copy(Gl(i.content,t-r-1,e-r-1)))}function Xl(n,t,e,s){let{index:r,offset:i}=n.findIndex(t),o=n.maybeChild(r);if(i==t||o.isText)return s&&!s.canReplace(r,r,e)?null:n.cut(0,t).append(e).append(n.cut(t));let l=Xl(o.content,t-i-1,e,o);return l&&n.replaceChild(r,o.copy(l))}function Zf(n){return n.tag!=null}function Qf(n){return n.style!=null}let td=class br{constructor(t,e){this.schema=t,this.rules=e,this.tags=[],this.styles=[];let s=this.matchedStyles=[];e.forEach(r=>{if(Zf(r))this.tags.push(r);else if(Qf(r)){let i=/[^=]*/.exec(r.style)[0];s.indexOf(i)<0&&s.push(i),this.styles.push(r)}}),this.normalizeLists=!this.tags.some(r=>{if(!/^(ul|ol)\b/.test(r.tag)||!r.node)return!1;let i=t.nodes[r.node];return i.contentMatch.matchType(i)})}parse(t,e={}){let s=new ro(this,e,!1);return s.addAll(t,Ct.none,e.from,e.to),s.finish()}parseSlice(t,e={}){let s=new ro(this,e,!0);return s.addAll(t,Ct.none,e.from,e.to),x.maxOpen(s.finish())}matchTag(t,e,s){for(let r=s?this.tags.indexOf(s)+1:0;r<this.tags.length;r++){let i=this.tags[r];if(sd(t,i.tag)&&(i.namespace===void 0||t.namespaceURI==i.namespace)&&(!i.context||e.matchesContext(i.context))){if(i.getAttrs){let o=i.getAttrs(t);if(o===!1)continue;i.attrs=o||void 0}return i}}}matchStyle(t,e,s,r){for(let i=r?this.styles.indexOf(r)+1:0;i<this.styles.length;i++){let o=this.styles[i],l=o.style;if(!(l.indexOf(t)!=0||o.context&&!s.matchesContext(o.context)||l.length>t.length&&(l.charCodeAt(t.length)!=61||l.slice(t.length+1)!=e))){if(o.getAttrs){let c=o.getAttrs(e);if(c===!1)continue;o.attrs=c||void 0}return o}}}static schemaRules(t){let e=[];function s(r){let i=r.priority==null?50:r.priority,o=0;for(;o<e.length;o++){let l=e[o];if((l.priority==null?50:l.priority)<i)break}e.splice(o,0,r)}for(let r in t.marks){let i=t.marks[r].spec.parseDOM;i&&i.forEach(o=>{s(o=io(o)),o.mark||o.ignore||o.clearMark||(o.mark=r)})}for(let r in t.nodes){let i=t.nodes[r].spec.parseDOM;i&&i.forEach(o=>{s(o=io(o)),o.node||o.ignore||o.mark||(o.node=r)})}return e}static fromSchema(t){return t.cached.domParser||(t.cached.domParser=new br(t,br.schemaRules(t)))}};const Zl={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},ed={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Ql={ol:!0,ul:!0},xn=1,wr=2,hn=4;function so(n,t,e){return t!=null?(t?xn:0)|(t==="full"?wr:0):n&&n.whitespace=="pre"?xn|wr:e&~hn}class qn{constructor(t,e,s,r,i,o){this.type=t,this.attrs=e,this.marks=s,this.solid=r,this.options=o,this.content=[],this.activeMarks=Ct.none,this.match=i||(o&hn?null:t.contentMatch)}findWrapping(t){if(!this.match){if(!this.type)return[];let e=this.type.contentMatch.fillBefore(_.from(t));if(e)this.match=this.type.contentMatch.matchFragment(e);else{let s=this.type.contentMatch,r;return(r=s.findWrapping(t.type))?(this.match=s,r):null}}return this.match.findWrapping(t.type)}finish(t){if(!(this.options&xn)){let s=this.content[this.content.length-1],r;if(s&&s.isText&&(r=/[ \t\r\n\u000c]+$/.exec(s.text))){let i=s;s.text.length==r[0].length?this.content.pop():this.content[this.content.length-1]=i.withText(i.text.slice(0,i.text.length-r[0].length))}}let e=_.from(this.content);return!t&&this.match&&(e=e.append(this.match.fillBefore(_.empty,!0))),this.type?this.type.create(this.attrs,e,this.marks):e}inlineContext(t){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:t.parentNode&&!Zl.hasOwnProperty(t.parentNode.nodeName.toLowerCase())}}class ro{constructor(t,e,s){this.parser=t,this.options=e,this.isOpen=s,this.open=0,this.localPreserveWS=!1;let r=e.topNode,i,o=so(null,e.preserveWhitespace,0)|(s?hn:0);r?i=new qn(r.type,r.attrs,Ct.none,!0,e.topMatch||r.type.contentMatch,o):s?i=new qn(null,null,Ct.none,!0,null,o):i=new qn(t.schema.topNodeType,null,Ct.none,!0,null,o),this.nodes=[i],this.find=e.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(t,e){t.nodeType==3?this.addTextNode(t,e):t.nodeType==1&&this.addElement(t,e)}addTextNode(t,e){let s=t.nodeValue,r=this.top,i=r.options&wr?"full":this.localPreserveWS||(r.options&xn)>0,{schema:o}=this.parser;if(i==="full"||r.inlineContext(t)||/[^ \t\r\n\u000c]/.test(s)){if(i)if(i==="full")s=s.replace(/\r\n?/g,`
`);else if(o.linebreakReplacement&&/[\r\n]/.test(s)&&this.top.findWrapping(o.linebreakReplacement.create())){let l=s.split(/\r?\n|\r/);for(let c=0;c<l.length;c++)c&&this.insertNode(o.linebreakReplacement.create(),e,!0),l[c]&&this.insertNode(o.text(l[c]),e,!/\S/.test(l[c]));s=""}else s=s.replace(/\r?\n|\r/g," ");else if(s=s.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(s)&&this.open==this.nodes.length-1){let l=r.content[r.content.length-1],c=t.previousSibling;(!l||c&&c.nodeName=="BR"||l.isText&&/[ \t\r\n\u000c]$/.test(l.text))&&(s=s.slice(1))}s&&this.insertNode(o.text(s),e,!/\S/.test(s)),this.findInText(t)}else this.findInside(t)}addElement(t,e,s){let r=this.localPreserveWS,i=this.top;(t.tagName=="PRE"||/pre/.test(t.style&&t.style.whiteSpace))&&(this.localPreserveWS=!0);let o=t.nodeName.toLowerCase(),l;Ql.hasOwnProperty(o)&&this.parser.normalizeLists&&nd(t);let c=this.options.ruleFromNode&&this.options.ruleFromNode(t)||(l=this.parser.matchTag(t,this,s));t:if(c?c.ignore:ed.hasOwnProperty(o))this.findInside(t),this.ignoreFallback(t,e);else if(!c||c.skip||c.closeParent){c&&c.closeParent?this.open=Math.max(0,this.open-1):c&&c.skip.nodeType&&(t=c.skip);let a,h=this.needsBlock;if(Zl.hasOwnProperty(o))i.content.length&&i.content[0].isInline&&this.open&&(this.open--,i=this.top),a=!0,i.type||(this.needsBlock=!0);else if(!t.firstChild){this.leafFallback(t,e);break t}let u=c&&c.skip?e:this.readStyles(t,e);u&&this.addAll(t,u),a&&this.sync(i),this.needsBlock=h}else{let a=this.readStyles(t,e);a&&this.addElementByRule(t,c,a,c.consuming===!1?l:void 0)}this.localPreserveWS=r}leafFallback(t,e){t.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(t.ownerDocument.createTextNode(`
`),e)}ignoreFallback(t,e){t.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"),e,!0)}readStyles(t,e){let s=t.style;if(s&&s.length)for(let r=0;r<this.parser.matchedStyles.length;r++){let i=this.parser.matchedStyles[r],o=s.getPropertyValue(i);if(o)for(let l=void 0;;){let c=this.parser.matchStyle(i,o,this,l);if(!c)break;if(c.ignore)return null;if(c.clearMark?e=e.filter(a=>!c.clearMark(a)):e=e.concat(this.parser.schema.marks[c.mark].create(c.attrs)),c.consuming===!1)l=c;else break}}return e}addElementByRule(t,e,s,r){let i,o;if(e.node)if(o=this.parser.schema.nodes[e.node],o.isLeaf)this.insertNode(o.create(e.attrs),s,t.nodeName=="BR")||this.leafFallback(t,s);else{let c=this.enter(o,e.attrs||null,s,e.preserveWhitespace);c&&(i=!0,s=c)}else{let c=this.parser.schema.marks[e.mark];s=s.concat(c.create(e.attrs))}let l=this.top;if(o&&o.isLeaf)this.findInside(t);else if(r)this.addElement(t,s,r);else if(e.getContent)this.findInside(t),e.getContent(t,this.parser.schema).forEach(c=>this.insertNode(c,s,!1));else{let c=t;typeof e.contentElement=="string"?c=t.querySelector(e.contentElement):typeof e.contentElement=="function"?c=e.contentElement(t):e.contentElement&&(c=e.contentElement),this.findAround(t,c,!0),this.addAll(c,s),this.findAround(t,c,!1)}i&&this.sync(l)&&this.open--}addAll(t,e,s,r){let i=s||0;for(let o=s?t.childNodes[s]:t.firstChild,l=r==null?null:t.childNodes[r];o!=l;o=o.nextSibling,++i)this.findAtPoint(t,i),this.addDOM(o,e);this.findAtPoint(t,i)}findPlace(t,e,s){let r,i;for(let o=this.open,l=0;o>=0;o--){let c=this.nodes[o],a=c.findWrapping(t);if(a&&(!r||r.length>a.length+l)&&(r=a,i=c,!a.length))break;if(c.solid){if(s)break;l+=2}}if(!r)return null;this.sync(i);for(let o=0;o<r.length;o++)e=this.enterInner(r[o],null,e,!1);return e}insertNode(t,e,s){if(t.isInline&&this.needsBlock&&!this.top.type){let i=this.textblockFromContext();i&&(e=this.enterInner(i,null,e))}let r=this.findPlace(t,e,s);if(r){this.closeExtra();let i=this.top;i.match&&(i.match=i.match.matchType(t.type));let o=Ct.none;for(let l of r.concat(t.marks))(i.type?i.type.allowsMarkType(l.type):oo(l.type,t.type))&&(o=l.addToSet(o));return i.content.push(t.mark(o)),!0}return!1}enter(t,e,s,r){let i=this.findPlace(t.create(e),s,!1);return i&&(i=this.enterInner(t,e,s,!0,r)),i}enterInner(t,e,s,r=!1,i){this.closeExtra();let o=this.top;o.match=o.match&&o.match.matchType(t);let l=so(t,i,o.options);o.options&hn&&o.content.length==0&&(l|=hn);let c=Ct.none;return s=s.filter(a=>(o.type?o.type.allowsMarkType(a.type):oo(a.type,t))?(c=a.addToSet(c),!1):!0),this.nodes.push(new qn(t,e,c,r,null,l)),this.open++,s}closeExtra(t=!1){let e=this.nodes.length-1;if(e>this.open){for(;e>this.open;e--)this.nodes[e-1].content.push(this.nodes[e].finish(t));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(!!(this.isOpen||this.options.topOpen))}sync(t){for(let e=this.open;e>=0;e--){if(this.nodes[e]==t)return this.open=e,!0;this.localPreserveWS&&(this.nodes[e].options|=xn)}return!1}get currentPos(){this.closeExtra();let t=0;for(let e=this.open;e>=0;e--){let s=this.nodes[e].content;for(let r=s.length-1;r>=0;r--)t+=s[r].nodeSize;e&&t++}return t}findAtPoint(t,e){if(this.find)for(let s=0;s<this.find.length;s++)this.find[s].node==t&&this.find[s].offset==e&&(this.find[s].pos=this.currentPos)}findInside(t){if(this.find)for(let e=0;e<this.find.length;e++)this.find[e].pos==null&&t.nodeType==1&&t.contains(this.find[e].node)&&(this.find[e].pos=this.currentPos)}findAround(t,e,s){if(t!=e&&this.find)for(let r=0;r<this.find.length;r++)this.find[r].pos==null&&t.nodeType==1&&t.contains(this.find[r].node)&&e.compareDocumentPosition(this.find[r].node)&(s?2:4)&&(this.find[r].pos=this.currentPos)}findInText(t){if(this.find)for(let e=0;e<this.find.length;e++)this.find[e].node==t&&(this.find[e].pos=this.currentPos-(t.nodeValue.length-this.find[e].offset))}matchesContext(t){if(t.indexOf("|")>-1)return t.split(/\s*\|\s*/).some(this.matchesContext,this);let e=t.split("/"),s=this.options.context,r=!this.isOpen&&(!s||s.parent.type==this.nodes[0].type),i=-(s?s.depth+1:0)+(r?0:1),o=(l,c)=>{for(;l>=0;l--){let a=e[l];if(a==""){if(l==e.length-1||l==0)continue;for(;c>=i;c--)if(o(l-1,c))return!0;return!1}else{let h=c>0||c==0&&r?this.nodes[c].type:s&&c>=i?s.node(c-i).type:null;if(!h||h.name!=a&&!h.isInGroup(a))return!1;c--}}return!0};return o(e.length-1,this.open)}textblockFromContext(){let t=this.options.context;if(t)for(let e=t.depth;e>=0;e--){let s=t.node(e).contentMatchAt(t.indexAfter(e)).defaultType;if(s&&s.isTextblock&&s.defaultAttrs)return s}for(let e in this.parser.schema.nodes){let s=this.parser.schema.nodes[e];if(s.isTextblock&&s.defaultAttrs)return s}}}function nd(n){for(let t=n.firstChild,e=null;t;t=t.nextSibling){let s=t.nodeType==1?t.nodeName.toLowerCase():null;s&&Ql.hasOwnProperty(s)&&e?(e.appendChild(t),t=e):s=="li"?e=t:s&&(e=null)}}function sd(n,t){return(n.matches||n.msMatchesSelector||n.webkitMatchesSelector||n.mozMatchesSelector).call(n,t)}function io(n){let t={};for(let e in n)t[e]=n[e];return t}function oo(n,t){let e=t.schema.nodes;for(let s in e){let r=e[s];if(!r.allowsMarkType(n))continue;let i=[],o=l=>{i.push(l);for(let c=0;c<l.edgeCount;c++){let{type:a,next:h}=l.edge(c);if(a==t||i.indexOf(h)<0&&o(h))return!0}};if(o(r.contentMatch))return!0}}class Es{constructor(t,e){this.nodes=t,this.marks=e}serializeFragment(t,e={},s){s||(s=Gs(e).createDocumentFragment());let r=s,i=[];return t.forEach(o=>{if(i.length||o.marks.length){let l=0,c=0;for(;l<i.length&&c<o.marks.length;){let a=o.marks[c];if(!this.marks[a.type.name]){c++;continue}if(!a.eq(i[l][0])||a.type.spec.spanning===!1)break;l++,c++}for(;l<i.length;)r=i.pop()[1];for(;c<o.marks.length;){let a=o.marks[c++],h=this.serializeMark(a,o.isInline,e);h&&(i.push([a,r]),r.appendChild(h.dom),r=h.contentDOM||h.dom)}}r.appendChild(this.serializeNodeInner(o,e))}),s}serializeNodeInner(t,e){let{dom:s,contentDOM:r}=Zn(Gs(e),this.nodes[t.type.name](t),null,t.attrs);if(r){if(t.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(t.content,e,r)}return s}serializeNode(t,e={}){let s=this.serializeNodeInner(t,e);for(let r=t.marks.length-1;r>=0;r--){let i=this.serializeMark(t.marks[r],t.isInline,e);i&&((i.contentDOM||i.dom).appendChild(s),s=i.dom)}return s}serializeMark(t,e,s={}){let r=this.marks[t.type.name];return r&&Zn(Gs(s),r(t,e),null,t.attrs)}static renderSpec(t,e,s=null,r){return Zn(t,e,s,r)}static fromSchema(t){return t.cached.domSerializer||(t.cached.domSerializer=new Es(this.nodesFromSchema(t),this.marksFromSchema(t)))}static nodesFromSchema(t){let e=lo(t.nodes);return e.text||(e.text=s=>s.text),e}static marksFromSchema(t){return lo(t.marks)}}function lo(n){let t={};for(let e in n){let s=n[e].spec.toDOM;s&&(t[e]=s)}return t}function Gs(n){return n.document||window.document}const co=new WeakMap;function rd(n){let t=co.get(n);return t===void 0&&co.set(n,t=id(n)),t}function id(n){let t=null;function e(s){if(s&&typeof s=="object")if(Array.isArray(s))if(typeof s[0]=="string")t||(t=[]),t.push(s);else for(let r=0;r<s.length;r++)e(s[r]);else for(let r in s)e(s[r])}return e(n),t}function Zn(n,t,e,s){if(typeof t=="string")return{dom:n.createTextNode(t)};if(t.nodeType!=null)return{dom:t};if(t.dom&&t.dom.nodeType!=null)return t;let r=t[0],i;if(typeof r!="string")throw new RangeError("Invalid array passed to renderSpec");if(s&&(i=rd(s))&&i.indexOf(t)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=r.indexOf(" ");o>0&&(e=r.slice(0,o),r=r.slice(o+1));let l,c=e?n.createElementNS(e,r):n.createElement(r),a=t[1],h=1;if(a&&typeof a=="object"&&a.nodeType==null&&!Array.isArray(a)){h=2;for(let u in a)if(a[u]!=null){let f=u.indexOf(" ");f>0?c.setAttributeNS(u.slice(0,f),u.slice(f+1),a[u]):u=="style"&&c.style?c.style.cssText=a[u]:c.setAttribute(u,a[u])}}for(let u=h;u<t.length;u++){let f=t[u];if(f===0){if(u<t.length-1||u>h)throw new RangeError("Content hole must be the only child of its parent node");return{dom:c,contentDOM:c}}else{let{dom:d,contentDOM:p}=Zn(n,f,e,s);if(c.appendChild(d),p){if(l)throw new RangeError("Multiple content holes");l=p}}}return{dom:c,contentDOM:l}}const tc=65535,ec=Math.pow(2,16);function od(n,t){return n+t*ec}function ao(n){return n&tc}function ld(n){return(n-(n&tc))/ec}const nc=1,sc=2,Qn=4,rc=8;class ho{constructor(t,e,s){this.pos=t,this.delInfo=e,this.recover=s}get deleted(){return(this.delInfo&rc)>0}get deletedBefore(){return(this.delInfo&(nc|Qn))>0}get deletedAfter(){return(this.delInfo&(sc|Qn))>0}get deletedAcross(){return(this.delInfo&Qn)>0}}class ut{constructor(t,e=!1){if(this.ranges=t,this.inverted=e,!t.length&&ut.empty)return ut.empty}recover(t){let e=0,s=ao(t);if(!this.inverted)for(let r=0;r<s;r++)e+=this.ranges[r*3+2]-this.ranges[r*3+1];return this.ranges[s*3]+e+ld(t)}mapResult(t,e=1){return this._map(t,e,!1)}map(t,e=1){return this._map(t,e,!0)}_map(t,e,s){let r=0,i=this.inverted?2:1,o=this.inverted?1:2;for(let l=0;l<this.ranges.length;l+=3){let c=this.ranges[l]-(this.inverted?r:0);if(c>t)break;let a=this.ranges[l+i],h=this.ranges[l+o],u=c+a;if(t<=u){let f=a?t==c?-1:t==u?1:e:e,d=c+r+(f<0?0:h);if(s)return d;let p=t==(e<0?c:u)?null:od(l/3,t-c),g=t==c?sc:t==u?nc:Qn;return(e<0?t!=c:t!=u)&&(g|=rc),new ho(d,g,p)}r+=h-a}return s?t+r:new ho(t+r,0,null)}touches(t,e){let s=0,r=ao(e),i=this.inverted?2:1,o=this.inverted?1:2;for(let l=0;l<this.ranges.length;l+=3){let c=this.ranges[l]-(this.inverted?s:0);if(c>t)break;let a=this.ranges[l+i],h=c+a;if(t<=h&&l==r*3)return!0;s+=this.ranges[l+o]-a}return!1}forEach(t){let e=this.inverted?2:1,s=this.inverted?1:2;for(let r=0,i=0;r<this.ranges.length;r+=3){let o=this.ranges[r],l=o-(this.inverted?i:0),c=o+(this.inverted?0:i),a=this.ranges[r+e],h=this.ranges[r+s];t(l,l+a,c,c+h),i+=h-a}}invert(){return new ut(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(t){return t==0?ut.empty:new ut(t<0?[0,-t,0]:[0,0,t])}}ut.empty=new ut([]);const Xs=Object.create(null);class Q{getMap(){return ut.empty}merge(t){return null}static fromJSON(t,e){if(!e||!e.stepType)throw new RangeError("Invalid input for Step.fromJSON");let s=Xs[e.stepType];if(!s)throw new RangeError(`No step type ${e.stepType} defined`);return s.fromJSON(t,e)}static jsonID(t,e){if(t in Xs)throw new RangeError("Duplicate use of step JSON ID "+t);return Xs[t]=e,e.prototype.jsonID=t,e}}class B{constructor(t,e){this.doc=t,this.failed=e}static ok(t){return new B(t,null)}static fail(t){return new B(null,t)}static fromReplace(t,e,s,r){try{return B.ok(t.replace(e,s,r))}catch(i){if(i instanceof Xf)return B.fail(i.message);throw i}}}function ai(n,t,e){let s=[];for(let r=0;r<n.childCount;r++){let i=n.child(r);i.content.size&&(i=i.copy(ai(i.content,t,i))),i.isInline&&(i=t(i,e,r)),s.push(i)}return _.fromArray(s)}class me extends Q{constructor(t,e,s){super(),this.from=t,this.to=e,this.mark=s}apply(t){let e=t.slice(this.from,this.to),s=t.resolve(this.from),r=s.node(s.sharedDepth(this.to)),i=new x(ai(e.content,(o,l)=>!o.isAtom||!l.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),r),e.openStart,e.openEnd);return B.fromReplace(t,this.from,this.to,i)}invert(){return new ye(this.from,this.to,this.mark)}map(t){let e=t.mapResult(this.from,1),s=t.mapResult(this.to,-1);return e.deleted&&s.deleted||e.pos>=s.pos?null:new me(e.pos,s.pos,this.mark)}merge(t){return t instanceof me&&t.mark.eq(this.mark)&&this.from<=t.to&&this.to>=t.from?new me(Math.min(this.from,t.from),Math.max(this.to,t.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new me(e.from,e.to,t.markFromJSON(e.mark))}}Q.jsonID("addMark",me);class ye extends Q{constructor(t,e,s){super(),this.from=t,this.to=e,this.mark=s}apply(t){let e=t.slice(this.from,this.to),s=new x(ai(e.content,r=>r.mark(this.mark.removeFromSet(r.marks)),t),e.openStart,e.openEnd);return B.fromReplace(t,this.from,this.to,s)}invert(){return new me(this.from,this.to,this.mark)}map(t){let e=t.mapResult(this.from,1),s=t.mapResult(this.to,-1);return e.deleted&&s.deleted||e.pos>=s.pos?null:new ye(e.pos,s.pos,this.mark)}merge(t){return t instanceof ye&&t.mark.eq(this.mark)&&this.from<=t.to&&this.to>=t.from?new ye(Math.min(this.from,t.from),Math.max(this.to,t.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new ye(e.from,e.to,t.markFromJSON(e.mark))}}Q.jsonID("removeMark",ye);class be extends Q{constructor(t,e){super(),this.pos=t,this.mark=e}apply(t){let e=t.nodeAt(this.pos);if(!e)return B.fail("No node at mark step's position");let s=e.type.create(e.attrs,null,this.mark.addToSet(e.marks));return B.fromReplace(t,this.pos,this.pos+1,new x(_.from(s),0,e.isLeaf?0:1))}invert(t){let e=t.nodeAt(this.pos);if(e){let s=this.mark.addToSet(e.marks);if(s.length==e.marks.length){for(let r=0;r<e.marks.length;r++)if(!e.marks[r].isInSet(s))return new be(this.pos,e.marks[r]);return new be(this.pos,this.mark)}}return new En(this.pos,this.mark)}map(t){let e=t.mapResult(this.pos,1);return e.deletedAfter?null:new be(e.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(t,e){if(typeof e.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new be(e.pos,t.markFromJSON(e.mark))}}Q.jsonID("addNodeMark",be);class En extends Q{constructor(t,e){super(),this.pos=t,this.mark=e}apply(t){let e=t.nodeAt(this.pos);if(!e)return B.fail("No node at mark step's position");let s=e.type.create(e.attrs,null,this.mark.removeFromSet(e.marks));return B.fromReplace(t,this.pos,this.pos+1,new x(_.from(s),0,e.isLeaf?0:1))}invert(t){let e=t.nodeAt(this.pos);return!e||!this.mark.isInSet(e.marks)?this:new be(this.pos,this.mark)}map(t){let e=t.mapResult(this.pos,1);return e.deletedAfter?null:new En(e.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(t,e){if(typeof e.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new En(e.pos,t.markFromJSON(e.mark))}}Q.jsonID("removeNodeMark",En);class Jt extends Q{constructor(t,e,s,r=!1){super(),this.from=t,this.to=e,this.slice=s,this.structure=r}apply(t){return this.structure&&Sr(t,this.from,this.to)?B.fail("Structure replace would overwrite content"):B.fromReplace(t,this.from,this.to,this.slice)}getMap(){return new ut([this.from,this.to-this.from,this.slice.size])}invert(t){return new Jt(this.from,this.from+this.slice.size,t.slice(this.from,this.to))}map(t){let e=t.mapResult(this.from,1),s=t.mapResult(this.to,-1);return e.deletedAcross&&s.deletedAcross?null:new Jt(e.pos,Math.max(e.pos,s.pos),this.slice,this.structure)}merge(t){if(!(t instanceof Jt)||t.structure||this.structure)return null;if(this.from+this.slice.size==t.from&&!this.slice.openEnd&&!t.slice.openStart){let e=this.slice.size+t.slice.size==0?x.empty:new x(this.slice.content.append(t.slice.content),this.slice.openStart,t.slice.openEnd);return new Jt(this.from,this.to+(t.to-t.from),e,this.structure)}else if(t.to==this.from&&!this.slice.openStart&&!t.slice.openEnd){let e=this.slice.size+t.slice.size==0?x.empty:new x(t.slice.content.append(this.slice.content),t.slice.openStart,this.slice.openEnd);return new Jt(t.from,this.to,e,this.structure)}else return null}toJSON(){let t={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(t.slice=this.slice.toJSON()),this.structure&&(t.structure=!0),t}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new Jt(e.from,e.to,x.fromJSON(t,e.slice),!!e.structure)}}Q.jsonID("replace",Jt);class Je extends Q{constructor(t,e,s,r,i,o,l=!1){super(),this.from=t,this.to=e,this.gapFrom=s,this.gapTo=r,this.slice=i,this.insert=o,this.structure=l}apply(t){if(this.structure&&(Sr(t,this.from,this.gapFrom)||Sr(t,this.gapTo,this.to)))return B.fail("Structure gap-replace would overwrite content");let e=t.slice(this.gapFrom,this.gapTo);if(e.openStart||e.openEnd)return B.fail("Gap is not a flat range");let s=this.slice.insertAt(this.insert,e.content);return s?B.fromReplace(t,this.from,this.to,s):B.fail("Content does not fit in gap")}getMap(){return new ut([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(t){let e=this.gapTo-this.gapFrom;return new Je(this.from,this.from+this.slice.size+e,this.from+this.insert,this.from+this.insert+e,t.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(t){let e=t.mapResult(this.from,1),s=t.mapResult(this.to,-1),r=this.from==this.gapFrom?e.pos:t.map(this.gapFrom,-1),i=this.to==this.gapTo?s.pos:t.map(this.gapTo,1);return e.deletedAcross&&s.deletedAcross||r<e.pos||i>s.pos?null:new Je(e.pos,s.pos,r,i,this.slice,this.insert,this.structure)}toJSON(){let t={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(t.slice=this.slice.toJSON()),this.structure&&(t.structure=!0),t}static fromJSON(t,e){if(typeof e.from!="number"||typeof e.to!="number"||typeof e.gapFrom!="number"||typeof e.gapTo!="number"||typeof e.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Je(e.from,e.to,e.gapFrom,e.gapTo,x.fromJSON(t,e.slice),e.insert,!!e.structure)}}Q.jsonID("replaceAround",Je);function Sr(n,t,e){let s=n.resolve(t),r=e-t,i=s.depth;for(;r>0&&i>0&&s.indexAfter(i)==s.node(i).childCount;)i--,r--;if(r>0){let o=s.node(i).maybeChild(s.indexAfter(i));for(;r>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,r--}}return!1}function cd(n,t,e){let s=n.resolve(t);if(!e.content.size)return t;let r=e.content;for(let i=0;i<e.openStart;i++)r=r.firstChild.content;for(let i=1;i<=(e.openStart==0&&e.size?2:1);i++)for(let o=s.depth;o>=0;o--){let l=o==s.depth?0:s.pos<=(s.start(o+1)+s.end(o+1))/2?-1:1,c=s.index(o)+(l>0?1:0),a=s.node(o),h=!1;if(i==1)h=a.canReplace(c,c,r);else{let u=a.contentMatchAt(c).findWrapping(r.firstChild.type);h=u&&a.canReplaceWith(c,c,u[0])}if(h)return l==0?s.pos:l<0?s.before(o+1):s.after(o+1)}return null}class un extends Q{constructor(t,e,s){super(),this.pos=t,this.attr=e,this.value=s}apply(t){let e=t.nodeAt(this.pos);if(!e)return B.fail("No node at attribute step's position");let s=Object.create(null);for(let i in e.attrs)s[i]=e.attrs[i];s[this.attr]=this.value;let r=e.type.create(s,null,e.marks);return B.fromReplace(t,this.pos,this.pos+1,new x(_.from(r),0,e.isLeaf?0:1))}getMap(){return ut.empty}invert(t){return new un(this.pos,this.attr,t.nodeAt(this.pos).attrs[this.attr])}map(t){let e=t.mapResult(this.pos,1);return e.deletedAfter?null:new un(e.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(t,e){if(typeof e.pos!="number"||typeof e.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new un(e.pos,e.attr,e.value)}}Q.jsonID("attr",un);class hs extends Q{constructor(t,e){super(),this.attr=t,this.value=e}apply(t){let e=Object.create(null);for(let r in t.attrs)e[r]=t.attrs[r];e[this.attr]=this.value;let s=t.type.create(e,t.content,t.marks);return B.ok(s)}getMap(){return ut.empty}invert(t){return new hs(this.attr,t.attrs[this.attr])}map(t){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(t,e){if(typeof e.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new hs(e.attr,e.value)}}Q.jsonID("docAttr",hs);let Dn=class extends Error{};Dn=function n(t){let e=Error.call(this,t);return e.__proto__=n.prototype,e};Dn.prototype=Object.create(Error.prototype);Dn.prototype.constructor=Dn;Dn.prototype.name="TransformError";const Zs=Object.create(null);class U{constructor(t,e,s){this.$anchor=t,this.$head=e,this.ranges=s||[new ad(t.min(e),t.max(e))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let t=this.ranges;for(let e=0;e<t.length;e++)if(t[e].$from.pos!=t[e].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(t,e=x.empty){let s=e.content.lastChild,r=null;for(let l=0;l<e.openEnd;l++)r=s,s=s.lastChild;let i=t.steps.length,o=this.ranges;for(let l=0;l<o.length;l++){let{$from:c,$to:a}=o[l],h=t.mapping.slice(i);t.replaceRange(h.map(c.pos),h.map(a.pos),l?x.empty:e),l==0&&po(t,i,(s?s.isInline:r&&r.isTextblock)?-1:1)}}replaceWith(t,e){let s=t.steps.length,r=this.ranges;for(let i=0;i<r.length;i++){let{$from:o,$to:l}=r[i],c=t.mapping.slice(s),a=c.map(o.pos),h=c.map(l.pos);i?t.deleteRange(a,h):(t.replaceRangeWith(a,h,e),po(t,s,e.isInline?-1:1))}}static findFrom(t,e,s=!1){let r=t.parent.inlineContent?new L(t):Fe(t.node(0),t.parent,t.pos,t.index(),e,s);if(r)return r;for(let i=t.depth-1;i>=0;i--){let o=e<0?Fe(t.node(0),t.node(i),t.before(i+1),t.index(i),e,s):Fe(t.node(0),t.node(i),t.after(i+1),t.index(i)+1,e,s);if(o)return o}return null}static near(t,e=1){return this.findFrom(t,e)||this.findFrom(t,-e)||new Dt(t.node(0))}static atStart(t){return Fe(t,t,0,0,1)||new Dt(t)}static atEnd(t){return Fe(t,t,t.content.size,t.childCount,-1)||new Dt(t)}static fromJSON(t,e){if(!e||!e.type)throw new RangeError("Invalid input for Selection.fromJSON");let s=Zs[e.type];if(!s)throw new RangeError(`No selection type ${e.type} defined`);return s.fromJSON(t,e)}static jsonID(t,e){if(t in Zs)throw new RangeError("Duplicate use of selection JSON ID "+t);return Zs[t]=e,e.prototype.jsonID=t,e}getBookmark(){return L.between(this.$anchor,this.$head).getBookmark()}}U.prototype.visible=!0;class ad{constructor(t,e){this.$from=t,this.$to=e}}let uo=!1;function fo(n){!uo&&!n.parent.inlineContent&&(uo=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+n.parent.type.name+")"))}class L extends U{constructor(t,e=t){fo(t),fo(e),super(t,e)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(t,e){let s=t.resolve(e.map(this.head));if(!s.parent.inlineContent)return U.near(s);let r=t.resolve(e.map(this.anchor));return new L(r.parent.inlineContent?r:s,s)}replace(t,e=x.empty){if(super.replace(t,e),e==x.empty){let s=this.$from.marksAcross(this.$to);s&&t.ensureMarks(s)}}eq(t){return t instanceof L&&t.anchor==this.anchor&&t.head==this.head}getBookmark(){return new Ds(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(t,e){if(typeof e.anchor!="number"||typeof e.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new L(t.resolve(e.anchor),t.resolve(e.head))}static create(t,e,s=e){let r=t.resolve(e);return new this(r,s==e?r:t.resolve(s))}static between(t,e,s){let r=t.pos-e.pos;if((!s||r)&&(s=r>=0?1:-1),!e.parent.inlineContent){let i=U.findFrom(e,s,!0)||U.findFrom(e,-s,!0);if(i)e=i.$head;else return U.near(e,s)}return t.parent.inlineContent||(r==0?t=e:(t=(U.findFrom(t,-s,!0)||U.findFrom(t,s,!0)).$anchor,t.pos<e.pos!=r<0&&(t=e))),new L(t,e)}}U.jsonID("text",L);class Ds{constructor(t,e){this.anchor=t,this.head=e}map(t){return new Ds(t.map(this.anchor),t.map(this.head))}resolve(t){return L.between(t.resolve(this.anchor),t.resolve(this.head))}}class T extends U{constructor(t){let e=t.nodeAfter,s=t.node(0).resolve(t.pos+e.nodeSize);super(t,s),this.node=e}map(t,e){let{deleted:s,pos:r}=e.mapResult(this.anchor),i=t.resolve(r);return s?U.near(i):new T(i)}content(){return new x(_.from(this.node),0,0)}eq(t){return t instanceof T&&t.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new hi(this.anchor)}static fromJSON(t,e){if(typeof e.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new T(t.resolve(e.anchor))}static create(t,e){return new T(t.resolve(e))}static isSelectable(t){return!t.isText&&t.type.spec.selectable!==!1}}T.prototype.visible=!1;U.jsonID("node",T);class hi{constructor(t){this.anchor=t}map(t){let{deleted:e,pos:s}=t.mapResult(this.anchor);return e?new Ds(s,s):new hi(s)}resolve(t){let e=t.resolve(this.anchor),s=e.nodeAfter;return s&&T.isSelectable(s)?new T(e):U.near(e)}}class Dt extends U{constructor(t){super(t.resolve(0),t.resolve(t.content.size))}replace(t,e=x.empty){if(e==x.empty){t.delete(0,t.doc.content.size);let s=U.atStart(t.doc);s.eq(t.selection)||t.setSelection(s)}else super.replace(t,e)}toJSON(){return{type:"all"}}static fromJSON(t){return new Dt(t)}map(t){return new Dt(t)}eq(t){return t instanceof Dt}getBookmark(){return hd}}U.jsonID("all",Dt);const hd={map(){return this},resolve(n){return new Dt(n)}};function Fe(n,t,e,s,r,i=!1){if(t.inlineContent)return L.create(n,e);for(let o=s-(r>0?0:1);r>0?o<t.childCount:o>=0;o+=r){let l=t.child(o);if(l.isAtom){if(!i&&T.isSelectable(l))return T.create(n,e-(r<0?l.nodeSize:0))}else{let c=Fe(n,l,e+r,r<0?l.childCount:0,r,i);if(c)return c}e+=l.nodeSize*r}return null}function po(n,t,e){let s=n.steps.length-1;if(s<t)return;let r=n.steps[s];if(!(r instanceof Jt||r instanceof Je))return;let i=n.mapping.maps[s],o;i.forEach((l,c,a,h)=>{o==null&&(o=h)}),n.setSelection(U.near(n.doc.resolve(o),e))}function go(n,t){return!t||!n?n:n.bind(t)}class Kn{constructor(t,e,s){this.name=t,this.init=go(e.init,s),this.apply=go(e.apply,s)}}new Kn("doc",{init(n){return n.doc||n.schema.topNodeType.createAndFill()},apply(n){return n.doc}}),new Kn("selection",{init(n,t){return n.selection||U.atStart(t.doc)},apply(n){return n.selection}}),new Kn("storedMarks",{init(n){return n.storedMarks||null},apply(n,t,e,s){return s.selection.$cursor?n.storedMarks:null}}),new Kn("scrollToSelection",{init(){return 0},apply(n,t){return n.scrolledIntoView?t+1:t}});function ic(n,t,e){for(let s in n){let r=n[s];r instanceof Function?r=r.bind(t):s=="handleDOMEvents"&&(r=ic(r,t,{})),e[s]=r}return e}class ui{constructor(t){this.spec=t,this.props={},t.props&&ic(t.props,this,this.props),this.key=t.key?t.key.key:oc("plugin")}getState(t){return t[this.key]}}const Qs=Object.create(null);function oc(n){return n in Qs?n+"$"+ ++Qs[n]:(Qs[n]=0,n+"$")}class fi{constructor(t="key"){this.key=oc(t)}get(t){return t.config.pluginsByKey[this.key]}getState(t){return t[this.key]}}const Oe=function(n){for(var t=0;;t++)if(n=n.previousSibling,!n)return t},lc=function(n,t,e,s){return e&&(mo(n,t,e,s,-1)||mo(n,t,e,s,1))},ud=/^(img|br|input|textarea|hr)$/i;function mo(n,t,e,s,r){for(var i;;){if(n==e&&t==s)return!0;if(t==(r<0?0:us(n))){let o=n.parentNode;if(!o||o.nodeType!=1||di(n)||ud.test(n.nodeName)||n.contentEditable=="false")return!1;t=Oe(n)+(r<0?0:1),n=o}else if(n.nodeType==1){let o=n.childNodes[t+(r<0?-1:0)];if(o.nodeType==1&&o.contentEditable=="false")if(!((i=o.pmViewDesc)===null||i===void 0)&&i.ignoreForSelection)t+=r;else return!1;else n=o,t=r<0?us(n):0}else return!1}}function us(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function fd(n,t,e){for(let s=t==0,r=t==us(n);s||r;){if(n==e)return!0;let i=Oe(n);if(n=n.parentNode,!n)return!1;s=s&&i==0,r=r&&i==us(n)}}function di(n){let t;for(let e=n;e&&!(t=e.pmViewDesc);e=e.parentNode);return t&&t.node&&t.node.isBlock&&(t.dom==n||t.contentDOM==n)}const cc=function(n){return n.focusNode&&lc(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset)};function ac(n,t){let e=document.createEvent("Event");return e.initEvent("keydown",!0,!0),e.keyCode=n,e.key=e.code=t,e}const Ut=typeof navigator<"u"?navigator:null,yo=typeof document<"u"?document:null,he=Ut&&Ut.userAgent||"",kr=/Edge\/(\d+)/.exec(he),hc=/MSIE \d/.exec(he),Cr=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(he),Fn=!!(hc||Cr||kr),uc=hc?document.documentMode:Cr?+Cr[1]:kr?+kr[1]:0,Ts=!Fn&&/gecko\/(\d+)/i.test(he);Ts&&+(/Firefox\/(\d+)/.exec(he)||[0,0])[1];const _r=!Fn&&/Chrome\/(\d+)/.exec(he),ue=!!_r,fc=_r?+_r[1]:0,Ie=!Fn&&!!Ut&&/Apple Computer/.test(Ut.vendor),pi=Ie&&(/Mobile\/\w+/.test(he)||!!Ut&&Ut.maxTouchPoints>2),wt=pi||(Ut?/Mac/.test(Ut.platform):!1),dd=Ut?/Win/.test(Ut.platform):!1,zn=/Android \d/.test(he),gi=!!yo&&"webkitFontSmoothing"in yo.documentElement.style,pd=gi?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function gd(n,t=null){let e=n.domSelectionRange(),s=n.state.doc;if(!e.focusNode)return null;let r=n.docView.nearestDesc(e.focusNode),i=r&&r.size==0,o=n.docView.posFromDOM(e.focusNode,e.focusOffset,1);if(o<0)return null;let l=s.resolve(o),c,a;if(cc(e)){for(c=o;r&&!r.node;)r=r.parent;let u=r.node;if(r&&u.isAtom&&T.isSelectable(u)&&r.parent&&!(u.isInline&&fd(e.focusNode,e.focusOffset,r.dom))){let f=r.posBefore;a=new T(o==f?l:s.resolve(f))}}else{if(e instanceof n.dom.ownerDocument.defaultView.Selection&&e.rangeCount>1){let u=o,f=o;for(let d=0;d<e.rangeCount;d++){let p=e.getRangeAt(d);u=Math.min(u,n.docView.posFromDOM(p.startContainer,p.startOffset,1)),f=Math.max(f,n.docView.posFromDOM(p.endContainer,p.endOffset,-1))}if(u<0)return null;[c,o]=f==n.state.selection.anchor?[f,u]:[u,f],l=s.resolve(o)}else c=n.docView.posFromDOM(e.anchorNode,e.anchorOffset,1);if(c<0)return null}let h=s.resolve(c);if(!a){let u=t=="pointer"||n.state.selection.head<l.pos&&!i?1:-1;a=pc(n,h,l,u)}return a}function dc(n){return n.editable?n.hasFocus():wd(n)&&document.activeElement&&document.activeElement.contains(n.dom)}function mi(n,t=!1){let e=n.state.selection;if(bd(n,e),!!dc(n)){if(!t&&n.input.mouseDown&&n.input.mouseDown.allowDefault&&ue){let s=n.domSelectionRange(),r=n.domObserver.currentSelection;if(s.anchorNode&&r.anchorNode&&lc(s.anchorNode,s.anchorOffset,r.anchorNode,r.anchorOffset)){n.input.mouseDown.delayedSelectionSync=!0,n.domObserver.setCurSelection();return}}if(n.domObserver.disconnectSelection(),n.cursorWrapper)yd(n);else{let{anchor:s,head:r}=e,i,o;bo&&!(e instanceof L)&&(e.$from.parent.inlineContent||(i=wo(n,e.from)),!e.empty&&!e.$from.parent.inlineContent&&(o=wo(n,e.to))),n.docView.setSelection(s,r,n,t),bo&&(i&&So(i),o&&So(o)),e.visible?n.dom.classList.remove("ProseMirror-hideselection"):(n.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&md(n))}n.domObserver.setCurSelection(),n.domObserver.connectSelection()}}const bo=Ie||ue&&fc<63;function wo(n,t){let{node:e,offset:s}=n.docView.domFromPos(t,0),r=s<e.childNodes.length?e.childNodes[s]:null,i=s?e.childNodes[s-1]:null;if(Ie&&r&&r.contentEditable=="false")return tr(r);if((!r||r.contentEditable=="false")&&(!i||i.contentEditable=="false")){if(r)return tr(r);if(i)return tr(i)}}function tr(n){return n.contentEditable="true",Ie&&n.draggable&&(n.draggable=!1,n.wasDraggable=!0),n}function So(n){n.contentEditable="false",n.wasDraggable&&(n.draggable=!0,n.wasDraggable=null)}function md(n){let t=n.dom.ownerDocument;t.removeEventListener("selectionchange",n.input.hideSelectionGuard);let e=n.domSelectionRange(),s=e.anchorNode,r=e.anchorOffset;t.addEventListener("selectionchange",n.input.hideSelectionGuard=()=>{(e.anchorNode!=s||e.anchorOffset!=r)&&(t.removeEventListener("selectionchange",n.input.hideSelectionGuard),setTimeout(()=>{(!dc(n)||n.state.selection.visible)&&n.dom.classList.remove("ProseMirror-hideselection")},20))})}function yd(n){let t=n.domSelection();if(!t)return;let e=n.cursorWrapper.dom,s=e.nodeName=="IMG";s?t.collapse(e.parentNode,Oe(e)+1):t.collapse(e,0),!s&&!n.state.selection.visible&&Fn&&uc<=11&&(e.disabled=!0,e.disabled=!1)}function bd(n,t){if(t instanceof T){let e=n.docView.descAt(t.from);e!=n.lastSelectedViewDesc&&(ko(n),e&&e.selectNode(),n.lastSelectedViewDesc=e)}else ko(n)}function ko(n){n.lastSelectedViewDesc&&(n.lastSelectedViewDesc.parent&&n.lastSelectedViewDesc.deselectNode(),n.lastSelectedViewDesc=void 0)}function pc(n,t,e,s){return n.someProp("createSelectionBetween",r=>r(n,t,e))||L.between(t,e,s)}function wd(n){let t=n.domSelectionRange();if(!t.anchorNode)return!1;try{return n.dom.contains(t.anchorNode.nodeType==3?t.anchorNode.parentNode:t.anchorNode)&&(n.editable||n.dom.contains(t.focusNode.nodeType==3?t.focusNode.parentNode:t.focusNode))}catch{return!1}}function xr(n,t){let{$anchor:e,$head:s}=n.selection,r=t>0?e.max(s):e.min(s),i=r.parent.inlineContent?r.depth?n.doc.resolve(t>0?r.after():r.before()):null:r;return i&&U.findFrom(i,t)}function Xt(n,t){return n.dispatch(n.state.tr.setSelection(t).scrollIntoView()),!0}function Co(n,t,e){let s=n.state.selection;if(s instanceof L)if(e.indexOf("s")>-1){let{$head:r}=s,i=r.textOffset?null:t<0?r.nodeBefore:r.nodeAfter;if(!i||i.isText||!i.isLeaf)return!1;let o=n.state.doc.resolve(r.pos+i.nodeSize*(t<0?-1:1));return Xt(n,new L(s.$anchor,o))}else if(s.empty){if(n.endOfTextblock(t>0?"forward":"backward")){let r=xr(n.state,t);return r&&r instanceof T?Xt(n,r):!1}else if(!(wt&&e.indexOf("m")>-1)){let r=s.$head,i=r.textOffset?null:t<0?r.nodeBefore:r.nodeAfter,o;if(!i||i.isText)return!1;let l=t<0?r.pos-i.nodeSize:r.pos;return i.isAtom||(o=n.docView.descAt(l))&&!o.contentDOM?T.isSelectable(i)?Xt(n,new T(t<0?n.state.doc.resolve(r.pos-i.nodeSize):r)):gi?Xt(n,new L(n.state.doc.resolve(t<0?l:l+i.nodeSize))):!1:!1}}else return!1;else{if(s instanceof T&&s.node.isInline)return Xt(n,new L(t>0?s.$to:s.$from));{let r=xr(n.state,t);return r?Xt(n,r):!1}}}function fs(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function fn(n,t){let e=n.pmViewDesc;return e&&e.size==0&&(t<0||n.nextSibling||n.nodeName!="BR")}function Re(n,t){return t<0?Sd(n):kd(n)}function Sd(n){let t=n.domSelectionRange(),e=t.focusNode,s=t.focusOffset;if(!e)return;let r,i,o=!1;for(Ts&&e.nodeType==1&&s<fs(e)&&fn(e.childNodes[s],-1)&&(o=!0);;)if(s>0){if(e.nodeType!=1)break;{let l=e.childNodes[s-1];if(fn(l,-1))r=e,i=--s;else if(l.nodeType==3)e=l,s=e.nodeValue.length;else break}}else{if(gc(e))break;{let l=e.previousSibling;for(;l&&fn(l,-1);)r=e.parentNode,i=Oe(l),l=l.previousSibling;if(l)e=l,s=fs(e);else{if(e=e.parentNode,e==n.dom)break;s=0}}}o?Er(n,e,s):r&&Er(n,r,i)}function kd(n){let t=n.domSelectionRange(),e=t.focusNode,s=t.focusOffset;if(!e)return;let r=fs(e),i,o;for(;;)if(s<r){if(e.nodeType!=1)break;let l=e.childNodes[s];if(fn(l,1))i=e,o=++s;else break}else{if(gc(e))break;{let l=e.nextSibling;for(;l&&fn(l,1);)i=l.parentNode,o=Oe(l)+1,l=l.nextSibling;if(l)e=l,s=0,r=fs(e);else{if(e=e.parentNode,e==n.dom)break;s=r=0}}}i&&Er(n,i,o)}function gc(n){let t=n.pmViewDesc;return t&&t.node&&t.node.isBlock}function Cd(n,t){for(;n&&t==n.childNodes.length&&!di(n);)t=Oe(n)+1,n=n.parentNode;for(;n&&t<n.childNodes.length;){let e=n.childNodes[t];if(e.nodeType==3)return e;if(e.nodeType==1&&e.contentEditable=="false")break;n=e,t=0}}function _d(n,t){for(;n&&!t&&!di(n);)t=Oe(n),n=n.parentNode;for(;n&&t;){let e=n.childNodes[t-1];if(e.nodeType==3)return e;if(e.nodeType==1&&e.contentEditable=="false")break;n=e,t=n.childNodes.length}}function Er(n,t,e){if(t.nodeType!=3){let i,o;(o=Cd(t,e))?(t=o,e=0):(i=_d(t,e))&&(t=i,e=i.nodeValue.length)}let s=n.domSelection();if(!s)return;if(cc(s)){let i=document.createRange();i.setEnd(t,e),i.setStart(t,e),s.removeAllRanges(),s.addRange(i)}else s.extend&&s.extend(t,e);n.domObserver.setCurSelection();let{state:r}=n;setTimeout(()=>{n.state==r&&mi(n)},50)}function _o(n,t){let e=n.state.doc.resolve(t);if(!(ue||dd)&&e.parent.inlineContent){let r=n.coordsAtPos(t);if(t>e.start()){let i=n.coordsAtPos(t-1),o=(i.top+i.bottom)/2;if(o>r.top&&o<r.bottom&&Math.abs(i.left-r.left)>1)return i.left<r.left?"ltr":"rtl"}if(t<e.end()){let i=n.coordsAtPos(t+1),o=(i.top+i.bottom)/2;if(o>r.top&&o<r.bottom&&Math.abs(i.left-r.left)>1)return i.left>r.left?"ltr":"rtl"}}return getComputedStyle(n.dom).direction=="rtl"?"rtl":"ltr"}function xo(n,t,e){let s=n.state.selection;if(s instanceof L&&!s.empty||e.indexOf("s")>-1||wt&&e.indexOf("m")>-1)return!1;let{$from:r,$to:i}=s;if(!r.parent.inlineContent||n.endOfTextblock(t<0?"up":"down")){let o=xr(n.state,t);if(o&&o instanceof T)return Xt(n,o)}if(!r.parent.inlineContent){let o=t<0?r:i,l=s instanceof Dt?U.near(o,t):U.findFrom(o,t);return l?Xt(n,l):!1}return!1}function Eo(n,t){if(!(n.state.selection instanceof L))return!0;let{$head:e,$anchor:s,empty:r}=n.state.selection;if(!e.sameParent(s))return!0;if(!r)return!1;if(n.endOfTextblock(t>0?"forward":"backward"))return!0;let i=!e.textOffset&&(t<0?e.nodeBefore:e.nodeAfter);if(i&&!i.isText){let o=n.state.tr;return t<0?o.delete(e.pos-i.nodeSize,e.pos):o.delete(e.pos,e.pos+i.nodeSize),n.dispatch(o),!0}return!1}function Do(n,t,e){n.domObserver.stop(),t.contentEditable=e,n.domObserver.start()}function xd(n){if(!Ie||n.state.selection.$head.parentOffset>0)return!1;let{focusNode:t,focusOffset:e}=n.domSelectionRange();if(t&&t.nodeType==1&&e==0&&t.firstChild&&t.firstChild.contentEditable=="false"){let s=t.firstChild;Do(n,s,"true"),setTimeout(()=>Do(n,s,"false"),20)}return!1}function Ed(n){let t="";return n.ctrlKey&&(t+="c"),n.metaKey&&(t+="m"),n.altKey&&(t+="a"),n.shiftKey&&(t+="s"),t}function Dd(n,t){let e=t.keyCode,s=Ed(t);if(e==8||wt&&e==72&&s=="c")return Eo(n,-1)||Re(n,-1);if(e==46&&!t.shiftKey||wt&&e==68&&s=="c")return Eo(n,1)||Re(n,1);if(e==13||e==27)return!0;if(e==37||wt&&e==66&&s=="c"){let r=e==37?_o(n,n.state.selection.from)=="ltr"?-1:1:-1;return Co(n,r,s)||Re(n,r)}else if(e==39||wt&&e==70&&s=="c"){let r=e==39?_o(n,n.state.selection.from)=="ltr"?1:-1:1;return Co(n,r,s)||Re(n,r)}else{if(e==38||wt&&e==80&&s=="c")return xo(n,-1,s)||Re(n,-1);if(e==40||wt&&e==78&&s=="c")return xd(n)||xo(n,1,s)||Re(n,1);if(s==(wt?"m":"c")&&(e==66||e==73||e==89||e==90))return!0}return!1}function mc(n,t){n.someProp("transformCopied",d=>{t=d(t,n)});let e=[],{content:s,openStart:r,openEnd:i}=t;for(;r>1&&i>1&&s.childCount==1&&s.firstChild.childCount==1;){r--,i--;let d=s.firstChild;e.push(d.type.name,d.attrs!=d.type.defaultAttrs?d.attrs:null),s=d.content}let o=n.someProp("clipboardSerializer")||Es.fromSchema(n.state.schema),l=Cc(),c=l.createElement("div");c.appendChild(o.serializeFragment(s,{document:l}));let a=c.firstChild,h,u=0;for(;a&&a.nodeType==1&&(h=kc[a.nodeName.toLowerCase()]);){for(let d=h.length-1;d>=0;d--){let p=l.createElement(h[d]);for(;c.firstChild;)p.appendChild(c.firstChild);c.appendChild(p),u++}a=c.firstChild}a&&a.nodeType==1&&a.setAttribute("data-pm-slice",`${r} ${i}${u?` -${u}`:""} ${JSON.stringify(e)}`);let f=n.someProp("clipboardTextSerializer",d=>d(t,n))||t.content.textBetween(0,t.content.size,`

`);return{dom:c,text:f,slice:t}}function yc(n,t,e,s,r){let i=r.parent.type.spec.code,o,l;if(!e&&!t)return null;let c=!!t&&(s||i||!e);if(c){if(n.someProp("transformPastedText",f=>{t=f(t,i||s,n)}),i)return l=new x(_.from(n.state.schema.text(t.replace(/\r\n?/g,`
`))),0,0),n.someProp("transformPasted",f=>{l=f(l,n,!0)}),l;let u=n.someProp("clipboardTextParser",f=>f(t,r,s,n));if(u)l=u;else{let f=r.marks(),{schema:d}=n.state,p=Es.fromSchema(d);o=document.createElement("div"),t.split(/(?:\r\n?|\n)+/).forEach(g=>{let m=o.appendChild(document.createElement("p"));g&&m.appendChild(p.serializeNode(d.text(g,f)))})}}else n.someProp("transformPastedHTML",u=>{e=u(e,n)}),o=Od(e),gi&&Id(o);let a=o&&o.querySelector("[data-pm-slice]"),h=a&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(a.getAttribute("data-pm-slice")||"");if(h&&h[3])for(let u=+h[3];u>0;u--){let f=o.firstChild;for(;f&&f.nodeType!=1;)f=f.nextSibling;if(!f)break;o=f}if(l||(l=(n.someProp("clipboardParser")||n.someProp("domParser")||td.fromSchema(n.state.schema)).parseSlice(o,{preserveWhitespace:!!(c||h),context:r,ruleFromNode(f){return f.nodeName=="BR"&&!f.nextSibling&&f.parentNode&&!Td.test(f.parentNode.nodeName)?{ignore:!0}:null}})),h)l=Md(To(l,+h[1],+h[2]),h[4]);else if(l=x.maxOpen(Ad(l.content,r),!0),l.openStart||l.openEnd){let u=0,f=0;for(let d=l.content.firstChild;u<l.openStart&&!d.type.spec.isolating;u++,d=d.firstChild);for(let d=l.content.lastChild;f<l.openEnd&&!d.type.spec.isolating;f++,d=d.lastChild);l=To(l,u,f)}return n.someProp("transformPasted",u=>{l=u(l,n,c)}),l}const Td=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Ad(n,t){if(n.childCount<2)return n;for(let e=t.depth;e>=0;e--){let r=t.node(e).contentMatchAt(t.index(e)),i,o=[];if(n.forEach(l=>{if(!o)return;let c=r.findWrapping(l.type),a;if(!c)return o=null;if(a=o.length&&i.length&&wc(c,i,l,o[o.length-1],0))o[o.length-1]=a;else{o.length&&(o[o.length-1]=Sc(o[o.length-1],i.length));let h=bc(l,c);o.push(h),r=r.matchType(h.type),i=c}}),o)return _.from(o)}return n}function bc(n,t,e=0){for(let s=t.length-1;s>=e;s--)n=t[s].create(null,_.from(n));return n}function wc(n,t,e,s,r){if(r<n.length&&r<t.length&&n[r]==t[r]){let i=wc(n,t,e,s.lastChild,r+1);if(i)return s.copy(s.content.replaceChild(s.childCount-1,i));if(s.contentMatchAt(s.childCount).matchType(r==n.length-1?e.type:n[r+1]))return s.copy(s.content.append(_.from(bc(e,n,r+1))))}}function Sc(n,t){if(t==0)return n;let e=n.content.replaceChild(n.childCount-1,Sc(n.lastChild,t-1)),s=n.contentMatchAt(n.childCount).fillBefore(_.empty,!0);return n.copy(e.append(s))}function Dr(n,t,e,s,r,i){let o=t<0?n.firstChild:n.lastChild,l=o.content;return n.childCount>1&&(i=0),r<s-1&&(l=Dr(l,t,e,s,r+1,i)),r>=e&&(l=t<0?o.contentMatchAt(0).fillBefore(l,i<=r).append(l):l.append(o.contentMatchAt(o.childCount).fillBefore(_.empty,!0))),n.replaceChild(t<0?0:n.childCount-1,o.copy(l))}function To(n,t,e){return t<n.openStart&&(n=new x(Dr(n.content,-1,t,n.openStart,0,n.openEnd),t,n.openEnd)),e<n.openEnd&&(n=new x(Dr(n.content,1,e,n.openEnd,0,0),n.openStart,e)),n}const kc={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let Ao=null;function Cc(){return Ao||(Ao=document.implementation.createHTMLDocument("title"))}let er=null;function vd(n){let t=window.trustedTypes;return t?(er||(er=t.defaultPolicy||t.createPolicy("ProseMirrorClipboard",{createHTML:e=>e})),er.createHTML(n)):n}function Od(n){let t=/^(\s*<meta [^>]*>)*/.exec(n);t&&(n=n.slice(t[0].length));let e=Cc().createElement("div"),s=/<([a-z][^>\s]+)/i.exec(n),r;if((r=s&&kc[s[1].toLowerCase()])&&(n=r.map(i=>"<"+i+">").join("")+n+r.map(i=>"</"+i+">").reverse().join("")),e.innerHTML=vd(n),r)for(let i=0;i<r.length;i++)e=e.querySelector(r[i])||e;return e}function Id(n){let t=n.querySelectorAll(ue?"span:not([class]):not([style])":"span.Apple-converted-space");for(let e=0;e<t.length;e++){let s=t[e];s.childNodes.length==1&&s.textContent==" "&&s.parentNode&&s.parentNode.replaceChild(n.ownerDocument.createTextNode(" "),s)}}function Md(n,t){if(!n.size)return n;let e=n.content.firstChild.type.schema,s;try{s=JSON.parse(t)}catch{return n}let{content:r,openStart:i,openEnd:o}=n;for(let l=s.length-2;l>=0;l-=2){let c=e.nodes[s[l]];if(!c||c.hasRequiredAttrs())break;r=_.from(c.create(s[l+1],r)),i++,o++}return new x(r,i,o)}const It={},pt={};function te(n,t){n.input.lastSelectionOrigin=t,n.input.lastSelectionTime=Date.now()}pt.keydown=(n,t)=>{let e=t;if(n.input.shiftKey=e.keyCode==16||e.shiftKey,!xc(n,e)&&(n.input.lastKeyCode=e.keyCode,n.input.lastKeyCodeTime=Date.now(),!(zn&&ue&&e.keyCode==13)))if(e.keyCode!=229&&n.domObserver.forceFlush(),pi&&e.keyCode==13&&!e.ctrlKey&&!e.altKey&&!e.metaKey){let s=Date.now();n.input.lastIOSEnter=s,n.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{n.input.lastIOSEnter==s&&(n.someProp("handleKeyDown",r=>r(n,ac(13,"Enter"))),n.input.lastIOSEnter=0)},200)}else n.someProp("handleKeyDown",s=>s(n,e))||Dd(n,e)?e.preventDefault():te(n,"key")};pt.keyup=(n,t)=>{t.keyCode==16&&(n.input.shiftKey=!1)};pt.keypress=(n,t)=>{let e=t;if(xc(n,e)||!e.charCode||e.ctrlKey&&!e.altKey||wt&&e.metaKey)return;if(n.someProp("handleKeyPress",r=>r(n,e))){e.preventDefault();return}let s=n.state.selection;if(!(s instanceof L)||!s.$from.sameParent(s.$to)){let r=String.fromCharCode(e.charCode),i=()=>n.state.tr.insertText(r).scrollIntoView();!/[\r\n]/.test(r)&&!n.someProp("handleTextInput",o=>o(n,s.$from.pos,s.$to.pos,r,i))&&n.dispatch(i()),e.preventDefault()}};function As(n){return{left:n.clientX,top:n.clientY}}function Nd(n,t){let e=t.x-n.clientX,s=t.y-n.clientY;return e*e+s*s<100}function yi(n,t,e,s,r){if(s==-1)return!1;let i=n.state.doc.resolve(s);for(let o=i.depth+1;o>0;o--)if(n.someProp(t,l=>o>i.depth?l(n,e,i.nodeAfter,i.before(o),r,!0):l(n,e,i.node(o),i.before(o),r,!1)))return!0;return!1}function He(n,t,e){if(n.focused||n.focus(),n.state.selection.eq(t))return;let s=n.state.tr.setSelection(t);s.setMeta("pointer",!0),n.dispatch(s)}function Rd(n,t){if(t==-1)return!1;let e=n.state.doc.resolve(t),s=e.nodeAfter;return s&&s.isAtom&&T.isSelectable(s)?(He(n,new T(e)),!0):!1}function Ld(n,t){if(t==-1)return!1;let e=n.state.selection,s,r;e instanceof T&&(s=e.node);let i=n.state.doc.resolve(t);for(let o=i.depth+1;o>0;o--){let l=o>i.depth?i.nodeAfter:i.node(o);if(T.isSelectable(l)){s&&e.$from.depth>0&&o>=e.$from.depth&&i.before(e.$from.depth+1)==e.$from.pos?r=i.before(e.$from.depth):r=i.before(o);break}}return r!=null?(He(n,T.create(n.state.doc,r)),!0):!1}function Fd(n,t,e,s,r){return yi(n,"handleClickOn",t,e,s)||n.someProp("handleClick",i=>i(n,t,s))||(r?Ld(n,e):Rd(n,e))}function zd(n,t,e,s){return yi(n,"handleDoubleClickOn",t,e,s)||n.someProp("handleDoubleClick",r=>r(n,t,s))}function Ud(n,t,e,s){return yi(n,"handleTripleClickOn",t,e,s)||n.someProp("handleTripleClick",r=>r(n,t,s))||Vd(n,e,s)}function Vd(n,t,e){if(e.button!=0)return!1;let s=n.state.doc;if(t==-1)return s.inlineContent?(He(n,L.create(s,0,s.content.size)),!0):!1;let r=s.resolve(t);for(let i=r.depth+1;i>0;i--){let o=i>r.depth?r.nodeAfter:r.node(i),l=r.before(i);if(o.inlineContent)He(n,L.create(s,l+1,l+1+o.content.size));else if(T.isSelectable(o))He(n,T.create(s,l));else continue;return!0}}function bi(n){return ds(n)}const _c=wt?"metaKey":"ctrlKey";It.mousedown=(n,t)=>{let e=t;n.input.shiftKey=e.shiftKey;let s=bi(n),r=Date.now(),i="singleClick";r-n.input.lastClick.time<500&&Nd(e,n.input.lastClick)&&!e[_c]&&n.input.lastClick.button==e.button&&(n.input.lastClick.type=="singleClick"?i="doubleClick":n.input.lastClick.type=="doubleClick"&&(i="tripleClick")),n.input.lastClick={time:r,x:e.clientX,y:e.clientY,type:i,button:e.button};let o=n.posAtCoords(As(e));o&&(i=="singleClick"?(n.input.mouseDown&&n.input.mouseDown.done(),n.input.mouseDown=new Pd(n,o,e,!!s)):(i=="doubleClick"?zd:Ud)(n,o.pos,o.inside,e)?e.preventDefault():te(n,"pointer"))};class Pd{constructor(t,e,s,r){this.view=t,this.pos=e,this.event=s,this.flushed=r,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=t.state.doc,this.selectNode=!!s[_c],this.allowDefault=s.shiftKey;let i,o;if(e.inside>-1)i=t.state.doc.nodeAt(e.inside),o=e.inside;else{let h=t.state.doc.resolve(e.pos);i=h.parent,o=h.depth?h.before():0}const l=r?null:s.target,c=l?t.docView.nearestDesc(l,!0):null;this.target=c&&c.nodeDOM.nodeType==1?c.nodeDOM:null;let{selection:a}=t.state;(s.button==0&&i.type.spec.draggable&&i.type.spec.selectable!==!1||a instanceof T&&a.from<=o&&a.to>o)&&(this.mightDrag={node:i,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Ts&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),t.root.addEventListener("mouseup",this.up=this.up.bind(this)),t.root.addEventListener("mousemove",this.move=this.move.bind(this)),te(t,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>mi(this.view)),this.view.input.mouseDown=null}up(t){if(this.done(),!this.view.dom.contains(t.target))return;let e=this.pos;this.view.state.doc!=this.startDoc&&(e=this.view.posAtCoords(As(t))),this.updateAllowDefault(t),this.allowDefault||!e?te(this.view,"pointer"):Fd(this.view,e.pos,e.inside,t,this.selectNode)?t.preventDefault():t.button==0&&(this.flushed||Ie&&this.mightDrag&&!this.mightDrag.node.isAtom||ue&&!this.view.state.selection.visible&&Math.min(Math.abs(e.pos-this.view.state.selection.from),Math.abs(e.pos-this.view.state.selection.to))<=2)?(He(this.view,U.near(this.view.state.doc.resolve(e.pos))),t.preventDefault()):te(this.view,"pointer")}move(t){this.updateAllowDefault(t),te(this.view,"pointer"),t.buttons==0&&this.done()}updateAllowDefault(t){!this.allowDefault&&(Math.abs(this.event.x-t.clientX)>4||Math.abs(this.event.y-t.clientY)>4)&&(this.allowDefault=!0)}}It.touchstart=n=>{n.input.lastTouch=Date.now(),bi(n),te(n,"pointer")};It.touchmove=n=>{n.input.lastTouch=Date.now(),te(n,"pointer")};It.contextmenu=n=>bi(n);function xc(n,t){return n.composing?!0:Ie&&Math.abs(t.timeStamp-n.input.compositionEndedAt)<500?(n.input.compositionEndedAt=-2e8,!0):!1}const Bd=zn?5e3:-1;pt.compositionstart=pt.compositionupdate=n=>{if(!n.composing){n.domObserver.flush();let{state:t}=n,e=t.selection.$to;if(t.selection instanceof L&&(t.storedMarks||!e.textOffset&&e.parentOffset&&e.nodeBefore.marks.some(s=>s.type.spec.inclusive===!1)))n.markCursor=n.state.storedMarks||e.marks(),ds(n,!0),n.markCursor=null;else if(ds(n,!t.selection.empty),Ts&&t.selection.empty&&e.parentOffset&&!e.textOffset&&e.nodeBefore.marks.length){let s=n.domSelectionRange();for(let r=s.focusNode,i=s.focusOffset;r&&r.nodeType==1&&i!=0;){let o=i<0?r.lastChild:r.childNodes[i-1];if(!o)break;if(o.nodeType==3){let l=n.domSelection();l&&l.collapse(o,o.nodeValue.length);break}else r=o,i=-1}}n.input.composing=!0}Ec(n,Bd)};pt.compositionend=(n,t)=>{n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=t.timeStamp,n.input.compositionPendingChanges=n.domObserver.pendingRecords().length?n.input.compositionID:0,n.input.compositionNode=null,n.input.compositionPendingChanges&&Promise.resolve().then(()=>n.domObserver.flush()),n.input.compositionID++,Ec(n,20))};function Ec(n,t){clearTimeout(n.input.composingTimeout),t>-1&&(n.input.composingTimeout=setTimeout(()=>ds(n),t))}function Wd(n){for(n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=Jd());n.input.compositionNodes.length>0;)n.input.compositionNodes.pop().markParentsDirty()}function Jd(){let n=document.createEvent("Event");return n.initEvent("event",!0,!0),n.timeStamp}function ds(n,t=!1){if(!(zn&&n.domObserver.flushingSoon>=0)){if(n.domObserver.forceFlush(),Wd(n),t||n.docView&&n.docView.dirty){let e=gd(n),s=n.state.selection;return e&&!e.eq(s)?n.dispatch(n.state.tr.setSelection(e)):(n.markCursor||t)&&!s.$from.node(s.$from.sharedDepth(s.to)).inlineContent?n.dispatch(n.state.tr.deleteSelection()):n.updateState(n.state),!0}return!1}}function Hd(n,t){if(!n.dom.parentNode)return;let e=n.dom.parentNode.appendChild(document.createElement("div"));e.appendChild(t),e.style.cssText="position: fixed; left: -10000px; top: 10px";let s=getSelection(),r=document.createRange();r.selectNodeContents(t),n.dom.blur(),s.removeAllRanges(),s.addRange(r),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),n.focus()},50)}const Tn=Fn&&uc<15||pi&&pd<604;It.copy=pt.cut=(n,t)=>{let e=t,s=n.state.selection,r=e.type=="cut";if(s.empty)return;let i=Tn?null:e.clipboardData,o=s.content(),{dom:l,text:c}=mc(n,o);i?(e.preventDefault(),i.clearData(),i.setData("text/html",l.innerHTML),i.setData("text/plain",c)):Hd(n,l),r&&n.dispatch(n.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function qd(n){return n.openStart==0&&n.openEnd==0&&n.content.childCount==1?n.content.firstChild:null}function Kd(n,t){if(!n.dom.parentNode)return;let e=n.input.shiftKey||n.state.selection.$from.parent.type.spec.code,s=n.dom.parentNode.appendChild(document.createElement(e?"textarea":"div"));e||(s.contentEditable="true"),s.style.cssText="position: fixed; left: -10000px; top: 10px",s.focus();let r=n.input.shiftKey&&n.input.lastKeyCode!=45;setTimeout(()=>{n.focus(),s.parentNode&&s.parentNode.removeChild(s),e?Tr(n,s.value,null,r,t):Tr(n,s.textContent,s.innerHTML,r,t)},50)}function Tr(n,t,e,s,r){let i=yc(n,t,e,s,n.state.selection.$from);if(n.someProp("handlePaste",c=>c(n,r,i||x.empty)))return!0;if(!i)return!1;let o=qd(i),l=o?n.state.tr.replaceSelectionWith(o,s):n.state.tr.replaceSelection(i);return n.dispatch(l.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function Dc(n){let t=n.getData("text/plain")||n.getData("Text");if(t)return t;let e=n.getData("text/uri-list");return e?e.replace(/\r?\n/g," "):""}pt.paste=(n,t)=>{let e=t;if(n.composing&&!zn)return;let s=Tn?null:e.clipboardData,r=n.input.shiftKey&&n.input.lastKeyCode!=45;s&&Tr(n,Dc(s),s.getData("text/html"),r,e)?e.preventDefault():Kd(n,e)};class Yd{constructor(t,e,s){this.slice=t,this.move=e,this.node=s}}const $d=wt?"altKey":"ctrlKey";function Tc(n,t){let e=n.someProp("dragCopies",s=>!s(t));return e??!t[$d]}It.dragstart=(n,t)=>{let e=t,s=n.input.mouseDown;if(s&&s.done(),!e.dataTransfer)return;let r=n.state.selection,i=r.empty?null:n.posAtCoords(As(e)),o;if(!(i&&i.pos>=r.from&&i.pos<=(r instanceof T?r.to-1:r.to))){if(s&&s.mightDrag)o=T.create(n.state.doc,s.mightDrag.pos);else if(e.target&&e.target.nodeType==1){let u=n.docView.nearestDesc(e.target,!0);u&&u.node.type.spec.draggable&&u!=n.docView&&(o=T.create(n.state.doc,u.posBefore))}}let l=(o||n.state.selection).content(),{dom:c,text:a,slice:h}=mc(n,l);(!e.dataTransfer.files.length||!ue||fc>120)&&e.dataTransfer.clearData(),e.dataTransfer.setData(Tn?"Text":"text/html",c.innerHTML),e.dataTransfer.effectAllowed="copyMove",Tn||e.dataTransfer.setData("text/plain",a),n.dragging=new Yd(h,Tc(n,e),o)};It.dragend=n=>{let t=n.dragging;window.setTimeout(()=>{n.dragging==t&&(n.dragging=null)},50)};pt.dragover=pt.dragenter=(n,t)=>t.preventDefault();pt.drop=(n,t)=>{let e=t,s=n.dragging;if(n.dragging=null,!e.dataTransfer)return;let r=n.posAtCoords(As(e));if(!r)return;let i=n.state.doc.resolve(r.pos),o=s&&s.slice;o?n.someProp("transformPasted",p=>{o=p(o,n,!1)}):o=yc(n,Dc(e.dataTransfer),Tn?null:e.dataTransfer.getData("text/html"),!1,i);let l=!!(s&&Tc(n,e));if(n.someProp("handleDrop",p=>p(n,e,o||x.empty,l))){e.preventDefault();return}if(!o)return;e.preventDefault();let c=o?cd(n.state.doc,i.pos,o):i.pos;c==null&&(c=i.pos);let a=n.state.tr;if(l){let{node:p}=s;p?p.replace(a):a.deleteSelection()}let h=a.mapping.map(c),u=o.openStart==0&&o.openEnd==0&&o.content.childCount==1,f=a.doc;if(u?a.replaceRangeWith(h,h,o.content.firstChild):a.replaceRange(h,h,o),a.doc.eq(f))return;let d=a.doc.resolve(h);if(u&&T.isSelectable(o.content.firstChild)&&d.nodeAfter&&d.nodeAfter.sameMarkup(o.content.firstChild))a.setSelection(new T(d));else{let p=a.mapping.map(c);a.mapping.maps[a.mapping.maps.length-1].forEach((g,m,y,I)=>p=I),a.setSelection(pc(n,d,a.doc.resolve(p)))}n.focus(),n.dispatch(a.setMeta("uiEvent","drop"))};It.focus=n=>{n.input.lastFocus=Date.now(),n.focused||(n.domObserver.stop(),n.dom.classList.add("ProseMirror-focused"),n.domObserver.start(),n.focused=!0,setTimeout(()=>{n.docView&&n.hasFocus()&&!n.domObserver.currentSelection.eq(n.domSelectionRange())&&mi(n)},20))};It.blur=(n,t)=>{let e=t;n.focused&&(n.domObserver.stop(),n.dom.classList.remove("ProseMirror-focused"),n.domObserver.start(),e.relatedTarget&&n.dom.contains(e.relatedTarget)&&n.domObserver.currentSelection.clear(),n.focused=!1)};It.beforeinput=(n,t)=>{if(ue&&zn&&t.inputType=="deleteContentBackward"){n.domObserver.flushSoon();let{domChangeCount:s}=n.input;setTimeout(()=>{if(n.input.domChangeCount!=s||(n.dom.blur(),n.focus(),n.someProp("handleKeyDown",i=>i(n,ac(8,"Backspace")))))return;let{$cursor:r}=n.state.selection;r&&r.pos>0&&n.dispatch(n.state.tr.delete(r.pos-1,r.pos).scrollIntoView())},50)}};for(let n in pt)It[n]=pt[n];function An(n,t){if(n==t)return!0;for(let e in n)if(n[e]!==t[e])return!1;for(let e in t)if(!(e in n))return!1;return!0}class ps{constructor(t,e){this.toDOM=t,this.spec=e||xe,this.side=this.spec.side||0}map(t,e,s,r){let{pos:i,deleted:o}=t.mapResult(e.from+r,this.side<0?-1:1);return o?null:new xt(i-s,i-s,this)}valid(){return!0}eq(t){return this==t||t instanceof ps&&(this.spec.key&&this.spec.key==t.spec.key||this.toDOM==t.toDOM&&An(this.spec,t.spec))}destroy(t){this.spec.destroy&&this.spec.destroy(t)}}class ne{constructor(t,e){this.attrs=t,this.spec=e||xe}map(t,e,s,r){let i=t.map(e.from+r,this.spec.inclusiveStart?-1:1)-s,o=t.map(e.to+r,this.spec.inclusiveEnd?1:-1)-s;return i>=o?null:new xt(i,o,this)}valid(t,e){return e.from<e.to}eq(t){return this==t||t instanceof ne&&An(this.attrs,t.attrs)&&An(this.spec,t.spec)}static is(t){return t.type instanceof ne}destroy(){}}class wi{constructor(t,e){this.attrs=t,this.spec=e||xe}map(t,e,s,r){let i=t.mapResult(e.from+r,1);if(i.deleted)return null;let o=t.mapResult(e.to+r,-1);return o.deleted||o.pos<=i.pos?null:new xt(i.pos-s,o.pos-s,this)}valid(t,e){let{index:s,offset:r}=t.content.findIndex(e.from),i;return r==e.from&&!(i=t.child(s)).isText&&r+i.nodeSize==e.to}eq(t){return this==t||t instanceof wi&&An(this.attrs,t.attrs)&&An(this.spec,t.spec)}destroy(){}}class xt{constructor(t,e,s){this.from=t,this.to=e,this.type=s}copy(t,e){return new xt(t,e,this.type)}eq(t,e=0){return this.type.eq(t.type)&&this.from+e==t.from&&this.to+e==t.to}map(t,e,s){return this.type.map(t,this,e,s)}static widget(t,e,s){return new xt(t,t,new ps(e,s))}static inline(t,e,s,r){return new xt(t,e,new ne(s,r))}static node(t,e,s,r){return new xt(t,e,new wi(s,r))}get spec(){return this.type.spec}get inline(){return this.type instanceof ne}get widget(){return this.type instanceof ps}}const ze=[],xe={};class H{constructor(t,e){this.local=t.length?t:ze,this.children=e.length?e:ze}static create(t,e){return e.length?gs(e,t,0,xe):nt}find(t,e,s){let r=[];return this.findInner(t??0,e??1e9,r,0,s),r}findInner(t,e,s,r,i){for(let o=0;o<this.local.length;o++){let l=this.local[o];l.from<=e&&l.to>=t&&(!i||i(l.spec))&&s.push(l.copy(l.from+r,l.to+r))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<e&&this.children[o+1]>t){let l=this.children[o]+1;this.children[o+2].findInner(t-l,e-l,s,r+l,i)}}map(t,e,s){return this==nt||t.maps.length==0?this:this.mapInner(t,e,0,0,s||xe)}mapInner(t,e,s,r,i){let o;for(let l=0;l<this.local.length;l++){let c=this.local[l].map(t,s,r);c&&c.type.valid(e,c)?(o||(o=[])).push(c):i.onRemove&&i.onRemove(this.local[l].spec)}return this.children.length?jd(this.children,o||[],t,e,s,r,i):o?new H(o.sort(Ee),ze):nt}add(t,e){return e.length?this==nt?H.create(t,e):this.addInner(t,e,0):this}addInner(t,e,s){let r,i=0;t.forEach((l,c)=>{let a=c+s,h;if(h=vc(e,l,a)){for(r||(r=this.children.slice());i<r.length&&r[i]<c;)i+=3;r[i]==c?r[i+2]=r[i+2].addInner(l,h,a+1):r.splice(i,0,c,c+l.nodeSize,gs(h,l,a+1,xe)),i+=3}});let o=Ac(i?Oc(e):e,-s);for(let l=0;l<o.length;l++)o[l].type.valid(t,o[l])||o.splice(l--,1);return new H(o.length?this.local.concat(o).sort(Ee):this.local,r||this.children)}remove(t){return t.length==0||this==nt?this:this.removeInner(t,0)}removeInner(t,e){let s=this.children,r=this.local;for(let i=0;i<s.length;i+=3){let o,l=s[i]+e,c=s[i+1]+e;for(let h=0,u;h<t.length;h++)(u=t[h])&&u.from>l&&u.to<c&&(t[h]=null,(o||(o=[])).push(u));if(!o)continue;s==this.children&&(s=this.children.slice());let a=s[i+2].removeInner(o,l+1);a!=nt?s[i+2]=a:(s.splice(i,3),i-=3)}if(r.length){for(let i=0,o;i<t.length;i++)if(o=t[i])for(let l=0;l<r.length;l++)r[l].eq(o,e)&&(r==this.local&&(r=this.local.slice()),r.splice(l--,1))}return s==this.children&&r==this.local?this:r.length||s.length?new H(r,s):nt}forChild(t,e){if(this==nt)return this;if(e.isLeaf)return H.empty;let s,r;for(let l=0;l<this.children.length;l+=3)if(this.children[l]>=t){this.children[l]==t&&(s=this.children[l+2]);break}let i=t+1,o=i+e.content.size;for(let l=0;l<this.local.length;l++){let c=this.local[l];if(c.from<o&&c.to>i&&c.type instanceof ne){let a=Math.max(i,c.from)-i,h=Math.min(o,c.to)-i;a<h&&(r||(r=[])).push(c.copy(a,h))}}if(r){let l=new H(r.sort(Ee),ze);return s?new de([l,s]):l}return s||nt}eq(t){if(this==t)return!0;if(!(t instanceof H)||this.local.length!=t.local.length||this.children.length!=t.children.length)return!1;for(let e=0;e<this.local.length;e++)if(!this.local[e].eq(t.local[e]))return!1;for(let e=0;e<this.children.length;e+=3)if(this.children[e]!=t.children[e]||this.children[e+1]!=t.children[e+1]||!this.children[e+2].eq(t.children[e+2]))return!1;return!0}locals(t){return Si(this.localsInner(t))}localsInner(t){if(this==nt)return ze;if(t.inlineContent||!this.local.some(ne.is))return this.local;let e=[];for(let s=0;s<this.local.length;s++)this.local[s].type instanceof ne||e.push(this.local[s]);return e}forEachSet(t){t(this)}}H.empty=new H([],[]);H.removeOverlap=Si;const nt=H.empty;class de{constructor(t){this.members=t}map(t,e){const s=this.members.map(r=>r.map(t,e,xe));return de.from(s)}forChild(t,e){if(e.isLeaf)return H.empty;let s=[];for(let r=0;r<this.members.length;r++){let i=this.members[r].forChild(t,e);i!=nt&&(i instanceof de?s=s.concat(i.members):s.push(i))}return de.from(s)}eq(t){if(!(t instanceof de)||t.members.length!=this.members.length)return!1;for(let e=0;e<this.members.length;e++)if(!this.members[e].eq(t.members[e]))return!1;return!0}locals(t){let e,s=!0;for(let r=0;r<this.members.length;r++){let i=this.members[r].localsInner(t);if(i.length)if(!e)e=i;else{s&&(e=e.slice(),s=!1);for(let o=0;o<i.length;o++)e.push(i[o])}}return e?Si(s?e:e.sort(Ee)):ze}static from(t){switch(t.length){case 0:return nt;case 1:return t[0];default:return new de(t.every(e=>e instanceof H)?t:t.reduce((e,s)=>e.concat(s instanceof H?s:s.members),[]))}}forEachSet(t){for(let e=0;e<this.members.length;e++)this.members[e].forEachSet(t)}}function jd(n,t,e,s,r,i,o){let l=n.slice();for(let a=0,h=i;a<e.maps.length;a++){let u=0;e.maps[a].forEach((f,d,p,g)=>{let m=g-p-(d-f);for(let y=0;y<l.length;y+=3){let I=l[y+1];if(I<0||f>I+h-u)continue;let C=l[y]+h-u;d>=C?l[y+1]=f<=C?-2:-1:f>=h&&m&&(l[y]+=m,l[y+1]+=m)}u+=m}),h=e.maps[a].map(h,-1)}let c=!1;for(let a=0;a<l.length;a+=3)if(l[a+1]<0){if(l[a+1]==-2){c=!0,l[a+1]=-1;continue}let h=e.map(n[a]+i),u=h-r;if(u<0||u>=s.content.size){c=!0;continue}let f=e.map(n[a+1]+i,-1),d=f-r,{index:p,offset:g}=s.content.findIndex(u),m=s.maybeChild(p);if(m&&g==u&&g+m.nodeSize==d){let y=l[a+2].mapInner(e,m,h+1,n[a]+i+1,o);y!=nt?(l[a]=u,l[a+1]=d,l[a+2]=y):(l[a+1]=-2,c=!0)}else c=!0}if(c){let a=Gd(l,n,t,e,r,i,o),h=gs(a,s,0,o);t=h.local;for(let u=0;u<l.length;u+=3)l[u+1]<0&&(l.splice(u,3),u-=3);for(let u=0,f=0;u<h.children.length;u+=3){let d=h.children[u];for(;f<l.length&&l[f]<d;)f+=3;l.splice(f,0,h.children[u],h.children[u+1],h.children[u+2])}}return new H(t.sort(Ee),l)}function Ac(n,t){if(!t||!n.length)return n;let e=[];for(let s=0;s<n.length;s++){let r=n[s];e.push(new xt(r.from+t,r.to+t,r.type))}return e}function Gd(n,t,e,s,r,i,o){function l(c,a){for(let h=0;h<c.local.length;h++){let u=c.local[h].map(s,r,a);u?e.push(u):o.onRemove&&o.onRemove(c.local[h].spec)}for(let h=0;h<c.children.length;h+=3)l(c.children[h+2],c.children[h]+a+1)}for(let c=0;c<n.length;c+=3)n[c+1]==-1&&l(n[c+2],t[c]+i+1);return e}function vc(n,t,e){if(t.isLeaf)return null;let s=e+t.nodeSize,r=null;for(let i=0,o;i<n.length;i++)(o=n[i])&&o.from>e&&o.to<s&&((r||(r=[])).push(o),n[i]=null);return r}function Oc(n){let t=[];for(let e=0;e<n.length;e++)n[e]!=null&&t.push(n[e]);return t}function gs(n,t,e,s){let r=[],i=!1;t.forEach((l,c)=>{let a=vc(n,l,c+e);if(a){i=!0;let h=gs(a,l,e+c+1,s);h!=nt&&r.push(c,c+l.nodeSize,h)}});let o=Ac(i?Oc(n):n,-e).sort(Ee);for(let l=0;l<o.length;l++)o[l].type.valid(t,o[l])||(s.onRemove&&s.onRemove(o[l].spec),o.splice(l--,1));return o.length||r.length?new H(o,r):nt}function Ee(n,t){return n.from-t.from||n.to-t.to}function Si(n){let t=n;for(let e=0;e<t.length-1;e++){let s=t[e];if(s.from!=s.to)for(let r=e+1;r<t.length;r++){let i=t[r];if(i.from==s.from){i.to!=s.to&&(t==n&&(t=n.slice()),t[r]=i.copy(i.from,s.to),vo(t,r+1,i.copy(s.to,i.to)));continue}else{i.from<s.to&&(t==n&&(t=n.slice()),t[e]=s.copy(s.from,i.from),vo(t,r,s.copy(i.from,s.to)));break}}}return t}function vo(n,t,e){for(;t<n.length&&Ee(e,n[t])>0;)t++;n.splice(t,0,e)}const Xd=()=>{let n=!0;return(t,e)=>{if(n){n=!1;try{t()}finally{n=!0}}else e!==void 0&&e()}},Zd=/[\uD800-\uDBFF]/,Qd=/[\uDC00-\uDFFF]/,tp=(n,t)=>{let e=0,s=0;for(;e<n.length&&e<t.length&&n[e]===t[e];)e++;for(e>0&&Zd.test(n[e-1])&&e--;s+e<n.length&&s+e<t.length&&n[n.length-s-1]===t[t.length-s-1];)s++;return s>0&&Qd.test(n[n.length-s])&&s--,{index:e,remove:n.length-e-s,insert:t.slice(e,t.length-s)}},ep=tp,F=new fi("y-sync"),ts=new fi("y-undo"),Yn=new fi("yjs-cursor"),Ft=(n,t)=>n>>>t|n<<32-t,np=n=>Ft(n,2)^Ft(n,13)^Ft(n,22),sp=n=>Ft(n,6)^Ft(n,11)^Ft(n,25),rp=n=>Ft(n,7)^Ft(n,18)^n>>>3,ip=n=>Ft(n,17)^Ft(n,19)^n>>>10,op=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),lp=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);class cp{constructor(){const t=new ArrayBuffer(320);this._H=new Uint32Array(t,0,8),this._H.set(lp),this._W=new Uint32Array(t,64,64)}_updateHash(){const t=this._H,e=this._W;for(let u=16;u<64;u++)e[u]=ip(e[u-2])+e[u-7]+rp(e[u-15])+e[u-16];let s=t[0],r=t[1],i=t[2],o=t[3],l=t[4],c=t[5],a=t[6],h=t[7];for(let u=0,f,d;u<64;u++)f=h+sp(l)+(l&c^~l&a)+op[u]+e[u]>>>0,d=np(s)+(s&r^s&i^r&i)>>>0,h=a,a=c,c=l,l=o+f>>>0,o=i,i=r,r=s,s=f+d>>>0;t[0]+=s,t[1]+=r,t[2]+=i,t[3]+=o,t[4]+=l,t[5]+=c,t[6]+=a,t[7]+=h}digest(t){let e=0;for(;e+56<=t.length;){let o=0;for(;o<16&&e+3<t.length;o++)this._W[o]=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];if(e%64!==0){for(this._W.fill(0,o,16);e<t.length;)this._W[o]|=t[e]<<(3-e%4)*8,e++;this._W[o]|=it<<(3-e%4)*8}this._updateHash()}const s=e%64!==0;this._W.fill(0,0,16);let r=0;for(;e<t.length;r++)for(let o=3;o>=0&&e<t.length;o--)this._W[r]|=t[e++]<<o*8;s||(this._W[r-(e%4===0?0:1)]|=it<<(3-e%4)*8),this._W[14]=t.byteLength/ja,this._W[15]=t.byteLength*8,this._updateHash();const i=new Uint8Array(32);for(let o=0;o<this._H.length;o++)for(let l=0;l<4;l++)i[o*4+l]=this._H[o]>>>(3-l)*8;return i}}const ap=n=>new cp().digest(n),hp=n=>{for(let e=6;e<n.length;e++)n[e%6]=n[e%6]^n[e];return n.slice(0,6)},up=n=>$o(hp(ap(Zh(n)))),ms=(n,t)=>t===void 0?!n.deleted:t.sv.has(n.id.client)&&t.sv.get(n.id.client)>n.id.clock&&!Xe(t.ds,n.id),fp=[{light:"#ecd44433",dark:"#ecd444"}],dp=(n,t,e)=>{if(!n.has(e)){if(n.size<t.length){const s=Yt();n.forEach(r=>s.add(r)),t=t.filter(r=>!s.has(r))}n.set(e,Th(t))}return n.get(e)},pp=(n,{colors:t=fp,colorMapping:e=new Map,permanentUserData:s=null,onFirstRender:r=()=>{},mapping:i}={})=>{let o=!1;const l=new mp(n,i),c=new ui({props:{editable:a=>{const h=F.getState(a);return h.snapshot==null&&h.prevSnapshot==null}},key:F,state:{init:(a,h)=>({type:n,doc:n.doc,binding:l,snapshot:null,prevSnapshot:null,isChangeOrigin:!1,isUndoRedoOperation:!1,addToHistory:!0,colors:t,colorMapping:e,permanentUserData:s}),apply:(a,h)=>{const u=a.getMeta(F);if(u!==void 0){h=Object.assign({},h);for(const f in u)h[f]=u[f]}return h.addToHistory=a.getMeta("addToHistory")!==!1,h.isChangeOrigin=u!==void 0&&!!u.isChangeOrigin,h.isUndoRedoOperation=u!==void 0&&!!u.isChangeOrigin&&!!u.isUndoRedoOperation,l.prosemirrorView!==null&&u!==void 0&&(u.snapshot!=null||u.prevSnapshot!=null)&&qr(0,()=>{l.prosemirrorView!=null&&(u.restore==null?l._renderSnapshot(u.snapshot,u.prevSnapshot,h):(l._renderSnapshot(u.snapshot,u.snapshot,h),delete h.restore,delete h.snapshot,delete h.prevSnapshot,l.mux(()=>{l._prosemirrorChanged(l.prosemirrorView.state.doc)})))}),h}},view:a=>(l.initView(a),i==null&&l._forceRerender(),r(),{update:()=>{const h=c.getState(a.state);if(h.snapshot==null&&h.prevSnapshot==null&&(o||a.state.doc.content.findDiffStart(a.state.doc.type.createAndFill().content)!==null)){if(o=!0,h.addToHistory===!1&&!h.isChangeOrigin){const u=ts.getState(a.state),f=u&&u.undoManager;f&&f.stopCapturing()}l.mux(()=>{h.doc.transact(u=>{u.meta.set("addToHistory",h.addToHistory),l._prosemirrorChanged(a.state.doc)},F)})}},destroy:()=>{l.destroy()}})});return c},gp=(n,t,e)=>{if(t!==null&&t.anchor!==null&&t.head!==null)if(t.type==="all")n.setSelection(new Dt(n.doc));else if(t.type==="node"){const s=qe(e.doc,e.type,t.anchor,e.mapping);n.setSelection(T.create(n.doc,s))}else{const s=qe(e.doc,e.type,t.anchor,e.mapping),r=qe(e.doc,e.type,t.head,e.mapping);if(s!==null&&r!==null){const i=L.between(n.doc.resolve(s),n.doc.resolve(r));n.setSelection(i)}}},Ar=(n,t)=>({type:t.selection.jsonID,anchor:bs(t.selection.anchor,n.type,n.mapping),head:bs(t.selection.head,n.type,n.mapping)});class mp{constructor(t,e=new Map){this.type=t,this.prosemirrorView=null,this.mux=Xd(),this.mapping=e,this.isOMark=new Map,this._observeFunction=this._typeChanged.bind(this),this.doc=t.doc,this.beforeTransactionSelection=null,this.beforeAllTransactions=()=>{this.beforeTransactionSelection===null&&this.prosemirrorView!=null&&(this.beforeTransactionSelection=Ar(this,this.prosemirrorView.state))},this.afterAllTransactions=()=>{this.beforeTransactionSelection=null},this._domSelectionInView=null}get _tr(){return this.prosemirrorView.state.tr.setMeta("addToHistory",!1)}_isLocalCursorInView(){return this.prosemirrorView.hasFocus()?(Hr&&this._domSelectionInView===null&&(qr(0,()=>{this._domSelectionInView=null}),this._domSelectionInView=this._isDomSelectionInView()),this._domSelectionInView):!1}_isDomSelectionInView(){const t=this.prosemirrorView._root.getSelection();if(t==null||t.anchorNode==null)return!1;const e=this.prosemirrorView._root.createRange();e.setStart(t.anchorNode,t.anchorOffset),e.setEnd(t.focusNode,t.focusOffset),e.getClientRects().length===0&&e.startContainer&&e.collapsed&&e.selectNodeContents(e.startContainer);const r=e.getBoundingClientRect(),i=tu.documentElement;return r.bottom>=0&&r.right>=0&&r.left<=(window.innerWidth||i.clientWidth||0)&&r.top<=(window.innerHeight||i.clientHeight||0)}renderSnapshot(t,e){e||(e=fl(nl(),new Map)),this.prosemirrorView.dispatch(this._tr.setMeta(F,{snapshot:t,prevSnapshot:e}))}unrenderSnapshot(){this.mapping.clear(),this.mux(()=>{const t=this.type.toArray().map(s=>es(s,this.prosemirrorView.state.schema,this)).filter(s=>s!==null),e=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new x(_.from(t),0,0));e.setMeta(F,{snapshot:null,prevSnapshot:null}),this.prosemirrorView.dispatch(e)})}_forceRerender(){this.mapping.clear(),this.mux(()=>{const t=this.beforeTransactionSelection!==null?null:this.prosemirrorView.state.selection,e=this.type.toArray().map(r=>es(r,this.prosemirrorView.state.schema,this)).filter(r=>r!==null),s=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new x(_.from(e),0,0));if(t){const r=Lt(Tt(t.anchor,0),s.doc.content.size),i=Lt(Tt(t.head,0),s.doc.content.size);s.setSelection(L.create(s.doc,r,i))}this.prosemirrorView.dispatch(s.setMeta(F,{isChangeOrigin:!0,binding:this}))})}_renderSnapshot(t,e,s){let r=this.doc,i=this.type;if(t||(t=Hs(this.doc)),t instanceof Uint8Array||e instanceof Uint8Array)if((!(t instanceof Uint8Array)||!(e instanceof Uint8Array))&&dt(),r=new ae({gc:!1}),ss(r,e),e=Hs(r),ss(r,t),t=Hs(r),i._item===null){const o=Array.from(this.doc.share.keys()).find(l=>this.doc.share.get(l)===this.type);i=r.getXmlFragment(o)}else{const o=r.store.clients.get(i._item.id.client)??[],l=At(o,i._item.id.clock);i=o[l].content.type}this.mapping.clear(),this.mux(()=>{r.transact(o=>{const l=s.permanentUserData;l&&l.dss.forEach(u=>{oe(o,u,f=>{})});const c=(u,f)=>{const d=u==="added"?l.getUserByClientId(f.client):l.getUserByDeletedId(f);return{user:d,type:u,color:dp(s.colorMapping,s.colors,d)}},a=_l(i,new Xr(e.ds,t.sv)).map(u=>!u._item.deleted||ms(u._item,t)||ms(u._item,e)?es(u,this.prosemirrorView.state.schema,{mapping:new Map,isOMark:new Map},t,e,c):null).filter(u=>u!==null),h=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new x(_.from(a),0,0));this.prosemirrorView.dispatch(h.setMeta(F,{isChangeOrigin:!0}))},F)})}_typeChanged(t,e){if(this.prosemirrorView==null)return;const s=F.getState(this.prosemirrorView.state);if(t.length===0||s.snapshot!=null||s.prevSnapshot!=null){this.renderSnapshot(s.snapshot,s.prevSnapshot);return}this.mux(()=>{const r=(l,c)=>this.mapping.delete(c);oe(e,e.deleteSet,l=>{if(l.constructor===O){const c=l.content.type;c&&this.mapping.delete(c)}}),e.changed.forEach(r),e.changedParentTypes.forEach(r);const i=this.type.toArray().map(l=>Ic(l,this.prosemirrorView.state.schema,this)).filter(l=>l!==null);let o=this._tr.replace(0,this.prosemirrorView.state.doc.content.size,new x(_.from(i),0,0));gp(o,this.beforeTransactionSelection,this),o=o.setMeta(F,{isChangeOrigin:!0,isUndoRedoOperation:e.origin instanceof yl}),this.beforeTransactionSelection!==null&&this._isLocalCursorInView()&&o.scrollIntoView(),this.prosemirrorView.dispatch(o)})}_prosemirrorChanged(t){this.doc.transact(()=>{Or(this.doc,this.type,t,this),this.beforeTransactionSelection=Ar(this,this.prosemirrorView.state)},F)}initView(t){this.prosemirrorView!=null&&this.destroy(),this.prosemirrorView=t,this.doc.on("beforeAllTransactions",this.beforeAllTransactions),this.doc.on("afterAllTransactions",this.afterAllTransactions),this.type.observeDeep(this._observeFunction)}destroy(){this.prosemirrorView!=null&&(this.prosemirrorView=null,this.type.unobserveDeep(this._observeFunction),this.doc.off("beforeAllTransactions",this.beforeAllTransactions),this.doc.off("afterAllTransactions",this.afterAllTransactions))}}const Ic=(n,t,e,s,r,i)=>{const o=e.mapping.get(n);if(o===void 0){if(n instanceof st)return es(n,t,e,s,r,i);throw Et()}return o},es=(n,t,e,s,r,i)=>{const o=[],l=c=>{if(c instanceof st){const a=Ic(c,t,e,s,r,i);a!==null&&o.push(a)}else{const a=c._item.right?.content?.type;a instanceof le&&!a._item.deleted&&a._item.id.client===a.doc.clientID&&(c.applyDelta([{retain:c.length},...a.toDelta()]),a.doc.transact(u=>{a._item.delete(u)}));const h=yp(c,t,e,s,r,i);h!==null&&h.forEach(u=>{u!==null&&o.push(u)})}};s===void 0||r===void 0?n.toArray().forEach(l):_l(n,new Xr(r.ds,s.sv)).forEach(l);try{const c=n.getAttributes(s);s!==void 0&&(ms(n._item,s)?ms(n._item,r)||(c.ychange=i?i("added",n._item.id):{type:"added"}):c.ychange=i?i("removed",n._item.id):{type:"removed"});const a=t.node(n.nodeName,c,o);return e.mapping.set(n,a),a}catch{return n.doc.transact(a=>{n._item.delete(a)},F),e.mapping.delete(n),null}},yp=(n,t,e,s,r,i)=>{const o=[],l=n.toDelta(s,r,i);try{for(let c=0;c<l.length;c++){const a=l[c];o.push(t.text(a.insert,_p(a.attributes,t)))}}catch{return n.doc.transact(a=>{n._item.delete(a)},F),null}return o},bp=(n,t)=>{const e=new ft,s=n.map(r=>({insert:r.text,attributes:Rc(r.marks,t)}));return e.applyDelta(s),t.mapping.set(e,n),e},wp=(n,t)=>{const e=new st(n.type.name);for(const s in n.attrs){const r=n.attrs[s];r!==null&&s!=="ychange"&&e.setAttribute(s,r)}return e.insert(0,vs(n).map(s=>vr(s,t))),t.mapping.set(e,n),e},vr=(n,t)=>n instanceof Array?bp(n,t):wp(n,t),Oo=n=>typeof n=="object"&&n!==null,ki=(n,t)=>{const e=Object.keys(n).filter(r=>n[r]!==null);let s=e.length===(t==null?0:Object.keys(t).filter(r=>t[r]!==null).length);for(let r=0;r<e.length&&s;r++){const i=e[r],o=n[i],l=t[i];s=i==="ychange"||o===l||Oo(o)&&Oo(l)&&ki(o,l)}return s},vs=n=>{const t=n.content.content,e=[];for(let s=0;s<t.length;s++){const r=t[s];if(r.isText){const i=[];for(let o=t[s];s<t.length&&o.isText;o=t[++s])i.push(o);s--,e.push(i)}else e.push(r)}return e},Mc=(n,t)=>{const e=n.toDelta();return e.length===t.length&&e.every((s,r)=>s.insert===t[r].text&&Wr(s.attributes||{}).length===t[r].marks.length&&Wo(s.attributes,(i,o)=>{const l=Nc(o),c=t[r].marks;return ki(i,c.find(a=>a.type.name===l)?.attrs)}))},vn=(n,t)=>{if(n instanceof st&&!(t instanceof Array)&&Ir(n,t)){const e=vs(t);return n._length===e.length&&ki(n.getAttributes(),t.attrs)&&n.toArray().every((s,r)=>vn(s,e[r]))}return n instanceof ft&&t instanceof Array&&Mc(n,t)},ys=(n,t)=>n===t||n instanceof Array&&t instanceof Array&&n.length===t.length&&n.every((e,s)=>t[s]===e),Io=(n,t,e)=>{const s=n.toArray(),r=vs(t),i=r.length,o=s.length,l=Lt(o,i);let c=0,a=0,h=!1;for(;c<l;c++){const u=s[c],f=r[c];if(ys(e.mapping.get(u),f))h=!0;else if(!vn(u,f))break}for(;c+a<l;a++){const u=s[o-a-1],f=r[i-a-1];if(ys(e.mapping.get(u),f))h=!0;else if(!vn(u,f))break}return{equalityFactor:c+a,foundMappedChild:h}},Sp=n=>{let t="",e=n._start;const s={};for(;e!==null;)e.deleted||(e.countable&&e.content instanceof vt?t+=e.content.str:e.content instanceof W&&(s[e.content.key]=null)),e=e.right;return{str:t,nAttrs:s}},kp=(n,t,e)=>{e.mapping.set(n,t);const{nAttrs:s,str:r}=Sp(n),i=t.map(a=>({insert:a.text,attributes:Object.assign({},s,Rc(a.marks,e))})),{insert:o,remove:l,index:c}=ep(r,i.map(a=>a.insert).join(""));n.delete(c,l),n.insert(c,o),n.applyDelta(i.map(a=>({retain:a.insert.length,attributes:a.attributes})))},Cp=/(.*)(--[a-zA-Z0-9+/=]{8})$/,Nc=n=>Cp.exec(n)?.[1]??n,_p=(n,t)=>{const e=[];for(const s in n)e.push(t.mark(Nc(s),n[s]));return e},Rc=(n,t)=>{const e={};return n.forEach(s=>{if(s.type.name!=="ychange"){const r=_t(t.isOMark,s.type,()=>!s.type.excludes(s.type));e[r?`${s.type.name}--${up(s.toJSON())}`:s.type.name]=s.attrs}}),e},Or=(n,t,e,s)=>{if(t instanceof st&&t.nodeName!==e.type.name)throw new Error("node name mismatch!");if(s.mapping.set(t,e),t instanceof st){const u=t.getAttributes(),f=e.attrs;for(const d in f)f[d]!==null?u[d]!==f[d]&&d!=="ychange"&&t.setAttribute(d,f[d]):t.removeAttribute(d);for(const d in u)f[d]===void 0&&t.removeAttribute(d)}const r=vs(e),i=r.length,o=t.toArray(),l=o.length,c=Lt(i,l);let a=0,h=0;for(;a<c;a++){const u=o[a],f=r[a];if(!ys(s.mapping.get(u),f))if(vn(u,f))s.mapping.set(u,f);else break}for(;h+a<c;h++){const u=o[l-h-1],f=r[i-h-1];if(!ys(s.mapping.get(u),f))if(vn(u,f))s.mapping.set(u,f);else break}n.transact(()=>{for(;l-a-h>0&&i-a-h>0;){const f=o[a],d=r[a],p=o[l-h-1],g=r[i-h-1];if(f instanceof ft&&d instanceof Array)Mc(f,d)||kp(f,d,s),a+=1;else{let m=f instanceof st&&Ir(f,d),y=p instanceof st&&Ir(p,g);if(m&&y){const I=Io(f,d,s),C=Io(p,g,s);I.foundMappedChild&&!C.foundMappedChild?y=!1:!I.foundMappedChild&&C.foundMappedChild||I.equalityFactor<C.equalityFactor?m=!1:y=!1}m?(Or(n,f,d,s),a+=1):y?(Or(n,p,g,s),h+=1):(s.mapping.delete(t.get(a)),t.delete(a,1),t.insert(a,[vr(d,s)]),a+=1)}}const u=l-a-h;if(l===1&&i===0&&o[0]instanceof ft?(s.mapping.delete(o[0]),o[0].delete(0,o[0].length)):u>0&&(t.slice(a,a+u).forEach(f=>s.mapping.delete(f)),t.delete(a,u)),a+h<i){const f=[];for(let d=a;d<i-h;d++)f.push(vr(r[d],s));t.insert(a,f)}},F)},Ir=(n,t)=>!(t instanceof Array)&&n.nodeName===t.type.name;let dn=null;const xp=()=>{const n=dn;dn=null,n.forEach((t,e)=>{const s=e.state.tr,r=F.getState(e.state);r&&r.binding&&!r.binding.isDestroyed&&(t.forEach((i,o)=>{s.setMeta(o,i)}),e.dispatch(s))})},Ep=(n,t,e)=>{dn||(dn=new Map,qr(0,xp)),_t(dn,n,rt).set(t,e)},bs=(n,t,e)=>{if(n===0)return Js(t,0,t.length===0?-1:0);let s=t._first===null?null:t._first.content.type;for(;s!==null&&t!==s;){if(s instanceof ft){if(s._length>=n)return Js(s,n,t.length===0?-1:0);if(n-=s._length,s._item!==null&&s._item.next!==null)s=s._item.next.content.type;else{do s=s._item===null?null:s._item.parent,n--;while(s!==t&&s!==null&&s._item!==null&&s._item.next===null);s!==null&&s!==t&&(s=s._item===null?null:s._item.next.content.type)}}else{const r=(e.get(s)||{nodeSize:0}).nodeSize;if(s._first!==null&&n<r)s=s._first.content.type,n--;else{if(n===1&&s._length===0&&r>1)return new Sn(s._item===null?null:s._item.id,s._item===null?bn(s):null,null);if(n-=r,s._item!==null&&s._item.next!==null)s=s._item.next.content.type;else{if(n===0)return s=s._item===null?s:s._item.parent,new Sn(s._item===null?null:s._item.id,s._item===null?bn(s):null,null);do s=s._item.parent,n--;while(s!==t&&s._item.next===null);s!==t&&(s=s._item.next.content.type)}}}if(s===null)throw dt();if(n===0&&s.constructor!==ft&&s!==t)return Dp(s._item.parent,s._item)}return Js(t,t._length,t.length===0?-1:0)},Dp=(n,t)=>{let e=null,s=null;return n._item===null?s=bn(n):e=k(n._item.id.client,n._item.id.clock),new Sn(e,s,t.id)},qe=(n,t,e,s)=>{const r=Nu(e,n);if(r===null||r.type!==t&&!wn(t,r.type._item))return null;let i=r.type,o=0;if(i.constructor===ft)o=r.index;else if(i._item===null||!i._item.deleted){let l=i._first,c=0;for(;c<i._length&&c<r.index&&l!==null;){if(!l.deleted){const a=l.content.type;c++,a instanceof ft?o+=a._length:o+=s.get(a).nodeSize}l=l.right}o+=1}for(;i!==t&&i._item!==null;){const l=i._item.parent;if(l._item===null||!l._item.deleted){o+=1;let c=l._first;for(;c!==null;){const a=c.content.type;if(a===i)break;c.deleted||(a instanceof ft?o+=a._length:o+=s.get(a).nodeSize),c=c.right}}i=l}return o-1},Tp=(n,t,e)=>n!==t,Ap=n=>{const t=document.createElement("span");t.classList.add("ProseMirror-yjs-cursor"),t.setAttribute("style",`border-color: ${n.color}`);const e=document.createElement("div");e.setAttribute("style",`background-color: ${n.color}`),e.insertBefore(document.createTextNode(n.name),null);const s=document.createTextNode("⁠"),r=document.createTextNode("⁠");return t.insertBefore(s,null),t.insertBefore(e,null),t.insertBefore(r,null),t},vp=n=>({style:`background-color: ${n.color}70`,class:"ProseMirror-yjs-selection"}),Op=/^#[0-9a-fA-F]{6}$/,Mo=(n,t,e,s,r)=>{const i=F.getState(n),o=i.doc,l=[];return i.snapshot!=null||i.prevSnapshot!=null||i.binding.mapping.size===0?H.create(n.doc,[]):(t.getStates().forEach((c,a)=>{if(e(o.clientID,a,c)&&c.cursor!=null){const h=c.user||{};h.color==null?h.color="#ffa500":Op.test(h.color)||console.warn("A user uses an unsupported color format",h),h.name==null&&(h.name=`User: ${a}`);let u=qe(o,i.type,cn(c.cursor.anchor),i.binding.mapping),f=qe(o,i.type,cn(c.cursor.head),i.binding.mapping);if(u!==null&&f!==null){const d=Tt(n.doc.content.size-1,0);u=Lt(u,d),f=Lt(f,d),l.push(xt.widget(f,()=>s(h,a),{key:a+"",side:10}));const p=Lt(u,f),g=Tt(u,f);l.push(xt.inline(p,g,r(h,a),{inclusiveEnd:!0,inclusiveStart:!1}))}}}),H.create(n.doc,l))},Ip=(n,{awarenessStateFilter:t=Tp,cursorBuilder:e=Ap,selectionBuilder:s=vp,getSelection:r=o=>o.selection}={},i="cursor")=>new ui({key:Yn,state:{init(o,l){return Mo(l,n,t,e,s)},apply(o,l,c,a){const h=F.getState(a),u=o.getMeta(Yn);return h&&h.isChangeOrigin||u&&u.awarenessUpdated?Mo(a,n,t,e,s):l.map(o.mapping,o.doc)}},props:{decorations:o=>Yn.getState(o)},view:o=>{const l=()=>{o.docView&&Ep(o,Yn,{awarenessUpdated:!0})},c=()=>{const a=F.getState(o.state),h=n.getLocalState()||{};if(o.hasFocus()){const u=r(o.state),f=bs(u.anchor,a.type,a.binding.mapping),d=bs(u.head,a.type,a.binding.mapping);(h.cursor==null||!qi(cn(h.cursor.anchor),f)||!qi(cn(h.cursor.head),d))&&n.setLocalStateField(i,{anchor:f,head:d})}else h.cursor!=null&&qe(a.doc,a.type,cn(h.cursor.anchor),a.binding.mapping)!==null&&n.setLocalStateField(i,null)};return n.on("change",l),o.dom.addEventListener("focusin",c),o.dom.addEventListener("focusout",c),{update:c,destroy:()=>{o.dom.removeEventListener("focusin",c),o.dom.removeEventListener("focusout",c),n.off("change",l),n.setLocalStateField(i,null)}}}}),Mp=new Set(["paragraph"]),Np=(n,t)=>!(n instanceof O)||!(n.content instanceof Ot)||!(n.content.type instanceof le||n.content.type instanceof st&&t.has(n.content.type.nodeName))||n.content.type._length===0,Rp=({protectedNodes:n=Mp,trackedOrigins:t=[],undoManager:e=null}={})=>new ui({key:ts,state:{init:(s,r)=>{const i=F.getState(r),o=e||new yl(i.type,{trackedOrigins:new Set([F].concat(t)),deleteFilter:l=>Np(l,n),captureTransaction:l=>l.meta.get("addToHistory")!==!1});return{undoManager:o,prevSel:null,hasUndoOps:o.undoStack.length>0,hasRedoOps:o.redoStack.length>0}},apply:(s,r,i,o)=>{const l=F.getState(o).binding,c=r.undoManager,a=c.undoStack.length>0,h=c.redoStack.length>0;return l?{undoManager:c,prevSel:Ar(l,i),hasUndoOps:a,hasRedoOps:h}:a!==r.hasUndoOps||h!==r.hasRedoOps?Object.assign({},r,{hasUndoOps:c.undoStack.length>0,hasRedoOps:c.redoStack.length>0}):r}},view:s=>{const r=F.getState(s.state),i=ts.getState(s.state).undoManager;return i.on("stack-item-added",({stackItem:o})=>{const l=r.binding;l&&o.meta.set(l,ts.getState(s.state).prevSel)}),i.on("stack-item-popped",({stackItem:o})=>{const l=r.binding;l&&(l.beforeTransactionSelection=o.meta.get(l)||l.beforeTransactionSelection)}),{destroy:()=>{i.destroy()}}}});class Lp{constructor(){this.provider=null,this.sessionInfo=null,this.wordApprovalsMap=null,this.sessionMetadataMap=null,this.ydoc=new ae}initializeProvider(t,e){this.sessionInfo=t,this.onParticipantsChange=e?.onParticipantsChange,this.onConnectionStatusChange=e?.onConnectionStatusChange,console.log("[CollaborationManager] Connecting to:",t.serverUrl,"room:",t.roomName),this.provider=new Gf(t.serverUrl,t.roomName,this.ydoc,{connect:!0,maxBackoffTime:5e3,disableBc:!0}),this.wordApprovalsMap=this.ydoc.getMap("wordApprovals"),this.sessionMetadataMap=this.ydoc.getMap("sessionMetadata"),t.role==="host"&&this.sessionMetadataMap.set("hostClientId",this.provider.awareness.clientID),this.provider.awareness.on("change",()=>{this.handleAwarenessChange()}),this.provider.on("status",({status:s})=>{const r=s==="connected";console.log("[CollaborationManager] Connection status:",s),this.onConnectionStatusChange?.(r)}),this.provider.on("connection-error",s=>{console.error("[CollaborationManager] Connection error:",s)}),this.provider.awareness.setLocalStateField("user",{name:t.role==="host"?"Host":"Guest",color:this.getRandomColor(),role:t.role}),console.log("[CollaborationManager] Provider initialized for session:",t.code)}connect(t,e,s){this.provider||this.initializeProvider(t,s),console.log("[CollaborationManager] Connected to session:",t.code)}disconnect(){this.provider&&(this.provider.disconnect(),this.provider.destroy(),this.provider=null),this.sessionInfo=null,console.log("[CollaborationManager] Disconnected from session")}getProseMirrorPlugins(t){if(!this.provider)throw new Error("Provider not initialized. Call connect() first.");const e=this.ydoc.getXmlFragment("prosemirror"),s=t?.includeCursor??!0;return[pp(e),...s?[Ip(this.provider.awareness)]:[],Rp()]}approveWord(t){if(!this.wordApprovalsMap||!this.provider)return!1;const e=this.wordApprovalsMap.get(t);return e?.approved?(console.log("[CollaborationManager] Word already approved by",e.approvedBy),!1):(this.wordApprovalsMap.set(t,{approved:!0,approvedBy:String(this.provider.awareness.clientID),timestamp:Date.now()}),!0)}isWordApproved(t){return this.wordApprovalsMap?.get(t)?.approved??!1}getParticipants(){if(!this.provider)return[];const t=[];return this.provider.awareness.getStates().forEach((e,s)=>{e.user&&t.push({clientId:s,name:e.user.name,color:e.user.color,role:e.user.role})}),t}isHost(){return this.sessionInfo?.role==="host"}getSessionMetadata(){return this.sessionMetadataMap?{hostClientId:this.sessionMetadataMap.get("hostClientId")??0}:null}handleAwarenessChange(){const t=this.getParticipants();this.onParticipantsChange?.(t),console.log("[CollaborationManager] Participants:",t.length)}getRandomColor(){const t=["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F7DC6F","#BB8FCE","#85C1E2"];return t[Math.floor(Math.random()*t.length)]}destroy(){this.disconnect(),this.ydoc.destroy()}}function Fp(n){return n.trim().toUpperCase()}class zp{#t=null;#o;#l;#s=bt(!0);#r=bt(!1);#i=!1;#n=null;#e=!0;constructor(t={}){this.#o=t.threshold??50,this.#l=t.buttonThreshold??200,t.enabled!==void 0&&z(this.#s,t.enabled,!0)}get isScrolledUp(){return b(this.#r)}get enabled(){return b(this.#s)}set enabled(t){z(this.#s,t,!0),t&&this.#e&&this.scrollToBottom()}action=t=>(this.#t=t,t.addEventListener("scroll",this.#c,{passive:!0}),this.#e=!0,{destroy:()=>{t.removeEventListener("scroll",this.#c),this.#n&&clearTimeout(this.#n),this.#t=null}});update(){!b(this.#s)||!this.#t||!this.#i&&this.#e&&this.scrollToBottom()}scrollToBottom=()=>{this.#t&&(this.#t.scrollTo({top:this.#t.scrollHeight,behavior:"smooth"}),this.#e=!0,z(this.#r,!1))};#a(t){const{scrollTop:e,scrollHeight:s,clientHeight:r}=t;return s-e-r<this.#o}#h(t){const{scrollTop:e,scrollHeight:s,clientHeight:r}=t;return s-e-r>this.#l}#c=()=>{this.#t&&(this.#n&&clearTimeout(this.#n),this.#i=!0,this.#a(this.#t)?this.#e=!0:this.#e=!1,z(this.#r,this.#h(this.#t),!0),this.#n=setTimeout(()=>{this.#i=!1},150))}}var Up=gt('<button type="button" class="gear-button" aria-label="Open settings"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"></path></svg></button>'),Vp=gt('<div class="app-root"><!> <!> <!> <div class="subtitle-stage" role="main"><!> <!></div></div>');function jp(n,t){Mr(t,!0);const e=()=>ba(Ta,"$page",s),[s,r]=ya(),i=we(()=>Fp(e().params.code||""));let o=bt(Ei(Ti)),l=bt(!1),c=bt(""),a=bt(null),h=bt("connecting"),u=bt(null),f=bt(null),d=bt(null),p=bt(Ei([])),g=!0;const m=new zp({enabled:!0});Ls(()=>{m.enabled=g}),Ls(()=>{b(c),ha().then(()=>m.update())});const y=we(()=>`background-color: ${b(o).backgroundColor};`),I=we(()=>`padding-bottom: ${b(o).viewMode==="text"?"2rem":b(o).verticalPosition+"vh"}; transform: translateX(${b(o).horizontalPosition}%);`);function C(){if(!b(f))return"";try{return b(f).ydoc.getXmlFragment("prosemirror").toString().replace(/<\/paragraph>/g,`
`).replace(/<[^>]*>/g,"").replace(/ +/g," ").replace(/\n /g,`
`).replace(/ \n/g,`
`).trim()}catch(A){return console.error("[WEB-VIEWER] Error extracting text from Yjs:",A),""}}ua(async()=>{try{z(d,{code:b(i),role:"guest",roomName:b(i),serverUrl:"wss://tekstiks.ee/kk"},!0),console.log("[WEB-VIEWER] Setting up collaboration for session:",b(i)),z(f,new Lp,!0),b(f).connect(b(d),null,{onParticipantsChange:q=>{z(p,q,!0),console.log("[WEB-VIEWER] Participants changed:",q)},onConnectionStatusChange:q=>{z(h,q?"connected":"disconnected",!0),console.log("[WEB-VIEWER] Connection status:",q)}}),b(f).ydoc.on("update",(q,en)=>{console.log("[WEB-VIEWER] Yjs update event fired",{updateSize:q.length,origin:en});const Ne=C();console.log("[WEB-VIEWER] Extracted text from update:",Ne.substring(0,100)),Ne!==b(c)&&(z(c,Ne,!0),z(a,Date.now(),!0),console.log("[WEB-VIEWER] Text state updated:",b(c).substring(0,100)))});let yt=0;const tn=setInterval(()=>{yt++,console.log("[WEB-VIEWER] Attempting initial text extraction, attempt:",yt);const q=C();console.log("[WEB-VIEWER] Extracted:",q.substring(0,100)),q?(z(c,q,!0),z(a,Date.now(),!0),clearInterval(tn),console.log("[WEB-VIEWER] Initial text extraction successful")):yt>=10&&(clearInterval(tn),console.log("[WEB-VIEWER] Gave up on initial text extraction after 10 attempts"))},500)}catch(A){console.error("[WEB-VIEWER] Failed to setup collaboration:",A),z(u,"Failed to setup collaboration: "+A.message),z(h,"error")}}),fa(()=>{b(f)&&b(f).disconnect()}),Ls(()=>{if(!b(l))return;const A=yt=>{yt.key==="Escape"&&z(l,!1)};return window.addEventListener("keydown",A),()=>window.removeEventListener("keydown",A)});function J(A){z(o,A,!0)}function ot(){z(o,Ti,!0)}function j(){b(f)&&(b(f).disconnect(),setTimeout(()=>{b(d)&&b(f)?.connect(b(d),null,{onParticipantsChange:A=>{z(p,A,!0)},onConnectionStatusChange:A=>{z(h,A?"connected":"disconnected",!0)}})},100))}var tt=Vp();ma("11apzvo",A=>{da(()=>{pa.title=`Session ${b(i)??""} - Kirikaja`})});var mt=D(tt);{var G=A=>{var yt=Up();yt.__click=()=>z(l,!0),ct(A,yt)};Se(mt,A=>{b(l)||A(G)})}var Vt=v(mt,2);Ua(Vt,{get state(){return b(h)}});var Pt=v(Vt,2);Fa(Pt,{get open(){return b(l)},get settings(){return b(o)},onClose:()=>z(l,!1),onChange:J,onReset:ot});var Bt=v(Pt,2),Me=D(Bt);Ia(Me,{get text(){return b(c)},get settings(){return b(o)},get lastUpdated(){return b(a)},variant:"fullscreen",autoscrollEnabled:g});var Gt=v(Me,2);{var Un=A=>{Wa(A,{get state(){return b(h)},onReconnect:j,get errorMessage(){return b(u)}})};Se(Gt,A=>{b(h)!=="connected"&&A(Un)})}E(Bt),_a(Bt,A=>m.action?.(A)),E(tt),qt(()=>{ht(tt,"data-mode",b(o).viewMode),ke(tt,b(y)),ke(Bt,b(I))}),ct(n,tt),Nr(),r()}Rr(["click"]);export{jp as component};
